<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="在新版的Istio当中，官方已经不推荐用Helm的方式安装了（同时不支持Helm3），推荐用istioctl命令行的方式安装。所以这里记录istioctl的方式安装Istio。环境说明 Amazon Linux 2 AMI，本身是基于CentOS 7 Kubernetes 1.16.4 Istio 1.4.2 安装Istio 1.4.2下载 istio 1.4.2$ wget -c &quot;https:">
<meta name="keywords" content="istio,servicemesh,kubernetes">
<meta property="og:type" content="article">
<meta property="og:title" content="[服务网格Istio系列]--使用istioctl安装istio 1.4.2">
<meta property="og:url" content="https:&#x2F;&#x2F;knner.wang&#x2F;2020&#x2F;01&#x2F;07&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html">
<meta property="og:site_name" content="Knner.Wang&#39;s Blog">
<meta property="og:description" content="在新版的Istio当中，官方已经不推荐用Helm的方式安装了（同时不支持Helm3），推荐用istioctl命令行的方式安装。所以这里记录istioctl的方式安装Istio。环境说明 Amazon Linux 2 AMI，本身是基于CentOS 7 Kubernetes 1.16.4 Istio 1.4.2 安装Istio 1.4.2下载 istio 1.4.2$ wget -c &quot;https:">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;istio-release-dir.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;weather-forecast-example.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;frontend-dashboard-err.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;frontend-dashboard-ok.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;search-weather.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;kiali-weather.png">
<meta property="og:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;knner&#x2F;wx.jpg">
<meta property="og:updated_time" content="2020-01-06T16:00:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;knner.wang&#x2F;images&#x2F;ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl&#x2F;istio-release-dir.png">

<link rel="canonical" href="https://knner.wang/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>[服务网格Istio系列]--使用istioctl安装istio 1.4.2 | Knner.Wang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Knner.Wang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">25</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://knner.wang/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Knner.Wang">
      <meta itemprop="description" content="Knner.Wang's Blog,for sharing IT technology and also my study notes.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Knner.Wang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [服务网格Istio系列]--使用istioctl安装istio 1.4.2
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-07 00:00:00" itemprop="dateCreated datePublished" datetime="2020-01-07T00:00:00+08:00">2020-01-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/servicemesh/" itemprop="url" rel="index">
                    <span itemprop="name">servicemesh</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/servicemesh/istio/" itemprop="url" rel="index">
                    <span itemprop="name">istio</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/servicemesh/istio/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在新版的Istio当中，官方已经不推荐用Helm的方式安装了（同时不支持Helm3），推荐用istioctl命令行的方式安装。所以这里记录istioctl的方式安装Istio。</p><h2 id="环境说明"><a href="#环境说明" class="headerlink" title="环境说明"></a>环境说明</h2><ul>
<li>Amazon Linux 2 AMI，本身是基于CentOS 7</li>
<li>Kubernetes 1.16.4</li>
<li>Istio 1.4.2</li>
</ul><h2 id="安装Istio-1-4-2"><a href="#安装Istio-1-4-2" class="headerlink" title="安装Istio 1.4.2"></a>安装Istio 1.4.2</h2><h3 id="下载-istio-1-4-2"><a href="#下载-istio-1-4-2" class="headerlink" title="下载 istio 1.4.2"></a>下载 istio 1.4.2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget -c <span class="string">"https://github.com/istio/istio/releases/download/1.4.2/istio-1.4.2-linux.tar.gz"</span></span><br><span class="line">$ tar xf istio-1.4.2-linux.tar.gz</span><br><span class="line">$ sudo mv istio-1.4.2/bin/istioctl /usr/<span class="built_in">local</span>/bin</span><br><span class="line">$ ls</span><br><span class="line">bin  install  LICENSE  manifest.yaml  README.md  samples  tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 整体目录结构</span></span><br><span class="line">$ tree -L 3 -F</span><br><span class="line">.</span><br><span class="line">├── bin/</span><br><span class="line">│   └── istioctl*</span><br><span class="line">├── install/</span><br><span class="line">│   ├── consul/</span><br><span class="line">│   │   ├── consul_config/</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── templates/</span><br><span class="line">│   ├── gcp/</span><br><span class="line">│   │   ├── bootstrap/</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── kubernetes/</span><br><span class="line">│   │   ├── global-default-sidecar-scope.yaml</span><br><span class="line">│   │   ├── helm/</span><br><span class="line">│   │   ├── istio-demo.yaml</span><br><span class="line">│   │   ├── mesh-expansion.yaml</span><br><span class="line">│   │   ├── namespace.yaml</span><br><span class="line">│   │   ├── operator/</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   └── tools/</span><br><span class="line">├── LICENSE</span><br><span class="line">├── manifest.yaml</span><br><span class="line">├── README.md</span><br><span class="line">├── samples/</span><br><span class="line">│   ├── bookinfo/</span><br><span class="line">│   │   ├── networking/</span><br><span class="line">│   │   ├── platform/</span><br><span class="line">│   │   ├── policy/</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   ├── src/</span><br><span class="line">│   │   ├── swagger.yaml</span><br><span class="line">│   │   └── telemetry/</span><br><span class="line">│   ├── certs/</span><br><span class="line">│   │   ├── ca-cert.pem</span><br><span class="line">│   │   ├── ca-key.pem</span><br><span class="line">│   │   ├── cert-chain.pem</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── root-cert.pem</span><br><span class="line">│   ├── custom-bootstrap/</span><br><span class="line">│   │   ├── custom-bootstrap.yaml</span><br><span class="line">│   │   ├── example-app.yaml</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── external/</span><br><span class="line">│   │   ├── aptget.yaml</span><br><span class="line">│   │   ├── github.yaml</span><br><span class="line">│   │   ├── pypi.yaml</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── fortio/</span><br><span class="line">│   │   └── stackdriver.yaml</span><br><span class="line">│   ├── health-check/</span><br><span class="line">│   │   ├── liveness-command.yaml</span><br><span class="line">│   │   ├── liveness-http-same-port.yaml</span><br><span class="line">│   │   └── liveness-http.yaml</span><br><span class="line">│   ├── helloworld/</span><br><span class="line">│   │   ├── helloworld-gateway.yaml</span><br><span class="line">│   │   ├── helloworld.yaml</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── src/</span><br><span class="line">│   ├── httpbin/</span><br><span class="line">│   │   ├── httpbin-gateway.yaml</span><br><span class="line">│   │   ├── httpbin-nodeport.yaml</span><br><span class="line">│   │   ├── httpbin-vault.yaml</span><br><span class="line">│   │   ├── httpbin.yaml</span><br><span class="line">│   │   ├── policy/</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   └── sample-client/</span><br><span class="line">│   ├── https/</span><br><span class="line">│   │   ├── default.conf</span><br><span class="line">│   │   └── nginx-app.yaml</span><br><span class="line">│   ├── kubernetes-blog/</span><br><span class="line">│   │   ├── bookinfo-ratings.yaml</span><br><span class="line">│   │   ├── bookinfo-reviews-v2.yaml</span><br><span class="line">│   │   └── bookinfo-v1.yaml</span><br><span class="line">│   ├── multicluster/</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── operator/</span><br><span class="line">│   │   ├── pilot-advanced-override.yaml</span><br><span class="line">│   │   ├── pilot-k8s.yaml</span><br><span class="line">│   │   ├── sds-policy-off.yaml</span><br><span class="line">│   │   ├── sds.yaml</span><br><span class="line">│   │   ├── trafficManagement-namespace.yaml</span><br><span class="line">│   │   ├── values-global.yaml</span><br><span class="line">│   │   └── values-pilot.yaml</span><br><span class="line">│   ├── rawvm/</span><br><span class="line">│   │   └── README.md</span><br><span class="line">│   ├── README.md</span><br><span class="line">│   ├── security/</span><br><span class="line">│   │   └── psp/</span><br><span class="line">│   ├── sleep/</span><br><span class="line">│   │   ├── policy/</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   ├── sleep-vault.yaml</span><br><span class="line">│   │   ├── sleep.yaml</span><br><span class="line">│   │   └── telemetry/</span><br><span class="line">│   ├── tcp-echo/</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   ├── src/</span><br><span class="line">│   │   ├── tcp-echo-20-v2.yaml</span><br><span class="line">│   │   ├── tcp-echo-all-v1.yaml</span><br><span class="line">│   │   ├── tcp-echo-services.yaml</span><br><span class="line">│   │   └── tcp-echo.yaml</span><br><span class="line">│   └── websockets/</span><br><span class="line">│       ├── app.yaml</span><br><span class="line">│       ├── README.md</span><br><span class="line">│       └── route.yaml</span><br><span class="line">└── tools/</span><br><span class="line">    ├── convert_RbacConfig_to_ClusterRbacConfig.sh</span><br><span class="line">    ├── dump_kubernetes.sh</span><br><span class="line">    ├── _istioctl</span><br><span class="line">    ├── istioctl.bash</span><br><span class="line">    └── packaging/</span><br><span class="line">        └── common/</span><br><span class="line"></span><br><span class="line">44 directories, 68 files</span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes install 目录</span></span><br><span class="line">$ tree -L 4 -F install/kubernetes/</span><br><span class="line">install/kubernetes/</span><br><span class="line">├── global-default-sidecar-scope.yaml</span><br><span class="line">├── helm/ <span class="comment"># helm安装方式</span></span><br><span class="line">│   ├── helm-service-account.yaml</span><br><span class="line">│   ├── istio/</span><br><span class="line">│   │   ├── charts/</span><br><span class="line">│   │   │   ├── certmanager/</span><br><span class="line">│   │   │   ├── galley/</span><br><span class="line">│   │   │   ├── gateways/</span><br><span class="line">│   │   │   ├── grafana/</span><br><span class="line">│   │   │   ├── istiocoredns/</span><br><span class="line">│   │   │   ├── kiali/</span><br><span class="line">│   │   │   ├── mixer/</span><br><span class="line">│   │   │   ├── nodeagent/</span><br><span class="line">│   │   │   ├── pilot/</span><br><span class="line">│   │   │   ├── prometheus/</span><br><span class="line">│   │   │   ├── security/</span><br><span class="line">│   │   │   ├── sidecarInjectorWebhook/</span><br><span class="line">│   │   │   └── tracing/</span><br><span class="line">│   │   ├── Chart.yaml</span><br><span class="line">│   │   ├── example-values/</span><br><span class="line">│   │   │   ├── README.md</span><br><span class="line">│   │   │   ├── values-istio-dns-cert.yaml</span><br><span class="line">│   │   │   ├── values-istio-example-sds-vault.yaml</span><br><span class="line">│   │   │   ├── values-istio-gateways.yaml</span><br><span class="line">│   │   │   ├── values-istio-googleca.yaml</span><br><span class="line">│   │   │   ├── values-istio-meshexpansion-gateways.yaml</span><br><span class="line">│   │   │   └── values-istio-multicluster-gateways.yaml</span><br><span class="line">│   │   ├── files/</span><br><span class="line">│   │   │   └── injection-template.yaml</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   ├── requirements.yaml</span><br><span class="line">│   │   ├── templates/</span><br><span class="line">│   │   │   ├── _affinity.tpl</span><br><span class="line">│   │   │   ├── clusterrolebinding.yaml</span><br><span class="line">│   │   │   ├── clusterrole.yaml</span><br><span class="line">│   │   │   ├── configmap.yaml</span><br><span class="line">│   │   │   ├── endpoints.yaml</span><br><span class="line">│   │   │   ├── _helpers.tpl</span><br><span class="line">│   │   │   ├── install-custom-resources.sh.tpl</span><br><span class="line">│   │   │   ├── NOTES.txt</span><br><span class="line">│   │   │   ├── _podDisruptionBudget.tpl</span><br><span class="line">│   │   │   ├── serviceaccount.yaml</span><br><span class="line">│   │   │   ├── service.yaml</span><br><span class="line">│   │   │   └── sidecar-injector-configmap.yaml</span><br><span class="line">│   │   ├── <span class="built_in">test</span>-values/</span><br><span class="line">│   │   │   ├── README.md</span><br><span class="line">│   │   │   ├── values-e2e.yaml</span><br><span class="line">│   │   │   ├── values-istio-auth-mcp.yaml</span><br><span class="line">│   │   │   ├── values-istio-auth-multicluster.yaml</span><br><span class="line">│   │   │   ├── values-istio-auth-non-mcp.yaml</span><br><span class="line">│   │   │   ├── values-istio-auth-sds.yaml</span><br><span class="line">│   │   │   ├── values-istio-auth.yaml</span><br><span class="line">│   │   │   ├── values-istio-dns-cert.yaml</span><br><span class="line">│   │   │   ├── values-istio-mcp.yaml</span><br><span class="line">│   │   │   ├── values-istio-multicluster-split-horizon.yaml</span><br><span class="line">│   │   │   ├── values-istio-multicluster.yaml</span><br><span class="line">│   │   │   ├── values-istio-non-mcp.yaml</span><br><span class="line">│   │   │   ├── values-istio-one-namespace-auth.yaml</span><br><span class="line">│   │   │   ├── values-istio-one-namespace-trust-domain.yaml</span><br><span class="line">│   │   │   ├── values-istio-one-namespace.yaml</span><br><span class="line">│   │   │   └── values-istio.yaml</span><br><span class="line">│   │   ├── values-istio-demo.yaml</span><br><span class="line">│   │   ├── values-istio-minimal.yaml</span><br><span class="line">│   │   ├── values-istio-remote.yaml</span><br><span class="line">│   │   ├── values-istio-sds-auth-control-plane-auth-disabled.yaml</span><br><span class="line">│   │   ├── values-istio-sds-auth.yaml</span><br><span class="line">│   │   └── values.yaml</span><br><span class="line">│   ├── istio-cni/</span><br><span class="line">│   │   ├── Chart.yaml</span><br><span class="line">│   │   ├── templates/</span><br><span class="line">│   │   │   ├── istio-cni.yaml</span><br><span class="line">│   │   │   └── _labels.tpl</span><br><span class="line">│   │   ├── values_gke.yaml</span><br><span class="line">│   │   └── values.yaml</span><br><span class="line">│   ├── istio-init/</span><br><span class="line">│   │   ├── Chart.yaml</span><br><span class="line">│   │   ├── files/</span><br><span class="line">│   │   │   ├── crd-10.yaml</span><br><span class="line">│   │   │   ├── crd-11.yaml</span><br><span class="line">│   │   │   ├── crd-14.yaml</span><br><span class="line">│   │   │   ├── crd-certmanager-10.yaml</span><br><span class="line">│   │   │   └── crd-certmanager-11.yaml</span><br><span class="line">│   │   ├── README.md</span><br><span class="line">│   │   ├── templates/</span><br><span class="line">│   │   │   ├── clusterrolebinding.yaml</span><br><span class="line">│   │   │   ├── clusterrole.yaml</span><br><span class="line">│   │   │   ├── configmap-crd-10.yaml</span><br><span class="line">│   │   │   ├── configmap-crd-11.yaml</span><br><span class="line">│   │   │   ├── configmap-crd-14.yaml</span><br><span class="line">│   │   │   ├── configmap-crd-certmanager-10.yaml</span><br><span class="line">│   │   │   ├── configmap-crd-certmanager-11.yaml</span><br><span class="line">│   │   │   ├── job-crd-10.yaml</span><br><span class="line">│   │   │   ├── job-crd-11.yaml</span><br><span class="line">│   │   │   ├── job-crd-14.yaml</span><br><span class="line">│   │   │   ├── job-crd-certmanager-10.yaml</span><br><span class="line">│   │   │   ├── job-crd-certmanager-11.yaml</span><br><span class="line">│   │   │   └── serviceaccount.yaml</span><br><span class="line">│   │   └── values.yaml</span><br><span class="line">│   └── README.md</span><br><span class="line">├── istio-demo.yaml</span><br><span class="line">├── mesh-expansion.yaml</span><br><span class="line">├── namespace.yaml</span><br><span class="line">├── operator/</span><br><span class="line">│   ├── charts/</span><br><span class="line">│   │   ├── base/</span><br><span class="line">│   │   │   ├── Chart.yaml</span><br><span class="line">│   │   │   ├── files/</span><br><span class="line">│   │   │   ├── kustomization.yaml</span><br><span class="line">│   │   │   ├── templates/</span><br><span class="line">│   │   │   └── values.yaml</span><br><span class="line">│   │   ├── gateways/</span><br><span class="line">│   │   │   ├── istio-egress/</span><br><span class="line">│   │   │   └── istio-ingress/</span><br><span class="line">│   │   ├── istio-cni/</span><br><span class="line">│   │   │   ├── Chart.yaml</span><br><span class="line">│   │   │   ├── templates/</span><br><span class="line">│   │   │   └── values.yaml</span><br><span class="line">│   │   ├── istio-control/</span><br><span class="line">│   │   │   ├── istio-autoinject/</span><br><span class="line">│   │   │   ├── istio-config/</span><br><span class="line">│   │   │   └── istio-discovery/</span><br><span class="line">│   │   ├── istiocoredns/</span><br><span class="line">│   │   │   ├── Chart.yaml</span><br><span class="line">│   │   │   ├── templates/</span><br><span class="line">│   │   │   └── values.yaml</span><br><span class="line">│   │   ├── istio-policy/</span><br><span class="line">│   │   │   ├── Chart.yaml</span><br><span class="line">│   │   │   ├── templates/</span><br><span class="line">│   │   │   └── values.yaml</span><br><span class="line">│   │   ├── istio-telemetry/</span><br><span class="line">│   │   │   ├── grafana/</span><br><span class="line">│   │   │   ├── kiali/</span><br><span class="line">│   │   │   ├── mixer-telemetry/</span><br><span class="line">│   │   │   ├── prometheus/</span><br><span class="line">│   │   │   ├── prometheus-operator/</span><br><span class="line">│   │   │   └── tracing/</span><br><span class="line">│   │   └── security/</span><br><span class="line">│   │       ├── certmanager/</span><br><span class="line">│   │       ├── citadel/</span><br><span class="line">│   │       └── nodeagent/</span><br><span class="line">│   ├── deploy/</span><br><span class="line">│   │   ├── clusterrole_binding.yaml</span><br><span class="line">│   │   ├── clusterrole.yaml</span><br><span class="line">│   │   ├── crds/</span><br><span class="line">│   │   │   ├── istio_v1alpha2_istiocontrolplane_crd.yaml</span><br><span class="line">│   │   │   └── istio_v1alpha2_istiocontrolplane_cr.yaml</span><br><span class="line">│   │   ├── kustomization.yaml</span><br><span class="line">│   │   ├── namespace.yaml</span><br><span class="line">│   │   ├── operator.yaml</span><br><span class="line">│   │   ├── service_account.yaml</span><br><span class="line">│   │   └── service.yaml</span><br><span class="line">│   ├── examples/</span><br><span class="line">│   │   ├── multicluster/</span><br><span class="line">│   │   │   ├── values-istio-multicluster-gateways.yaml</span><br><span class="line">│   │   │   └── values-istio-multicluster-primary.yaml</span><br><span class="line">│   │   └── vm/</span><br><span class="line">│   │       ├── values-istio-meshexpansion-gateways.yaml</span><br><span class="line">│   │       └── values-istio-meshexpansion.yaml</span><br><span class="line">│   ├── profiles/</span><br><span class="line">│   │   ├── default.yaml</span><br><span class="line">│   │   ├── demo.yaml</span><br><span class="line">│   │   ├── minimal.yaml</span><br><span class="line">│   │   ├── remote.yaml</span><br><span class="line">│   │   └── sds.yaml</span><br><span class="line">│   └── versions.yaml</span><br><span class="line">└── README.md</span><br><span class="line"></span><br><span class="line">60 directories, 106 files</span><br></pre></td></tr></table></figure><a id="more"></a>



<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/istio-release-dir.png" alt></p>
<p>查看<code>istioctl</code>命令行帮助：</p>
<p>详细参考：<a href="https://istio.io/docs/reference/commands/istioctl/" target="_blank" rel="noopener">https://istio.io/docs/reference/commands/istioctl/</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ istioctl --<span class="built_in">help</span></span><br><span class="line">Istio configuration <span class="built_in">command</span> line utility <span class="keyword">for</span> service operators to</span><br><span class="line">debug and diagnose their Istio mesh.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  authn           Interact with Istio authentication policies</span><br><span class="line">  authz           (authz is experimental.  Use `istioctl experimental authz`)</span><br><span class="line">  convert-ingress Convert Ingress configuration into Istio VirtualService configuration</span><br><span class="line">  dashboard       Access to Istio web UIs</span><br><span class="line">  deregister      De-registers a service instance</span><br><span class="line">  experimental    Experimental commands that may be modified or deprecated</span><br><span class="line">  <span class="built_in">help</span>            Help about any <span class="built_in">command</span></span><br><span class="line">  kube-inject     Inject Envoy sidecar into Kubernetes pod resources</span><br><span class="line">  manifest        Commands related to Istio manifests</span><br><span class="line">  profile         Commands related to Istio configuration profiles</span><br><span class="line">  proxy-config    Retrieve information about proxy configuration from Envoy [kube only]</span><br><span class="line">  proxy-status    Retrieves the synchronization status of each Envoy <span class="keyword">in</span> the mesh [kube only]</span><br><span class="line">  register        Registers a service instance (e.g. VM) joining the mesh</span><br><span class="line">  validate        Validate Istio policy and rules</span><br><span class="line">  verify-install  Verifies Istio Installation Status or performs pre-check <span class="keyword">for</span> the cluster before Istio installation</span><br><span class="line">  version         Prints out build version information</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --context string            The name of the kubeconfig context to use</span><br><span class="line">  -h, --<span class="built_in">help</span>                      <span class="built_in">help</span> <span class="keyword">for</span> istioctl</span><br><span class="line">  -i, --istioNamespace string     Istio system namespace (default <span class="string">"istio-system"</span>)</span><br><span class="line">  -c, --kubeconfig string         Kubernetes configuration file</span><br><span class="line">      --log_output_level string   Comma-separated minimum per-scope logging level of messages to output, <span class="keyword">in</span> the form of &lt;scope&gt;:&lt;level&gt;,&lt;scope&gt;:&lt;level&gt;,... <span class="built_in">where</span> scope can be one of [ads, all, analysis, attributes, authn, cacheLog, citadelClientLog, configMapController, conversions, default, googleCAClientLog, grpcAdapter, kube, kube-converter, mcp, meshconfig, model, patch, processing, rbac, resource, runtime, sdsServiceLog, secretFetcherLog, <span class="built_in">source</span>, stsClientLog, tpath, translator, util, validation, vaultClientLog] and level can be one of [debug, info, warn, error, fatal, none] (default <span class="string">"default:info,validation:error,processing:error,source:error,analysis:warn"</span>)</span><br><span class="line">  -n, --namespace string          Config namespace</span><br><span class="line"></span><br><span class="line">Use <span class="string">"istioctl [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>

<p>查看istio版本：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">version</span> <span class="string">--remote</span> <span class="string">-s</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">clientVersion:</span></span><br><span class="line">  <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">  <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932-dirty</span></span><br><span class="line">  <span class="attr">status:</span> <span class="string">Modified</span></span><br><span class="line">  <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="attr">dataPlaneVersion:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ID:</span> <span class="string">istio-ingressgateway-6d759478d8-crwg5.istio-system</span></span><br><span class="line">  <span class="attr">IstioVersion:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">ID:</span> <span class="string">istio-egressgateway-68f754ccdd-2bwdn.istio-system</span></span><br><span class="line">  <span class="attr">IstioVersion:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="attr">meshVersion:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">citadel</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">egressgateway</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">galley</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">ingressgateway</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">pilot</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">policy</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">sidecar-injector</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">Component:</span> <span class="string">telemetry</span></span><br><span class="line">  <span class="attr">Info:</span></span><br><span class="line">    <span class="attr">golang_version:</span> <span class="string">go1.13.4</span></span><br><span class="line">    <span class="attr">revision:</span> <span class="string">35eb9dc7c6e78dac5bd8c3d142bc2a4601616932</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Clean</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">1.4</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>

<p>查看istio 内置的profile列表：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ istioctl profile --<span class="built_in">help</span></span><br><span class="line">The profile subcommand lists, dumps or diffs Istio configuration profiles.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl profile [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  diff        Diffs two Istio configuration profiles</span><br><span class="line">  dump        Dumps an Istio configuration profile</span><br><span class="line">  list        Lists available Istio configuration profiles</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --dry-run       Console/<span class="built_in">log</span> output only, make no changes.</span><br><span class="line">  -h, --<span class="built_in">help</span>          <span class="built_in">help</span> <span class="keyword">for</span> profile</span><br><span class="line">      --logtostderr   Send logs to stderr.</span><br><span class="line">      --verbose       Verbose output.</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">...</span><br><span class="line">Use <span class="string">"istioctl profile [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br><span class="line"></span><br><span class="line">$ istioctl profile list</span><br><span class="line">Istio configuration profiles:</span><br><span class="line">    demo</span><br><span class="line">    minimal</span><br><span class="line">    remote</span><br><span class="line">    sds</span><br><span class="line">    default</span><br></pre></td></tr></table></figure>

<h3 id="istio内置的profile对比"><a href="#istio内置的profile对比" class="headerlink" title="istio内置的profile对比"></a>istio内置的profile对比</h3><blockquote>
<p>参考：<a href="https://istio.io/docs/setup/additional-setup/config-profiles/" target="_blank" rel="noopener">https://istio.io/docs/setup/additional-setup/config-profiles/</a></p>
</blockquote>
<ol>
<li><p><strong>default</strong>: enables components according to the default settings of the <a href="https://istio.io/docs/reference/config/istio.operator.v1alpha12.pb/" target="_blank" rel="noopener"><code>IstioControlPlane</code> API</a> (recommend for production deployments). You can display the default setting by running the command <code>istioctl profile dump</code>.可用于部署生产环境的Istio</p>
</li>
<li><p><strong>demo</strong>: configuration designed to showcase Istio functionality with modest resource requirements. It is suitable to run the <a href="https://istio.io/docs/examples/bookinfo/" target="_blank" rel="noopener">Bookinfo</a> application and associated tasks. This is the configuration that is installed with the <a href="https://istio.io/docs/setup/getting-started/" target="_blank" rel="noopener">quick start</a> instructions, but you can later <a href="https://istio.io/docs/setup/install/istioctl/#customizing-the-configuration" target="_blank" rel="noopener">customize the configuration</a> to enable additional features if you wish to explore more advanced tasks. 只是demo，资源request的很低，安装的功能很多</p>
<p>This profile enables high levels of tracing and access logging so it is not suitable for performance tests.</p>
</li>
<li><p><strong>minimal</strong>: the minimal set of components necessary to use Istio’s <a href="https://istio.io/docs/tasks/traffic-management/" target="_blank" rel="noopener">traffic management</a> features. 最小化安装</p>
</li>
<li><p><strong>sds</strong>: similar to the <strong>default</strong> profile, but also enables Istio’s <a href="https://istio.io/docs/tasks/security/citadel-config/auth-sds" target="_blank" rel="noopener">SDS (secret discovery service)</a>. This profile comes with additional authentication features enabled by default (Strict Mutual TLS). 对比default，只开启了SDS</p>
</li>
<li><p><strong>remote</strong>: used for configuring remote clusters of a <a href="https://istio.io/docs/ops/deployment/deployment-models/#multiple-clusters" target="_blank" rel="noopener">multicluster mesh</a> with a <a href="https://istio.io/docs/setup/install/multicluster/shared-vpn/" target="_blank" rel="noopener">shared control plane</a> configuration. 多cluster共享一个控制面部署</p>
</li>
</ol>
<p>The components marked as <strong>X</strong> are installed within each profile:</p>
<table>
<thead>
<tr>
<th></th>
<th>default</th>
<th>demo</th>
<th>minimal</th>
<th>sds</th>
<th>remote</th>
</tr>
</thead>
<tbody><tr>
<td>Core components</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>istio-citadel</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><code>istio-egressgateway</code></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>istio-galley</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
</tr>
<tr>
<td><code>istio-ingressgateway</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
</tr>
<tr>
<td><code>istio-nodeagent</code></td>
<td></td>
<td></td>
<td></td>
<td>X</td>
<td></td>
</tr>
<tr>
<td><code>istio-pilot</code></td>
<td>X</td>
<td>X</td>
<td>X</td>
<td>X</td>
<td></td>
</tr>
<tr>
<td><code>istio-policy</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
</tr>
<tr>
<td><code>istio-sidecar-injector</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td>X</td>
</tr>
<tr>
<td><code>istio-telemetry</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
</tr>
<tr>
<td>Addons</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>grafana</code></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>istio-tracing</code></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>kiali</code></td>
<td></td>
<td>X</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>prometheus</code></td>
<td>X</td>
<td>X</td>
<td></td>
<td>X</td>
<td></td>
</tr>
</tbody></table>
<p>To further customize Istio and install addons, you can add one or more <code>--set =</code> options in the <code>istioctl manifest</code> command that you use when installing Istio. Refer to <a href="https://istio.io/docs/setup/install/istioctl/#customizing-the-configuration" target="_blank" rel="noopener">customizing the configuration</a> for details.</p>
<p>可以更改默认的profile配置来安装：参考：<a href="https://istio.io/docs/setup/install/istioctl/" target="_blank" rel="noopener">https://istio.io/docs/setup/install/istioctl/</a></p>
<h3 id="查看demo的profile"><a href="#查看demo的profile" class="headerlink" title="查看demo的profile"></a>查看demo的profile</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">dump</span> <span class="string">--help</span></span><br><span class="line"><span class="string">The</span> <span class="string">dump</span> <span class="string">subcommand</span> <span class="string">dumps</span> <span class="string">the</span> <span class="string">values</span> <span class="string">in</span> <span class="string">an</span> <span class="string">Istio</span> <span class="string">configuration</span> <span class="string">profile.</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Usage:</span></span><br><span class="line">  <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">dump</span> <span class="string">[&lt;profile&gt;]</span> <span class="string">[flags]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Flags:</span></span><br><span class="line">  <span class="string">-p,</span> <span class="string">--config-path</span> <span class="string">string</span>   <span class="string">The</span> <span class="string">path</span> <span class="string">the</span> <span class="string">root</span> <span class="string">of</span> <span class="string">the</span> <span class="string">configuration</span> <span class="string">subtree</span> <span class="string">to</span> <span class="string">dump</span> <span class="string">e.g.</span> <span class="string">trafficManagement.components.pilot.</span> <span class="string">By</span> <span class="string">default,</span> <span class="string">dump</span> <span class="string">whole</span> <span class="string">tree</span> <span class="comment"># 查看指定的tree</span></span><br><span class="line">  <span class="string">-f,</span> <span class="string">--filename</span> <span class="string">string</span>      <span class="string">Path</span> <span class="string">to</span> <span class="string">file</span> <span class="string">containing</span> <span class="string">IstioControlPlane</span> <span class="string">CustomResource</span></span><br><span class="line">      <span class="string">--helm-values</span>          <span class="string">If</span> <span class="string">set,</span> <span class="string">dumps</span> <span class="string">the</span> <span class="string">Helm</span> <span class="string">values</span> <span class="string">that</span> <span class="string">IstioControlPlaceSpec</span> <span class="string">is</span> <span class="string">translated</span> <span class="string">to</span> <span class="string">before</span> <span class="string">manifests</span> <span class="string">are</span> <span class="string">rendered</span> <span class="comment"># 查看helm values部分</span></span><br><span class="line">  <span class="string">-h,</span> <span class="string">--help</span>                 <span class="string">help</span> <span class="string">for</span> <span class="string">dump</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Global Flags:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看内置的demo profile</span></span><br><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">dump</span> <span class="string">demo</span></span><br><span class="line"><span class="attr">autoInjection:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">injector:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">cni:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">configManagement:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">galley:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">defaultNamespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">gateways:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">egressGateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">hpaSpec:</span></span><br><span class="line">          <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">metrics:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">              <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">          <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">scaleTargetRef:</span></span><br><span class="line">            <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">            <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">istio-egressgateway</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">ingressGateway:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">hpaSpec:</span></span><br><span class="line">          <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">metrics:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">              <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">          <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">scaleTargetRef:</span></span><br><span class="line">            <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">            <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">hub:</span> <span class="string">docker.io/istio</span></span><br><span class="line"><span class="attr">policy:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">policy:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="attr">hpaSpec:</span></span><br><span class="line">          <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">metrics:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">              <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">          <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">scaleTargetRef:</span></span><br><span class="line">            <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">            <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">istio-policy</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">certManager:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">citadel:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">    <span class="attr">nodeAgent:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">tag:</span> <span class="number">1.4</span><span class="number">.2</span></span><br><span class="line"><span class="attr">telemetry:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">telemetry:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GOMAXPROCS</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"6"</span></span><br><span class="line">        <span class="attr">hpaSpec:</span></span><br><span class="line">          <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">metrics:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">              <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">          <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">scaleTargetRef:</span></span><br><span class="line">            <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">            <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">istio-telemetry</span></span><br><span class="line">        <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">4800m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">4G</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">50m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">trafficManagement:</span></span><br><span class="line">  <span class="attr">components:</span></span><br><span class="line">    <span class="attr">pilot:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">k8s:</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GODEBUG</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">gctrace=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PILOT_TRACE_SAMPLING</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"100"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">CONFIG_NAMESPACE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">istio-config</span></span><br><span class="line">        <span class="attr">hpaSpec:</span></span><br><span class="line">          <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">metrics:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">resource:</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">              <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">          <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">scaleTargetRef:</span></span><br><span class="line">            <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">            <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">istio-pilot</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/ready</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">30</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">strategy:</span></span><br><span class="line">          <span class="attr">rollingUpdate:</span></span><br><span class="line">            <span class="attr">maxSurge:</span> <span class="number">100</span><span class="string">%</span></span><br><span class="line">            <span class="attr">maxUnavailable:</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">values:</span> <span class="comment"># helm values部分</span></span><br><span class="line">  <span class="attr">certmanager:</span></span><br><span class="line">    <span class="attr">hub:</span> <span class="string">quay.io/jetstack</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">cert-manager-controller</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">v0.6.2</span></span><br><span class="line">  <span class="attr">clusterResources:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">galley:</span></span><br><span class="line">    <span class="attr">enableAnalysis:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">galley</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">    <span class="attr">istio-egressgateway:</span></span><br><span class="line">      <span class="attr">autoscaleEnabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">ISTIO_META_ROUTER_MODE:</span> <span class="string">sni-dnat</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http2</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tls</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15443</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15443</span></span><br><span class="line">      <span class="attr">secretVolumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/egressgateway-certs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">egressgateway-certs</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">istio-egressgateway-certs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/egressgateway-ca-certs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">egressgateway-ca-certs</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">istio-egressgateway-ca-certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">      <span class="attr">zvpn:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">suffix:</span> <span class="string">global</span></span><br><span class="line">    <span class="attr">istio-ingressgateway:</span></span><br><span class="line">      <span class="attr">applicationPorts:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">autoscaleEnabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">domain:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">ISTIO_META_ROUTER_MODE:</span> <span class="string">sni-dnat</span></span><br><span class="line">      <span class="attr">meshExpansionPorts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-pilot-grpc-tls</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15011</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15011</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-citadel-grpc-tls</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">8060</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">8060</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tcp-dns-tls</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">853</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">853</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">status-port</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15020</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15020</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http2</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kiali</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15029</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15029</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15030</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15030</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15031</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15031</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tracing</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15032</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15032</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tls</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15443</span></span><br><span class="line">        <span class="attr">targetPort:</span> <span class="number">15443</span></span><br><span class="line">      <span class="attr">sds:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">node-agent-k8s</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">      <span class="attr">secretVolumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/ingressgateway-certs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ingressgateway-certs</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">istio-ingressgateway-certs</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/ingressgateway-ca-certs</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ingressgateway-ca-certs</span></span><br><span class="line">        <span class="attr">secretName:</span> <span class="string">istio-ingressgateway-ca-certs</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">      <span class="attr">zvpn:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">suffix:</span> <span class="string">global</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">arch:</span></span><br><span class="line">      <span class="attr">amd64:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">ppc64le:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">s390x:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">certificates:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">configValidation:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">controlPlaneSecurityEnabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">defaultNodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">defaultPodDisruptionBudget:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">defaultResources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">    <span class="attr">disablePolicyChecks:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enableHelmTest:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enableTracing:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">imagePullSecrets:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">k8sIngress:</span></span><br><span class="line">      <span class="attr">enableHttps:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">gatewayName:</span> <span class="string">ingressgateway</span></span><br><span class="line">    <span class="attr">localityLbSetting:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">logAsJson:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">logging:</span></span><br><span class="line">      <span class="attr">level:</span> <span class="string">default:info</span></span><br><span class="line">    <span class="attr">meshExpansion:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">useILB:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">meshNetworks:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">mtls:</span></span><br><span class="line">      <span class="attr">auto:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">multiCluster:</span></span><br><span class="line">      <span class="attr">clusterName:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">network:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">omitSidecarInjectorConfigMap:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">oneNamespace:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">operatorManageWebhooks:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">outboundTrafficPolicy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">ALLOW_ANY</span></span><br><span class="line">    <span class="attr">policyCheckFailOpen:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">priorityClassName:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">proxy:</span></span><br><span class="line">      <span class="attr">accessLogEncoding:</span> <span class="string">TEXT</span></span><br><span class="line">      <span class="attr">accessLogFile:</span> <span class="string">/dev/stdout</span></span><br><span class="line">      <span class="attr">accessLogFormat:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">autoInject:</span> <span class="string">enabled</span></span><br><span class="line">      <span class="attr">clusterDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">      <span class="attr">componentLogLevel:</span> <span class="string">misc:error</span></span><br><span class="line">      <span class="attr">concurrency:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">dnsRefreshRate:</span> <span class="string">300s</span></span><br><span class="line">      <span class="attr">enableCoreDump:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">envoyAccessLogService:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">host:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">port:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">envoyMetricsService:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">host:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">port:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">tcpKeepalive:</span></span><br><span class="line">          <span class="attr">interval:</span> <span class="string">10s</span></span><br><span class="line">          <span class="attr">probes:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">time:</span> <span class="string">10s</span></span><br><span class="line">        <span class="attr">tlsSettings:</span></span><br><span class="line">          <span class="attr">caCertificates:</span> <span class="literal">null</span></span><br><span class="line">          <span class="attr">clientCertificate:</span> <span class="literal">null</span></span><br><span class="line">          <span class="attr">mode:</span> <span class="string">DISABLE</span></span><br><span class="line">          <span class="attr">privateKey:</span> <span class="literal">null</span></span><br><span class="line">          <span class="attr">sni:</span> <span class="literal">null</span></span><br><span class="line">          <span class="attr">subjectAltNames:</span> <span class="string">[]</span></span><br><span class="line">      <span class="attr">envoyStatsd:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">host:</span> <span class="literal">null</span></span><br><span class="line">        <span class="attr">port:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">excludeIPRanges:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">excludeInboundPorts:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">excludeOutboundPorts:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">proxyv2</span></span><br><span class="line">      <span class="attr">includeIPRanges:</span> <span class="string">'*'</span></span><br><span class="line">      <span class="attr">includeInboundPorts:</span> <span class="string">'*'</span></span><br><span class="line">      <span class="attr">kubevirtInterfaces:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">logLevel:</span> <span class="string">warning</span></span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">protocolDetectionTimeout:</span> <span class="string">100ms</span></span><br><span class="line">      <span class="attr">readinessFailureThreshold:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">readinessInitialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">readinessPeriodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">2000m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">1024Mi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">      <span class="attr">statusPort:</span> <span class="number">15020</span></span><br><span class="line">      <span class="attr">tracer:</span> <span class="string">zipkin</span></span><br><span class="line">    <span class="attr">proxy_init:</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">proxyv2</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">10Mi</span></span><br><span class="line">    <span class="attr">sds:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">token:</span></span><br><span class="line">        <span class="attr">aud:</span> <span class="string">istio-ca</span></span><br><span class="line">      <span class="attr">udsPath:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">tracer:</span></span><br><span class="line">      <span class="attr">datadog:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">$(HOST_IP):8126</span></span><br><span class="line">      <span class="attr">lightstep:</span></span><br><span class="line">        <span class="attr">accessToken:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">cacertPath:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">secure:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">zipkin:</span></span><br><span class="line">        <span class="attr">address:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">trustDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">useMCP:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">accessMode:</span> <span class="string">ReadWriteMany</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/grafana</span></span><br><span class="line">    <span class="attr">dashboardProviders:</span></span><br><span class="line">      <span class="attr">dashboardproviders.yaml:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">disableDeletion:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">folder:</span> <span class="string">istio</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">istio</span></span><br><span class="line">          <span class="attr">options:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/var/lib/grafana/dashboards/istio</span></span><br><span class="line">          <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">datasources:</span></span><br><span class="line">      <span class="attr">datasources.yaml:</span></span><br><span class="line">        <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">datasources:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">envSecrets:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">image:</span></span><br><span class="line">      <span class="attr">repository:</span> <span class="string">grafana/grafana</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="number">6.4</span><span class="number">.3</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">grafana.local</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">persist:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">security:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">passphraseKey:</span> <span class="string">passphrase</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">grafana</span></span><br><span class="line">      <span class="attr">usernameKey:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">externalPort:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">loadBalancerIP:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">loadBalancerSourceRanges:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">    <span class="attr">storageClassName:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="attr">istiocoredns:</span></span><br><span class="line">    <span class="attr">coreDNSImage:</span> <span class="string">coredns/coredns</span></span><br><span class="line">    <span class="attr">coreDNSPluginImage:</span> <span class="string">istio/coredns-plugin:0.2-istio-1.1</span></span><br><span class="line">    <span class="attr">coreDNSTag:</span> <span class="number">1.6</span><span class="number">.2</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">kiali:</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/kiali</span></span><br><span class="line">    <span class="attr">createDemoSecret:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">dashboard:</span></span><br><span class="line">      <span class="attr">grafanaURL:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">jaegerURL:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">passphraseKey:</span> <span class="string">passphrase</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">kiali</span></span><br><span class="line">      <span class="attr">usernameKey:</span> <span class="string">username</span></span><br><span class="line">      <span class="attr">viewOnlyMode:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hub:</span> <span class="string">quay.io/kiali</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">kiali.local</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">prometheusNamespace:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">security:</span></span><br><span class="line">      <span class="attr">cert_file:</span> <span class="string">/kiali-cert/cert-chain.pem</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">private_key_file:</span> <span class="string">/kiali-cert/key.pem</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">v1.9</span></span><br><span class="line">  <span class="attr">mixer:</span></span><br><span class="line">    <span class="attr">adapters:</span></span><br><span class="line">      <span class="attr">kubernetesenv:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">prometheus:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">metricsExpiryDuration:</span> <span class="string">10m</span></span><br><span class="line">      <span class="attr">stackdriver:</span></span><br><span class="line">        <span class="attr">auth:</span></span><br><span class="line">          <span class="attr">apiKey:</span> <span class="string">""</span></span><br><span class="line">          <span class="attr">appCredentials:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">serviceAccountPath:</span> <span class="string">""</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">tracer:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">sampleProbability:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">stdio:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">outputAsJson:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">useAdapterCRDs:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">policy:</span></span><br><span class="line">      <span class="attr">adapters:</span></span><br><span class="line">        <span class="attr">kubernetesenv:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">useAdapterCRDs:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">autoscaleEnabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mixer</span></span><br><span class="line">      <span class="attr">sessionAffinityEnabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">telemetry:</span></span><br><span class="line">      <span class="attr">autoscaleEnabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GOMAXPROCS:</span> <span class="string">"6"</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">mixer</span></span><br><span class="line">      <span class="attr">loadshedding:</span></span><br><span class="line">        <span class="attr">latencyThreshold:</span> <span class="string">100ms</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">enforce</span></span><br><span class="line">      <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">      <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">      <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">reportBatchMaxEntries:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">reportBatchMaxTime:</span> <span class="string">1s</span></span><br><span class="line">      <span class="attr">sessionAffinityEnabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line">      <span class="attr">useMCP:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeagent:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">node-agent-k8s</span></span><br><span class="line">  <span class="attr">pilot:</span></span><br><span class="line">    <span class="attr">appNamespaces:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">autoscaleEnabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">autoscaleMax:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">autoscaleMin:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">configMap:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">configNamespace:</span> <span class="string">istio-config</span></span><br><span class="line">    <span class="attr">cpu:</span></span><br><span class="line">      <span class="attr">targetAverageUtilization:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">deploymentLabels:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">enableProtocolSniffingForInbound:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">enableProtocolSniffingForOutbound:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">pilot</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">ingressClass:</span> <span class="string">istio</span></span><br><span class="line">      <span class="attr">ingressControllerMode:</span> <span class="string">"OFF"</span></span><br><span class="line">      <span class="attr">ingressService:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">    <span class="attr">keepaliveMaxServerConnectionAge:</span> <span class="string">30m</span></span><br><span class="line">    <span class="attr">meshNetworks:</span></span><br><span class="line">      <span class="attr">networks:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">policy:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">traceSampling:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">useMCP:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/prometheus</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">hub:</span> <span class="string">docker.io/prom</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus.local</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">retention:</span> <span class="string">6h</span></span><br><span class="line">    <span class="attr">scrapeInterval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">security:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tag:</span> <span class="string">v2.12.0</span></span><br><span class="line">    <span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">dnsCerts:</span></span><br><span class="line">      <span class="attr">istio-pilot-service-account.istio-control:</span> <span class="string">istio-pilot.istio-control</span></span><br><span class="line">    <span class="attr">enableNamespacesByDefault:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">citadel</span></span><br><span class="line">    <span class="attr">selfSigned:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">trustDomain:</span> <span class="string">cluster.local</span></span><br><span class="line">  <span class="attr">sidecarInjectorWebhook:</span></span><br><span class="line">    <span class="attr">enableNamespacesByDefault:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sidecar_injector</span></span><br><span class="line">    <span class="attr">injectLabel:</span> <span class="string">istio-injection</span></span><br><span class="line">    <span class="attr">objectSelector:</span></span><br><span class="line">      <span class="attr">autoInject:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">rewriteAppHTTPProbe:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">selfSigned:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">telemetry:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">v2:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">tracing:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ingress:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="literal">null</span></span><br><span class="line">      <span class="attr">tls:</span> <span class="literal">null</span></span><br><span class="line">    <span class="attr">jaeger:</span></span><br><span class="line">      <span class="attr">accessMode:</span> <span class="string">ReadWriteMany</span></span><br><span class="line">      <span class="attr">hub:</span> <span class="string">docker.io/jaegertracing</span></span><br><span class="line">      <span class="attr">memory:</span></span><br><span class="line">        <span class="attr">max_traces:</span> <span class="number">50000</span></span><br><span class="line">      <span class="attr">persist:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">spanStorageType:</span> <span class="string">badger</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="string">"1.14"</span></span><br><span class="line">    <span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">opencensus:</span></span><br><span class="line">      <span class="attr">exporters:</span></span><br><span class="line">        <span class="attr">stackdriver:</span></span><br><span class="line">          <span class="attr">enable_tracing:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hub:</span> <span class="string">docker.io/omnition</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">"1"</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">2Gi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="number">0.1</span><span class="number">.9</span></span><br><span class="line">    <span class="attr">podAntiAffinityLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">podAntiAffinityTermLabelSelector:</span> <span class="string">[]</span></span><br><span class="line">    <span class="attr">provider:</span> <span class="string">jaeger</span></span><br><span class="line">    <span class="attr">service:</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="attr">externalPort:</span> <span class="number">9411</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http-query</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">    <span class="attr">zipkin:</span></span><br><span class="line">      <span class="attr">hub:</span> <span class="string">docker.io/openzipkin</span></span><br><span class="line">      <span class="attr">javaOptsHeap:</span> <span class="number">700</span></span><br><span class="line">      <span class="attr">maxSpans:</span> <span class="number">500000</span></span><br><span class="line">      <span class="attr">node:</span></span><br><span class="line">        <span class="attr">cpus:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">probeStartupDelay:</span> <span class="number">200</span></span><br><span class="line">      <span class="attr">queryPort:</span> <span class="number">9411</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">300m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">900Mi</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">150m</span></span><br><span class="line">          <span class="attr">memory:</span> <span class="string">900Mi</span></span><br><span class="line">      <span class="attr">tag:</span> <span class="number">2.14</span><span class="number">.2</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">""</span></span><br></pre></td></tr></table></figure>

<p>对比default和demo的profile：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">dump</span> <span class="string">default</span> <span class="string">&gt;</span> <span class="string">default.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">dump</span> <span class="string">demo</span> <span class="string">&gt;</span> <span class="string">demo.yaml</span></span><br><span class="line"><span class="string">$</span> <span class="string">istioctl</span> <span class="string">profile</span> <span class="string">diff</span> <span class="string">default.yaml</span> <span class="string">demo.yaml</span></span><br><span class="line"> <span class="attr">gateways:</span></span><br><span class="line">   <span class="attr">components:</span></span><br><span class="line">     <span class="attr">egressGateway:</span></span><br><span class="line"><span class="bullet">-</span>      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"><span class="string">+</span>      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>生成Kubernetes manifests yaml文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ istioctl manifest generate --<span class="built_in">help</span></span><br><span class="line">The generate subcommand generates an Istio install manifest and outputs to the console by default.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl manifest generate [flags]</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -f, --filename string   Path to file containing IstioControlPlane CustomResource</span><br><span class="line">      --force             Proceed even with validation errors</span><br><span class="line">  -h, --<span class="built_in">help</span>              <span class="built_in">help</span> <span class="keyword">for</span> generate</span><br><span class="line">  -o, --output string     Manifest output directory path</span><br><span class="line">  -s, --<span class="built_in">set</span> strings       Set a value <span class="keyword">in</span> IstioControlPlane CustomResource. e.g. --<span class="built_in">set</span> policy.enabled=<span class="literal">true</span>.</span><br><span class="line">                          Overrides the corresponding path value <span class="keyword">in</span> the selected profile or passed through IstioControlPlane CR</span><br><span class="line">                          customization file</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出到generate-manifest-istio-yaml文件夹</span></span><br><span class="line">$ istioctl manifest generate -o generate-manifest-istio-yaml</span><br><span class="line">$ tree</span><br><span class="line">.</span><br><span class="line">└── generate-manifest-istio-yaml</span><br><span class="line">    └── Base</span><br><span class="line">        ├── Base.yaml</span><br><span class="line">        ├── CertManager</span><br><span class="line">        │   └── CertManager.yaml</span><br><span class="line">        ├── Citadel</span><br><span class="line">        │   └── Citadel.yaml</span><br><span class="line">        ├── Cni</span><br><span class="line">        │   └── Cni.yaml</span><br><span class="line">        ├── EgressGateway</span><br><span class="line">        │   └── EgressGateway.yaml</span><br><span class="line">        ├── Galley</span><br><span class="line">        │   └── Galley.yaml</span><br><span class="line">        ├── Grafana</span><br><span class="line">        │   └── Grafana.yaml</span><br><span class="line">        ├── IngressGateway</span><br><span class="line">        │   └── IngressGateway.yaml</span><br><span class="line">        ├── Injector</span><br><span class="line">        │   └── Injector.yaml</span><br><span class="line">        ├── Kiali</span><br><span class="line">        │   └── Kiali.yaml</span><br><span class="line">        ├── NodeAgent</span><br><span class="line">        │   └── NodeAgent.yaml</span><br><span class="line">        ├── Pilot</span><br><span class="line">        │   └── Pilot.yaml</span><br><span class="line">        ├── Policy</span><br><span class="line">        │   └── Policy.yaml</span><br><span class="line">        ├── Prometheus</span><br><span class="line">        │   └── Prometheus.yaml</span><br><span class="line">        ├── PrometheusOperator</span><br><span class="line">        │   └── PrometheusOperator.yaml</span><br><span class="line">        ├── Telemetry</span><br><span class="line">        │   └── Telemetry.yaml</span><br><span class="line">        └── Tracing</span><br><span class="line">            └── Tracing.yaml</span><br><span class="line"></span><br><span class="line">18 directories, 17 files</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以将manifest输出到一个文件</span></span><br><span class="line">$ istioctl manifest generate &gt; generate-manifest-istio.yaml</span><br></pre></td></tr></table></figure>

<h3 id="使用demo-profile安装Istio"><a href="#使用demo-profile安装Istio" class="headerlink" title="使用demo profile安装Istio"></a>使用demo profile安装Istio</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ istioctl manifest apply --<span class="built_in">set</span> profile=demo</span><br><span class="line">Preparing manifests <span class="keyword">for</span> these components:</span><br><span class="line">- Galley</span><br><span class="line">- IngressGateway</span><br><span class="line">- NodeAgent</span><br><span class="line">- Citadel</span><br><span class="line">- PrometheusOperator</span><br><span class="line">- Base</span><br><span class="line">- CertManager</span><br><span class="line">- Kiali</span><br><span class="line">- Policy</span><br><span class="line">- EgressGateway</span><br><span class="line">- Injector</span><br><span class="line">- Pilot</span><br><span class="line">- Prometheus</span><br><span class="line">- Cni</span><br><span class="line">- CoreDNS</span><br><span class="line">- Grafana</span><br><span class="line">- Tracing</span><br><span class="line">- Telemetry</span><br><span class="line"></span><br><span class="line">Applying manifest <span class="keyword">for</span> component Base</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Base</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Tracing</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Pilot</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Prometheus</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Galley</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Kiali</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Injector</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Policy</span><br><span class="line">Applying manifest <span class="keyword">for</span> component EgressGateway</span><br><span class="line">Applying manifest <span class="keyword">for</span> component IngressGateway</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Citadel</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Telemetry</span><br><span class="line">Applying manifest <span class="keyword">for</span> component Grafana</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Tracing</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Citadel</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Prometheus</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Kiali</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Galley</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Injector</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Policy</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Pilot</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component IngressGateway</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component EgressGateway</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Grafana</span><br><span class="line">Finished applying manifest <span class="keyword">for</span> component Telemetry</span><br><span class="line"></span><br><span class="line">Component Injector installed successfully:</span><br><span class="line">==========================================</span><br><span class="line"></span><br><span class="line">Component Kiali installed successfully:</span><br><span class="line">=======================================</span><br><span class="line"></span><br><span class="line">Component Policy installed successfully:</span><br><span class="line">========================================</span><br><span class="line"></span><br><span class="line">Component EgressGateway installed successfully:</span><br><span class="line">===============================================</span><br><span class="line"></span><br><span class="line">Component Telemetry installed successfully:</span><br><span class="line">===========================================</span><br><span class="line"></span><br><span class="line">Component Pilot installed successfully:</span><br><span class="line">=======================================</span><br><span class="line"></span><br><span class="line">Component Prometheus installed successfully:</span><br><span class="line">============================================</span><br><span class="line"></span><br><span class="line">Component Cni installed successfully:</span><br><span class="line">=====================================</span><br><span class="line"></span><br><span class="line">Component CoreDNS installed successfully:</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Component Grafana installed successfully:</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Component Tracing installed successfully:</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Component Citadel installed successfully:</span><br><span class="line">=========================================</span><br><span class="line"></span><br><span class="line">Component Galley installed successfully:</span><br><span class="line">========================================</span><br><span class="line"></span><br><span class="line">Component IngressGateway installed successfully:</span><br><span class="line">================================================</span><br><span class="line"></span><br><span class="line">Component NodeAgent installed successfully:</span><br><span class="line">===========================================</span><br><span class="line"></span><br><span class="line">Component CertManager installed successfully:</span><br><span class="line">=============================================</span><br><span class="line"></span><br><span class="line">Component PrometheusOperator installed successfully:</span><br><span class="line">====================================================</span><br><span class="line"></span><br><span class="line">Component Base installed successfully:</span><br><span class="line">======================================</span><br></pre></td></tr></table></figure>

<p>查看：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get all -n istio-system </span><br><span class="line">NAME                                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-6b65874977-9nlb8                  1/1     Running   0          10m</span><br><span class="line">pod/istio-citadel-86dcf4c6b-259zj             1/1     Running   0          10m</span><br><span class="line">pod/istio-egressgateway-68f754ccdd-2bwdn      1/1     Running   0          10m</span><br><span class="line">pod/istio-galley-5fc6d6c45b-dmtb4             1/1     Running   0          10m</span><br><span class="line">pod/istio-ingressgateway-6d759478d8-crwg5     1/1     Running   0          10m</span><br><span class="line">pod/istio-pilot-5c4995d687-s8fhk              1/1     Running   0          10m</span><br><span class="line">pod/istio-policy-57b99968f-cfktj              1/1     Running   2          10m</span><br><span class="line">pod/istio-sidecar-injector-746f7c7bbb-lwgwx   1/1     Running   0          10m</span><br><span class="line">pod/istio-telemetry-854d8556d5-hbz4n          1/1     Running   3          10m</span><br><span class="line">pod/istio-tracing-c66d67cd9-z97mc             1/1     Running   0          10m</span><br><span class="line">pod/kiali-8559969566-rqzfs                    1/1     Running   0          10m</span><br><span class="line">pod/prometheus-66c5887c86-44mnk               1/1     Running   0          10m</span><br><span class="line"></span><br><span class="line">NAME                             TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                                                                                                                      AGE</span><br><span class="line">service/grafana                  ClusterIP      10.100.239.106   &lt;none&gt;        3000/TCP                                                                                                                     10m</span><br><span class="line">service/istio-citadel            ClusterIP      10.100.238.18    &lt;none&gt;        8060/TCP,15014/TCP                                                                                                           10m</span><br><span class="line">service/istio-egressgateway      ClusterIP      10.100.59.109    &lt;none&gt;        80/TCP,443/TCP,15443/TCP                                                                                                     10m</span><br><span class="line">service/istio-galley             ClusterIP      10.100.173.148   &lt;none&gt;        443/TCP,15014/TCP,9901/TCP,15019/TCP                                                                                         10m</span><br><span class="line">service/istio-ingressgateway     LoadBalancer   10.100.112.237   &lt;pending&gt;     15020:31993/TCP,80:30903/TCP,443:31072/TCP,15029:32762/TCP,15030:31649/TCP,15031:32552/TCP,15032:32100/TCP,15443:31879/TCP   10m <span class="comment"># 这里是LoadBalancer 的，我这里没有</span></span><br><span class="line">service/istio-pilot              ClusterIP      10.100.205.117   &lt;none&gt;        15010/TCP,15011/TCP,8080/TCP,15014/TCP                                                                                       10m</span><br><span class="line">service/istio-policy             ClusterIP      10.100.127.220   &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP                                                                                                 10m</span><br><span class="line">service/istio-sidecar-injector   ClusterIP      10.100.11.244    &lt;none&gt;        443/TCP                                                                                                                      10m</span><br><span class="line">service/istio-telemetry          ClusterIP      10.100.0.80      &lt;none&gt;        9091/TCP,15004/TCP,15014/TCP,42422/TCP                                                                                       10m</span><br><span class="line">service/jaeger-agent             ClusterIP      None             &lt;none&gt;        5775/UDP,6831/UDP,6832/UDP                                                                                                   10m</span><br><span class="line">service/jaeger-collector         ClusterIP      10.100.63.17     &lt;none&gt;        14267/TCP,14268/TCP,14250/TCP                                                                                                10m</span><br><span class="line">service/jaeger-query             ClusterIP      10.100.235.187   &lt;none&gt;        16686/TCP                                                                                                                    10m</span><br><span class="line">service/kiali                    ClusterIP      10.100.210.211   &lt;none&gt;        20001/TCP                                                                                                                    10m</span><br><span class="line">service/prometheus               ClusterIP      10.100.225.203   &lt;none&gt;        9090/TCP                                                                                                                     10m</span><br><span class="line">service/tracing                  ClusterIP      10.100.31.32     &lt;none&gt;        80/TCP                                                                                                                       10m</span><br><span class="line">service/zipkin                   ClusterIP      10.100.25.11     &lt;none&gt;        9411/TCP                                                                                                                     10m</span><br><span class="line"></span><br><span class="line">NAME                                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/grafana                  1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-citadel            1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-egressgateway      1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-galley             1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-ingressgateway     1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-pilot              1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-policy             1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-sidecar-injector   1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-telemetry          1/1     1            1           10m</span><br><span class="line">deployment.apps/istio-tracing            1/1     1            1           10m</span><br><span class="line">deployment.apps/kiali                    1/1     1            1           10m</span><br><span class="line">deployment.apps/prometheus               1/1     1            1           10m</span><br><span class="line"></span><br><span class="line">NAME                                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/grafana-6b65874977                  1         1         1       10m</span><br><span class="line">replicaset.apps/istio-citadel-86dcf4c6b             1         1         1       10m</span><br><span class="line">replicaset.apps/istio-egressgateway-68f754ccdd      1         1         1       10m</span><br><span class="line">replicaset.apps/istio-galley-5fc6d6c45b             1         1         1       10m</span><br><span class="line">replicaset.apps/istio-ingressgateway-6d759478d8     1         1         1       10m</span><br><span class="line">replicaset.apps/istio-pilot-5c4995d687              1         1         1       10m</span><br><span class="line">replicaset.apps/istio-policy-57b99968f              1         1         1       10m</span><br><span class="line">replicaset.apps/istio-sidecar-injector-746f7c7bbb   1         1         1       10m</span><br><span class="line">replicaset.apps/istio-telemetry-854d8556d5          1         1         1       10m</span><br><span class="line">replicaset.apps/istio-tracing-c66d67cd9             1         1         1       10m</span><br><span class="line">replicaset.apps/kiali-8559969566                    1         1         1       10m</span><br><span class="line">replicaset.apps/prometheus-66c5887c86               1         1         1       10m</span><br><span class="line"></span><br><span class="line">NAME                                                  REFERENCE                    TARGETS         MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">horizontalpodautoscaler.autoscaling/istio-telemetry   Deployment/istio-telemetry   &lt;unknown&gt;/80%   1         5         1          10m</span><br></pre></td></tr></table></figure>

<p>注意，如上安装默认的istio-ingressgateway的Service是LoadBalancer的，我们可以在安装的时候直接更改成NodePort，如下命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ istioctl manifest apply --<span class="built_in">set</span> profile=demo --<span class="built_in">set</span> values.gateways.istio-ingressgateway.type=NodePort</span><br></pre></td></tr></table></figure>



<h3 id="验证安装"><a href="#验证安装" class="headerlink" title="验证安装"></a>验证安装</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 生成demo profile的manifest文件：</span><br><span class="line">$ istioctl manifest generate --set profile=demo &gt; generate-manifest-istio.yaml</span><br><span class="line"></span><br><span class="line"># 查看帮助</span><br><span class="line">$ istioctl verify-install --help</span><br><span class="line"></span><br><span class="line">44verify-install verifies Istio installation status against the installation file</span><br><span class="line">44you specified when you installed Istio. It loops through all the installation</span><br><span class="line">44resources defined in your installation file and reports whether all of them are</span><br><span class="line">44in ready status. It will report failure when any of them are not ready.</span><br><span class="line"></span><br><span class="line">44If you do not specify installation file it will perform pre-check for your cluster</span><br><span class="line">44and report whether the cluster is ready for Istio installation.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl verify-install [flags]</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line"></span><br><span class="line">44# Verify that Istio can be freshly installed</span><br><span class="line">44istioctl verify-install</span><br><span class="line">44</span><br><span class="line">44# Verify that the deployment matches the istio-demo profile</span><br><span class="line">44istioctl verify-install -f istio-demo.yaml</span><br><span class="line">44</span><br><span class="line">44# Verify the deployment matches a custom Istio deployment configuration</span><br><span class="line">44istioctl verify-install -f $HOME/istio.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">      --enableVerbose      Enable verbose output (default true)</span><br><span class="line">  -f, --filename strings   Istio YAML installation file.</span><br><span class="line">  -h, --help               help for verify-install</span><br><span class="line">  -R, --recursive          Process the directory used in -f, --filename recursively. Useful when you want to manage related manifests organized within the same directory.</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">$ istioctl verify-install -f generate-manifest-istio.yaml </span><br><span class="line">ClusterRole: istio-reader-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-reader-istio-system.default checked successfully</span><br><span class="line">CustomResourceDefinition: attributemanifests.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: clusterrbacconfigs.rbac.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: destinationrules.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: envoyfilters.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: gateways.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: httpapispecbindings.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: httpapispecs.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: meshpolicies.authentication.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: policies.authentication.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: quotaspecbindings.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: quotaspecs.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: rbacconfigs.rbac.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: rules.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: serviceentries.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: servicerolebindings.rbac.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: serviceroles.rbac.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: virtualservices.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: adapters.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: instances.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: templates.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: handlers.config.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: sidecars.networking.istio.io.default checked successfully</span><br><span class="line">CustomResourceDefinition: authorizationpolicies.security.istio.io.default checked successfully</span><br><span class="line">Namespace: istio-system.default checked successfully</span><br><span class="line">ServiceAccount: istio-reader-service-account.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-citadel-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-citadel-istio-system.default checked successfully</span><br><span class="line">Deployment: istio-citadel.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: istio-citadel.istio-system checked successfully</span><br><span class="line">Service: istio-citadel.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-citadel-service-account.istio-system checked successfully</span><br><span class="line">Deployment: istio-egressgateway.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: istio-egressgateway.istio-system checked successfully</span><br><span class="line">Gateway: istio-multicluster-egressgateway.istio-system checked successfully</span><br><span class="line">VirtualService: istio-multicluster-egressgateway.istio-system checked successfully</span><br><span class="line">EnvoyFilter: istio-multicluster-egressgateway.istio-system checked successfully</span><br><span class="line">DestinationRule: istio-multicluster-destinationrule.istio-system checked successfully</span><br><span class="line">Service: istio-egressgateway.istio-system checked successfully</span><br><span class="line">Role: istio-egressgateway-sds.istio-system checked successfully</span><br><span class="line">RoleBinding: istio-egressgateway-sds.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-egressgateway-service-account.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-galley-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-galley-admin-role-binding-istio-system.default checked successfully</span><br><span class="line">ConfigMap: istio-mesh-galley.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-galley-configuration.istio-system checked successfully</span><br><span class="line">Deployment: istio-galley.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: istio-galley.istio-system checked successfully</span><br><span class="line">Service: istio-galley.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-galley-service-account.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-citadel-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-galley-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-istio-mesh-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-istio-performance-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-istio-service-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-istio-workload-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-mixer-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana-configuration-dashboards-pilot-dashboard.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-grafana.istio-system checked successfully</span><br><span class="line">Deployment: grafana.istio-system checked successfully</span><br><span class="line">Policy: grafana-ports-mtls-disabled.istio-system checked successfully</span><br><span class="line">Service: grafana.istio-system checked successfully</span><br><span class="line">Deployment: istio-ingressgateway.istio-system checked successfully</span><br><span class="line">Gateway: ingressgateway.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: ingressgateway.istio-system checked successfully</span><br><span class="line">Service: istio-ingressgateway.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-ingressgateway-service-account.istio-system checked successfully</span><br><span class="line">Sidecar: default.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-sidecar-injector-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-sidecar-injector-admin-role-binding-istio-system.default checked successfully</span><br><span class="line">ConfigMap: injector-mesh.istio-system checked successfully</span><br><span class="line">Deployment: istio-sidecar-injector.istio-system checked successfully</span><br><span class="line">MutatingWebhookConfiguration: istio-sidecar-injector.default checked successfully</span><br><span class="line">PodDisruptionBudget: istio-sidecar-injector.istio-system checked successfully</span><br><span class="line">Service: istio-sidecar-injector.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-sidecar-injector-service-account.istio-system checked successfully</span><br><span class="line">ConfigMap: istio-sidecar-injector.istio-system checked successfully</span><br><span class="line">ClusterRole: kiali.default checked successfully</span><br><span class="line">ClusterRole: kiali-viewer.default checked successfully</span><br><span class="line">ClusterRoleBinding: kiali.default checked successfully</span><br><span class="line">ConfigMap: kiali.istio-system checked successfully</span><br><span class="line">Secret: kiali.istio-system checked successfully</span><br><span class="line">Deployment: kiali.istio-system checked successfully</span><br><span class="line">Service: kiali.istio-system checked successfully</span><br><span class="line">ServiceAccount: kiali-service-account.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-pilot-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-pilot-istio-system.default checked successfully</span><br><span class="line">ConfigMap: pilot-envoy-config.istio-system checked successfully</span><br><span class="line">ConfigMap: istio.istio-system checked successfully</span><br><span class="line">Deployment: istio-pilot.istio-system checked successfully</span><br><span class="line">MeshPolicy: default.default checked successfully</span><br><span class="line">PodDisruptionBudget: istio-pilot.istio-system checked successfully</span><br><span class="line">Service: istio-pilot.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-pilot-service-account.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-policy.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-policy-admin-role-binding-istio-system.default checked successfully</span><br><span class="line">DestinationRule: istio-policy.istio-system checked successfully</span><br><span class="line">Deployment: istio-policy.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: istio-policy.istio-system checked successfully</span><br><span class="line">Service: istio-policy.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-policy-service-account.istio-system checked successfully</span><br><span class="line">ClusterRole: prometheus-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: prometheus-istio-system.default checked successfully</span><br><span class="line">ConfigMap: prometheus.istio-system checked successfully</span><br><span class="line">Deployment: prometheus.istio-system checked successfully</span><br><span class="line">Service: prometheus.istio-system checked successfully</span><br><span class="line">ServiceAccount: prometheus.istio-system checked successfully</span><br><span class="line">HorizontalPodAutoscaler: istio-telemetry.istio-system checked successfully</span><br><span class="line">ClusterRole: istio-mixer-istio-system.default checked successfully</span><br><span class="line">ClusterRoleBinding: istio-mixer-admin-role-binding-istio-system.default checked successfully</span><br><span class="line">attributemanifest: istioproxy.istio-system checked successfully</span><br><span class="line">attributemanifest: kubernetes.istio-system checked successfully</span><br><span class="line">handler: stdio.istio-system checked successfully</span><br><span class="line">instance: accesslog.istio-system checked successfully</span><br><span class="line">instance: tcpaccesslog.istio-system checked successfully</span><br><span class="line">rule: stdio.istio-system checked successfully</span><br><span class="line">rule: stdiotcp.istio-system checked successfully</span><br><span class="line">instance: requestcount.istio-system checked successfully</span><br><span class="line">instance: requestduration.istio-system checked successfully</span><br><span class="line">instance: requestsize.istio-system checked successfully</span><br><span class="line">instance: responsesize.istio-system checked successfully</span><br><span class="line">instance: tcpbytesent.istio-system checked successfully</span><br><span class="line">instance: tcpbytereceived.istio-system checked successfully</span><br><span class="line">instance: tcpconnectionsopened.istio-system checked successfully</span><br><span class="line">instance: tcpconnectionsclosed.istio-system checked successfully</span><br><span class="line">handler: prometheus.istio-system checked successfully</span><br><span class="line">rule: promhttp.istio-system checked successfully</span><br><span class="line">rule: promtcp.istio-system checked successfully</span><br><span class="line">rule: promtcpconnectionopen.istio-system checked successfully</span><br><span class="line">rule: promtcpconnectionclosed.istio-system checked successfully</span><br><span class="line">handler: kubernetesenv.istio-system checked successfully</span><br><span class="line">rule: kubeattrgenrulerule.istio-system checked successfully</span><br><span class="line">rule: tcpkubeattrgenrulerule.istio-system checked successfully</span><br><span class="line">instance: attributes.istio-system checked successfully</span><br><span class="line">DestinationRule: istio-telemetry.istio-system checked successfully</span><br><span class="line">ConfigMap: telemetry-envoy-config.istio-system checked successfully</span><br><span class="line">Deployment: istio-telemetry.istio-system checked successfully</span><br><span class="line">PodDisruptionBudget: istio-telemetry.istio-system checked successfully</span><br><span class="line">Service: istio-telemetry.istio-system checked successfully</span><br><span class="line">ServiceAccount: istio-mixer-service-account.istio-system checked successfully</span><br><span class="line">Deployment: istio-tracing.istio-system checked successfully</span><br><span class="line">Service: jaeger-query.istio-system checked successfully</span><br><span class="line">Service: jaeger-collector.istio-system checked successfully</span><br><span class="line">Service: jaeger-agent.istio-system checked successfully</span><br><span class="line">Service: zipkin.istio-system checked successfully</span><br><span class="line">Service: tracing.istio-system checked successfully</span><br><span class="line">Checked 23 crds # 23个crd</span><br><span class="line">Checked 9 Istio Deployments # 9个Deployment，只是istio的，不包括Addons的</span><br><span class="line">Istio is installed successfully</span><br></pre></td></tr></table></figure>

<p>查看23个crd：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get crd|grep istio</span><br><span class="line">adapters.config.istio.io                      2020-01-03T09:16:47Z</span><br><span class="line">attributemanifests.config.istio.io            2020-01-03T09:16:47Z</span><br><span class="line">authorizationpolicies.security.istio.io       2020-01-03T09:16:47Z</span><br><span class="line">clusterrbacconfigs.rbac.istio.io              2020-01-03T09:16:47Z</span><br><span class="line">destinationrules.networking.istio.io          2020-01-03T09:16:47Z</span><br><span class="line">envoyfilters.networking.istio.io              2020-01-03T09:16:47Z</span><br><span class="line">gateways.networking.istio.io                  2020-01-03T09:16:47Z</span><br><span class="line">handlers.config.istio.io                      2020-01-03T09:16:47Z</span><br><span class="line">httpapispecbindings.config.istio.io           2020-01-03T09:16:47Z</span><br><span class="line">httpapispecs.config.istio.io                  2020-01-03T09:16:47Z</span><br><span class="line">instances.config.istio.io                     2020-01-03T09:16:47Z</span><br><span class="line">meshpolicies.authentication.istio.io          2020-01-03T09:16:47Z</span><br><span class="line">policies.authentication.istio.io              2020-01-03T09:16:47Z</span><br><span class="line">quotaspecbindings.config.istio.io             2020-01-03T09:16:47Z</span><br><span class="line">quotaspecs.config.istio.io                    2020-01-03T09:16:47Z</span><br><span class="line">rbacconfigs.rbac.istio.io                     2020-01-03T09:16:47Z</span><br><span class="line">rules.config.istio.io                         2020-01-03T09:16:47Z</span><br><span class="line">serviceentries.networking.istio.io            2020-01-03T09:16:47Z</span><br><span class="line">servicerolebindings.rbac.istio.io             2020-01-03T09:16:47Z</span><br><span class="line">serviceroles.rbac.istio.io                    2020-01-03T09:16:47Z</span><br><span class="line">sidecars.networking.istio.io                  2020-01-03T09:16:47Z</span><br><span class="line">templates.config.istio.io                     2020-01-03T09:16:47Z</span><br><span class="line">virtualservices.networking.istio.io           2020-01-03T09:16:47Z</span><br><span class="line"></span><br><span class="line">$ kubectl get crd|grep istio|wc -l</span><br><span class="line">23</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意api版本是不一样的</span></span><br><span class="line">$ kubectl api-versions |grep istio</span><br><span class="line">authentication.istio.io/v1alpha1</span><br><span class="line">config.istio.io/v1alpha2</span><br><span class="line">networking.istio.io/v1alpha3</span><br><span class="line">rbac.istio.io/v1alpha1</span><br><span class="line">security.istio.io/v1beta1</span><br></pre></td></tr></table></figure>

<h2 id="安装实验应用-Weather-forecast"><a href="#安装实验应用-Weather-forecast" class="headerlink" title="安装实验应用 Weather forecast"></a>安装实验应用 Weather forecast</h2><h3 id="项目简介"><a href="#项目简介" class="headerlink" title="项目简介"></a>项目简介</h3><p>Weather Forecast 是一款查询城市的天气信息的应用示例，其展示的数据并不是真实的，只是一些静态的dummy数据，一共包含4个微服务：frontend、advertisement、forecast和recommendation。</p>
<ul>
<li>frontend：前台服务，会调用advertisement和forecast这两个服务，展示整个应用的页面，使用React.js开发而成。</li>
<li>advertisement：广告服务，返回静态的广告图片，使用Golang开发而成。</li>
<li>forecast：天气预报服务，返回相应城市的天气数据，使用Node.js开发而成。</li>
<li>recommendation：推荐服务，根据天气情况向用户推荐穿衣和运动等信息，使用Java开发而成。</li>
</ul>
<p>frontend服务有两个版本。</p>
<ul>
<li>v1版本的界面按钮为绿色。</li>
<li>v2版本的界面按钮为蓝色。</li>
</ul>
<p>forecast服务有两个版本。</p>
<ul>
<li>v1版本直接返回天气信息。</li>
<li>v2版本会请求recommendation服务，获取推荐信息，并结合天气信息一起返回数据。各个服务之 间的调用关系如下图所示。</li>
</ul>
<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/weather-forecast-example.png" alt></p>
<p>项目所需的文件：<a href="https://github.com/cloudnativebooks/cloud-native-istio" target="_blank" rel="noopener">https://github.com/cloudnativebooks/cloud-native-istio</a></p>
<h3 id="部署Weather-Forecast服务"><a href="#部署Weather-Forecast服务" class="headerlink" title="部署Weather Forecast服务"></a>部署Weather Forecast服务</h3><h4 id="注入Sidecar"><a href="#注入Sidecar" class="headerlink" title="注入Sidecar"></a>注入Sidecar</h4><p>要使用Istio的功能，必须在Pod里运行Istio sidecar 代理。可以用两种方式注入：</p>
<ul>
<li><p>通过<code>istioctl</code>命名行手动注入，此时可以修改配置。</p>
</li>
<li><p>通过Kubernetes的admission controller在pod创建的时候自动注入。</p>
</li>
</ul>
<p>都会用到<code>istio-sidecar-injector</code> ConfigMap。</p>
<h5 id="手动注入，通过istioctl"><a href="#手动注入，通过istioctl" class="headerlink" title="手动注入，通过istioctl"></a>手动注入，通过istioctl</h5><p>istioctl kube-inject命令帮助：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ istioctl kube-inject --help</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kube-inject manually injects the Envoy sidecar into Kubernetes</span><br><span class="line">workloads. Unsupported resources are left unmodified so it is safe to</span><br><span class="line">run kube-inject over a single file that contains multiple Service,</span><br><span class="line">ConfigMap, Deployment, etc. definitions for a complex application. It&apos;s</span><br><span class="line">best to do this when the resource is initially created.</span><br><span class="line"></span><br><span class="line">k8s.io/docs/concepts/workloads/pods/pod-overview/#pod-templates is</span><br><span class="line">updated for Job, DaemonSet, ReplicaSet, Pod and Deployment YAML resource</span><br><span class="line">documents. Support for additional pod-based resource types can be</span><br><span class="line">added as necessary.</span><br><span class="line"></span><br><span class="line">The Istio project is continually evolving so the Istio sidecar</span><br><span class="line">configuration may change unannounced. When in doubt re-run istioctl</span><br><span class="line">kube-inject on deployments to get the most up-to-date changes.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  istioctl kube-inject [flags]</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line"></span><br><span class="line"># Update resources on the fly before applying.</span><br><span class="line">kubectl apply -f &lt;(istioctl kube-inject -f &lt;resource.yaml&gt;)</span><br><span class="line"></span><br><span class="line"># Create a persistent version of the deployment with Envoy sidecar</span><br><span class="line"># injected.</span><br><span class="line">istioctl kube-inject -f deployment.yaml -o deployment-injected.yaml</span><br><span class="line"></span><br><span class="line"># Update an existing deployment.</span><br><span class="line">kubectl get deployment -o yaml | istioctl kube-inject -f - | kubectl apply -f -</span><br><span class="line"></span><br><span class="line"># Capture cluster configuration for later use with kube-inject</span><br><span class="line">kubectl -n istio-system get cm istio-sidecar-injector  -o jsonpath=&quot;&#123;.data.config&#125;&quot; &gt; /tmp/inj-template.tmpl</span><br><span class="line">kubectl -n istio-system get cm istio -o jsonpath=&quot;&#123;.data.mesh&#125;&quot; &gt; /tmp/mesh.yaml</span><br><span class="line">kubectl -n istio-system get cm istio-sidecar-injector -o jsonpath=&quot;&#123;.data.values&#125;&quot; &gt; /tmp/values.json</span><br><span class="line"># Use kube-inject based on captured configuration</span><br><span class="line">istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml \</span><br><span class="line">4--injectConfigFile /tmp/inj-template.tmpl \</span><br><span class="line">4--meshConfigFile /tmp/mesh.yaml \</span><br><span class="line">4--valuesFile /tmp/values.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -f, --filename string              Input Kubernetes resource filename</span><br><span class="line">  -h, --help                         help for kube-inject</span><br><span class="line">      --injectConfigFile string      injection configuration filename. Cannot be used with --injectConfigMapName</span><br><span class="line">      --injectConfigMapName string   ConfigMap name for Istio sidecar injection, key should be &quot;config&quot;. (default &quot;istio-sidecar-injector&quot;)</span><br><span class="line">      --meshConfigFile string        mesh configuration filename. Takes precedence over --meshConfigMapName if set</span><br><span class="line">      --meshConfigMapName string     ConfigMap name for Istio mesh configuration, key should be &quot;mesh&quot; (default &quot;istio&quot;)</span><br><span class="line">  -o, --output string                Modified output Kubernetes resource filename</span><br><span class="line">      --valuesFile string            injection values configuration filename.</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br></pre></td></tr></table></figure>

<p>手动注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ istioctl kube-inject -f samples/sleep/sleep.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure>

<p>此时默认使用<code>istio-sidecar-injector</code> ConfigMap，当然也可以将配置导出，修改，然后使用修改后的配置进行注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath=&apos;&#123;.data.config&#125;&apos; &gt; inject-config.yaml</span><br><span class="line">$ kubectl -n istio-system get configmap istio-sidecar-injector -o=jsonpath=&apos;&#123;.data.values&#125;&apos; &gt; inject-values.yaml</span><br><span class="line">$ kubectl -n istio-system get configmap istio -o=jsonpath=&apos;&#123;.data.mesh&#125;&apos; &gt; mesh-config.yaml</span><br></pre></td></tr></table></figure>

<p>使用上面的文件，修改，然后注入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ istioctl kube-inject \</span><br><span class="line">    --injectConfigFile inject-config.yaml \</span><br><span class="line">    --meshConfigFile mesh-config.yaml \</span><br><span class="line">    --valuesFile inject-values.yaml \</span><br><span class="line">    --filename samples/sleep/sleep.yaml \</span><br><span class="line">    | kubectl apply -f -</span><br></pre></td></tr></table></figure>



<h5 id="自动注入"><a href="#自动注入" class="headerlink" title="自动注入"></a>自动注入</h5><p>创建命名空间weather，用于部署weather forecast服务，并打上标签：<code>istio-injection=enabled</code>，让Istio自动注入Sidecar：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create ns weather</span><br><span class="line">$ kubectl label ns weather istio-injection=enabled</span><br></pre></td></tr></table></figure>

<p>源weather-v1.yaml文件位置：cloud-native-istio/install/weather-v1.yaml</p>
<p>修改weather-v1.yaml，如下，主要更改了Deployment的api版本为apps/v1，并添加对应的Selector：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">weather-v1.yaml</span> </span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="comment"># Frontend service</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 修改</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 增加</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">istioweather/frontend:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="comment"># Advertisement service</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">advertisement</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">advertisement</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">advertisement</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3003</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">advertisement</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 修改</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">advertisement-v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">advertisement</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 增加</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">advertisement</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">advertisement</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">advertisement</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">istioweather/advertisement:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3003</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="comment"># Forecast service</span></span><br><span class="line"><span class="comment">##################################################################################################</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">forecast</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">forecast</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">forecast</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3002</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">forecast</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># 修改</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">forecast-v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">forecast</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span> <span class="comment"># 增加</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">forecast</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">forecast</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">forecast</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">istioweather/forecast:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3002</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>这个YAML文件只安装了 frontend、advertisement、forecast这3个服务的 v1版本，不包括它们的v2版本和recommendation服务。</p>
<p>部署：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n weather apply -f weather-v1.yaml</span><br></pre></td></tr></table></figure>

<p>检查部署情况：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n weather get all</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/advertisement-v1-68d74cc5bd-hqwvz   2/2     Running   0          2m13s</span><br><span class="line">pod/forecast-v1-77dcd878bc-jrrpd        2/2     Running   0          2m13s</span><br><span class="line">pod/frontend-v1-75d4648dc6-6l4hx        2/2     Running   0          2m13s</span><br><span class="line"></span><br><span class="line">NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/advertisement   ClusterIP   10.100.210.127   &lt;none&gt;        3003/TCP   2m13s</span><br><span class="line">service/forecast        ClusterIP   10.100.67.78     &lt;none&gt;        3002/TCP   2m13s</span><br><span class="line">service/frontend        ClusterIP   10.100.89.158    &lt;none&gt;        3000/TCP   2m13s</span><br><span class="line"></span><br><span class="line">NAME                               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/advertisement-v1   1/1     1            1           2m13s</span><br><span class="line">deployment.apps/forecast-v1        1/1     1            1           2m13s</span><br><span class="line">deployment.apps/frontend-v1        1/1     1            1           2m13s</span><br><span class="line"></span><br><span class="line">NAME                                          DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/advertisement-v1-68d74cc5bd   1         1         1       2m13s</span><br><span class="line">replicaset.apps/forecast-v1-77dcd878bc        1         1         1       2m13s</span><br><span class="line">replicaset.apps/frontend-v1-75d4648dc6        1         1         1       2m13s</span><br></pre></td></tr></table></figure>

<p>检查pod内是否有Sidecar：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">weather</span> <span class="string">get</span> <span class="string">po</span> <span class="string">frontend-v1-75d4648dc6-6l4hx</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">--export</span></span><br><span class="line"><span class="string">Flag</span> <span class="string">--export</span> <span class="string">has</span> <span class="string">been</span> <span class="string">deprecated,</span> <span class="string">This</span> <span class="string">flag</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">and</span> <span class="string">will</span> <span class="string">be</span> <span class="string">removed</span> <span class="string">in</span> <span class="string">future.</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">security.istio.io/tlsMode:</span> <span class="string">istio</span></span><br><span class="line">    <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">istioweather/frontend:v1</span> <span class="comment"># 主程序：frontend</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3000</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-rsfdn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">proxy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sidecar</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--domain</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--configPath</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--binaryPath</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/usr/local/bin/envoy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--serviceCluster</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">frontend.$(POD_NAMESPACE)</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--drainDuration</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">45s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--parentShutdownDuration</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">1m0s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--discoveryAddress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">istio-pilot.istio-system:15010</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--zipkinAddress</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zipkin.istio-system:9411</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyLogLevel=warning</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyComponentLogLevel=misc:error</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--connectTimeout</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">10s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--proxyAdminPort</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"15000"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--concurrency</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"2"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--controlPlaneAuthPolicy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">NONE</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--dnsRefreshRate</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">300s</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--statusPort</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"15020"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--applicationPorts</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"3000"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--trust-domain=cluster.local</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POD_NAMESPACE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">INSTANCE_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.podIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SERVICE_ACCOUNT</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">spec.serviceAccountName</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">HOST_IP</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_POD_PORTS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">|-</span></span><br><span class="line">        <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;"containerPort":3000,"protocol":"TCP"&#125;</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_CLUSTER_ID</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">Kubernetes</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_POD_NAME</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_CONFIG_NAMESPACE</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">fieldRef:</span></span><br><span class="line">          <span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">          <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">SDS_ENABLED</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">"false"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_INTERCEPTION_MODE</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_INCLUDE_INBOUND_PORTS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">"3000"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_METAJSON_LABELS</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">&#123;"app":"frontend","pod-template-hash":"75d4648dc6","version":"v1"&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_WORKLOAD_NAME</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">frontend-v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_OWNER</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">kubernetes://api/apps/v1/namespaces/weather/deployments/frontend-v1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ISTIO_META_MESH_ID</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">cluster.local</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxyv2:1.4.2</span> <span class="comment">#sidecar istio/proxy</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-proxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">15090</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http-envoy-prom</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">readinessProbe:</span></span><br><span class="line">      <span class="attr">failureThreshold:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">httpGet:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/healthz/ready</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">15020</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">"2"</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">40Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">1337</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/istio/proxy</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/certs/</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">istio-certs</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-rsfdn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">enableServiceLinks:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">initContainers:</span> <span class="comment"># init 容器，用于设置iptables的</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">istio-iptables</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-p</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"15001"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-z</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"15006"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-u</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"1337"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-m</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">REDIRECT</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-i</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-x</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-b</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-d</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"15020"</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">docker.io/istio/proxyv2:1.4.2</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-init</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">50Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">10m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">10Mi</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">NET_ADMIN</span></span><br><span class="line">      <span class="attr">runAsNonRoot:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">terminationMessagePath:</span> <span class="string">/dev/termination-log</span></span><br><span class="line">    <span class="attr">terminationMessagePolicy:</span> <span class="string">File</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">default-token-rsfdn</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k04.test.aws.bj.cn</span></span><br><span class="line">  <span class="attr">priority:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">schedulerName:</span> <span class="string">default-scheduler</span></span><br><span class="line">  <span class="attr">securityContext:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">serviceAccount:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/not-ready</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">node.kubernetes.io/unreachable</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">tolerationSeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default-token-rsfdn</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">default-token-rsfdn</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">emptyDir:</span></span><br><span class="line">      <span class="attr">medium:</span> <span class="string">Memory</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">istio-envoy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">istio-certs</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">      <span class="attr">optional:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">istio.default</span></span><br></pre></td></tr></table></figure>



<h3 id="配置外部访问weather服务的frontend"><a href="#配置外部访问weather服务的frontend" class="headerlink" title="配置外部访问weather服务的frontend"></a>配置外部访问weather服务的frontend</h3><h4 id="使用istio-ingressgateway-80端口"><a href="#使用istio-ingressgateway-80端口" class="headerlink" title="使用istio-ingressgateway 80端口"></a>使用istio-ingressgateway 80端口</h4><p>文件位置：cloud-native-istio/install/weather-gateway.yaml</p>
<p>注意：这个文件有个BUG，apply后无法访问的，错误代码：503，正确的如下：</p>
<figure class="highlight yaml"><figcaption><span>cloud-native-istio/install/weather-gateway.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装完Istio默认已经有了一样的Gateway，名字为：ingressgateway，可以直接使用这个</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">weather-gateway</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"*"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-dr</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">weather</span> <span class="comment"># 源文件缺少了命名空间（不指定默认是default），导致访问是503错误。</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-route</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">weather</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"*"</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">istio-system/weather-gateway</span> <span class="comment"># 指定gateway，如果用系统默认的：istio-system/ingressgateway</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f weather-gateway.yaml</span><br></pre></td></tr></table></figure>

<p>配置istio ingress svc为nodePort，我这里没有Loadbalancer：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">istio-system</span> <span class="string">edit</span> <span class="string">svc</span> <span class="string">istio-ingressgateway</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 修改成NodePort</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>确定ingress gateways 80端口对应的node port：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 默认已经有了80和443端口了，所以直接使用即可。</span></span><br><span class="line">$ kubectl -n istio-system get svc</span><br><span class="line">...</span><br><span class="line">istio-ingressgateway     NodePort    10.100.112.237   &lt;none&gt;        15020:31993/TCP,80:30903/TCP,443:31072/TCP,15029:32762/TCP,15030:31649/TCP,15031:32552/TCP,15032:32100/TCP,15443:31879/TCP   3d23h</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>80端口对应的NodePort是30903，所以，访问：<a href="http://x.x.x.x:30903即可，如下图：" target="_blank" rel="noopener">http://x.x.x.x:30903即可，如下图：</a></p>
<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/frontend-dashboard-err.png" alt></p>
<p>注意：</p>
<p>这里提示“当前advertisement服务不可用”,F12工具查看：提示：“Chrome net::ERR_BLOCKED_BY_CLIENT”，解决方法，将浏览器的广告拦截插件关闭，我这里用的是Adblock Plus，或者不再拦截广告当前IP地址。</p>
<p>正常的如下：</p>
<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/frontend-dashboard-ok.png" alt></p>
<p>查询天气：</p>
<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/search-weather.png" alt></p>
<h4 id="使用istio-ingressgateway-非80端口"><a href="#使用istio-ingressgateway-非80端口" class="headerlink" title="使用istio-ingressgateway 非80端口"></a>使用istio-ingressgateway 非80端口</h4><p>如果使用非80端口，例如8080的istio-ingressgateway，如下：</p>
<figure class="highlight yaml"><figcaption><span>weather-gateway-8080.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">weather-gateway-8080</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">8080</span> <span class="comment"># 使用非80端口</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"*"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-dr-8080</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">weather</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend-route-8080</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">weather</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"*"</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">istio-system/weather-gateway-8080</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">frontend</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">3000</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>

<p>应用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f weather-gateway-8080.yaml</span><br></pre></td></tr></table></figure>

<p>查看istio-ingressgateway的kubernetes service：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n istio-system get svc</span><br><span class="line">NAME                            TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     ...</span><br><span class="line">istio-ingressgateway            NodePort    10.100.112.237   &lt;none&gt;        15020:31993/TCP,80:30903/TCP,443:31072/TCP,15029:32762/TCP,15030:31649/TCP,15031:32552/TCP,15032:32100/TCP,15443:31879/TCP   10d</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我们发现并没有自动配置上我们配置的8080端口，但我们想看看我们配置的Gateway的是否监听了8080端口：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n istio-system get po</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">grafana-6b65874977-wl5ps                  1/1     Running   1          3d20h</span><br><span class="line">istio-citadel-86dcf4c6b-9lws9             1/1     Running   2          3d20h</span><br><span class="line">istio-egressgateway-68f754ccdd-w4zjg      1/1     Running   1          4d20h</span><br><span class="line">istio-galley-5fc6d6c45b-dg729             1/1     Running   1          6d4h</span><br><span class="line">istio-ingressgateway-6d759478d8-gk298     1/1     Running   1          6d4h</span><br><span class="line">istio-pilot-5c4995d687-hv5qs              1/1     Running   1          4d20h</span><br><span class="line">istio-policy-57b99968f-2cpvd              1/1     Running   3          4d20h</span><br><span class="line">istio-sidecar-injector-746f7c7bbb-ckf4l   1/1     Running   2          4d20h</span><br><span class="line">istio-telemetry-854d8556d5-hbz4n          1/1     Running   6          10d</span><br><span class="line">istio-tracing-c66d67cd9-r6g79             1/1     Running   1          3d20h</span><br><span class="line">kiali-8559969566-9887z                    1/1     Running   1          3d20h</span><br><span class="line">prometheus-66c5887c86-44mnk               1/1     Running   1          10d</span><br><span class="line"></span><br><span class="line">$ kubectl -n  istio-system <span class="built_in">exec</span> istio-ingressgateway-6d759478d8-gk298 -- netstat -lnutp</span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class="line">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      20/envoy<span class="comment">#这里         </span></span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      20/envoy            </span><br><span class="line">tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      20/envoy            </span><br><span class="line">tcp        0      0 127.0.0.1:15000         0.0.0.0:*               LISTEN      20/envoy            </span><br><span class="line">tcp6       0      0 :::15020                :::*                    LISTEN      1/pilot-agent</span><br></pre></td></tr></table></figure>

<p>需要我们自己手动创建对应的Service资源：</p>
<figure class="highlight yaml"><figcaption><span>weather-gateway-service-8080.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">istio-ingressgateway-8080</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">istio-ingressgateway-8080</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">istio-ingressgateway</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>

<p>应用，检查并测试：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f weather-gateway-service-8080.yaml</span><br><span class="line">$ kubectl -n istio-system get svc</span><br><span class="line">...</span><br><span class="line">istio-ingressgateway-8080       NodePort    10.100.3.64      &lt;none&gt;        8080:30112/TCP</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 访问测试OK</span></span><br><span class="line">$ curl 10.100.3.64:8080</span><br><span class="line">&lt;!doctype html&gt;&lt;html lang=<span class="string">"en"</span>&gt;&lt;head&gt;&lt;meta charset=<span class="string">"utf-8"</span>/&gt;&lt;link rel=<span class="string">"shortcut icon"</span> href=<span class="string">"/favicon.ico"</span>/&gt;&lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width,initial-scale=1,shrink-to-fit=no"</span>/&gt;&lt;meta name=<span class="string">"theme-color"</span> content=<span class="string">"#000000"</span>/&gt;&lt;link rel=<span class="string">"manifest"</span> href=<span class="string">"/manifest.json"</span>/&gt;&lt;title&gt;天气预报&lt;/title&gt;&lt;link href=<span class="string">"/static/css/2.af985d11.chunk.css"</span> rel=<span class="string">"stylesheet"</span>&gt;&lt;link.....</span><br></pre></td></tr></table></figure>

<p>所以结论：</p>
<p>当我们创建Gateway使用非80/443端口时，需要我们手动的去配置对应的Server资源。</p>
<h2 id="通过Kiali-查看Weather服务调用链"><a href="#通过Kiali-查看Weather服务调用链" class="headerlink" title="通过Kiali 查看Weather服务调用链"></a>通过Kiali 查看Weather服务调用链</h2><p>更改kiali的Service类型为NodePort：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">istio-system</span> <span class="string">edit</span> <span class="string">svc</span> <span class="string">kiali</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span> <span class="comment"># 修改成NodePort</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">istio-system</span> <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">kiali</span>                    <span class="string">NodePort</span>    <span class="number">10.100</span><span class="number">.210</span><span class="number">.211</span>   <span class="string">&lt;none&gt;</span>        <span class="number">20001</span><span class="string">:32514/TCP</span></span><br></pre></td></tr></table></figure>

<p>访问<a href="http://x.x.x.x:32514" target="_blank" rel="noopener">http://x.x.x.x:32514</a> 进入Kiali：</p>
<p>默认用户名和密码可以通过查看Secret：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">istio-system</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">kiali</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">passphrase:</span> <span class="string">YWRtaW4=</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">YWRtaW4=</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kiali</span></span><br><span class="line">    <span class="attr">operator.istio.io/component:</span> <span class="string">Kiali</span></span><br><span class="line">    <span class="attr">operator.istio.io/managed:</span> <span class="string">Reconcile</span></span><br><span class="line">    <span class="attr">operator.istio.io/version:</span> <span class="number">1.4</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">istio</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kiali</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">istio-system</span></span><br><span class="line">  <span class="attr">resourceVersion:</span> <span class="string">"13934"</span></span><br><span class="line">  <span class="attr">selfLink:</span> <span class="string">/api/v1/namespaces/istio-system/secrets/kiali</span></span><br><span class="line">  <span class="attr">uid:</span> <span class="string">cceb2838-f2c6-4273-a8a6-ead10b08cfdd</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">echo</span> <span class="string">-n</span> <span class="string">YWRtaW4=</span> <span class="string">|base64</span> <span class="string">-d</span></span><br><span class="line"><span class="string">admin</span></span><br></pre></td></tr></table></figure>

<p>Kiali默认用户名密码都是：admin</p>
<p><img src="/images/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl/kiali-weather.png" alt></p>
<p>能直接看到调用关系。如果没有显示图，可以再次访问weather或者将kiali右上角的时间选长些。</p>
<blockquote>
<p>来自：云原生服务网格Istio：原理、实践、架构与源码解析书籍，本文只作为读书笔记记录，版权属于原作者。</p>
</blockquote>
<hr>
<blockquote>
<p>本文到这里就结束了，欢迎期待后面的文章。您可以关注下方的公众号二维码，在第一时间查看新文章。</p>
<p><img src="/images/knner/wx.jpg" alt="公众号"></p>
</blockquote>

    </div>

    
    
    
      
        <div class="reward-container">
  <div>如有疏忽错误欢迎在留言区评论指正，如果对您有所帮助欢迎点击下方进行打赏。</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/knner/wechatpay.jpg" alt="Knner.Wang 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/knner/alipay.jpg" alt="Knner.Wang 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Knner.Wang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://knner.wang/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html" title="[服务网格Istio系列]--使用istioctl安装istio 1.4.2">https://knner.wang/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/istio/" rel="tag"># istio</a>
              <a href="/tags/servicemesh/" rel="tag"># servicemesh</a>
              <a href="/tags/kubernetes/" rel="tag"># kubernetes</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2020/01/02/ServiceMesh-Istio-Series--Non-Invasive-Traffic-Managerment-2.html" rel="next" title="[服务网格Istio系列]--非侵入的流量管理-2">
                  <i class="fa fa-chevron-left"></i> [服务网格Istio系列]--非侵入的流量管理-2
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/04/14/upgrade-wsl1-to-wsl2.html" rel="prev" title="升级Windows中Linux子系统WSL1到WSL2">
                  升级Windows中Linux子系统WSL1到WSL2 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境说明"><span class="nav-number">1.</span> <span class="nav-text">环境说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Istio-1-4-2"><span class="nav-number">2.</span> <span class="nav-text">安装Istio 1.4.2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载-istio-1-4-2"><span class="nav-number">2.1.</span> <span class="nav-text">下载 istio 1.4.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#istio内置的profile对比"><span class="nav-number">2.2.</span> <span class="nav-text">istio内置的profile对比</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看demo的profile"><span class="nav-number">2.3.</span> <span class="nav-text">查看demo的profile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用demo-profile安装Istio"><span class="nav-number">2.4.</span> <span class="nav-text">使用demo profile安装Istio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证安装"><span class="nav-number">2.5.</span> <span class="nav-text">验证安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装实验应用-Weather-forecast"><span class="nav-number">3.</span> <span class="nav-text">安装实验应用 Weather forecast</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#项目简介"><span class="nav-number">3.1.</span> <span class="nav-text">项目简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署Weather-Forecast服务"><span class="nav-number">3.2.</span> <span class="nav-text">部署Weather Forecast服务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#注入Sidecar"><span class="nav-number">3.2.1.</span> <span class="nav-text">注入Sidecar</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#手动注入，通过istioctl"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">手动注入，通过istioctl</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#自动注入"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">自动注入</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置外部访问weather服务的frontend"><span class="nav-number">3.3.</span> <span class="nav-text">配置外部访问weather服务的frontend</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用istio-ingressgateway-80端口"><span class="nav-number">3.3.1.</span> <span class="nav-text">使用istio-ingressgateway 80端口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用istio-ingressgateway-非80端口"><span class="nav-number">3.3.2.</span> <span class="nav-text">使用istio-ingressgateway 非80端口</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通过Kiali-查看Weather服务调用链"><span class="nav-number">4.</span> <span class="nav-text">通过Kiali 查看Weather服务调用链</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Knner.Wang"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Knner.Wang</p>
  <div class="site-description" itemprop="description">Knner.Wang's Blog,for sharing IT technology and also my study notes.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wanghkkk" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://hub.docker.com/u/wanghkkk" title="DockerHub &amp;rarr; https:&#x2F;&#x2F;hub.docker.com&#x2F;u&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-docker"></i>DockerHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wanghk@live.cn" title="E-Mail &amp;rarr; mailto:wanghk@live.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备19058691号 </a>
      <img src="/images/knner/ga-icon.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802030660" rel="noopener" target="_blank">11010802030660 </a>
  </div>

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Knner.Wang 版权所有</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
    和<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" rel="noopener"><img width="60" style="display: inline;" src="/images/logos/upyun_logo5.png"></a>提供CDN服务
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  











<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '500px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://knner.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://knner.wang/2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html",
            identifier: "2020/01/07/ServiceMesh-Istio-Series--install-istio-1-4-using-istioctl.html",
            title: "[服务网格Istio系列]--使用istioctl安装istio 1.4.2"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://knner.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    (function() {
      var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        window.addEventListener('load', loadComments, false);
      } else {
        var disqus_scroll = () => {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
          var scrollTop = window.scrollY;

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            window.removeEventListener('scroll', disqus_scroll);
            loadComments();
          }
        };
        window.addEventListener('scroll', disqus_scroll);
      }
    })();
  
</script>

</body>
</html>
