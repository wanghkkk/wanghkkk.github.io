<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="prometheus operator 手动入门实战虽然生产中我们大部分都是通过Helm的方式来安装Prometheus-Operator，但是我们也是需要明白Prometheus Operator的原理，以及其中5个CRD的YAML定义方式，这里我们以手动的方式来安装部署Prometheus Operator以及Prometheus Server、Alertmanager集群，配置我们需要监控的">
<meta name="keywords" content="prometheus">
<meta property="og:type" content="article">
<meta property="og:title" content="Prometheus-Operator 手动入门实战">
<meta property="og:url" content="https:&#x2F;&#x2F;knner.wang&#x2F;2019&#x2F;11&#x2F;20&#x2F;Prometheus-Operator-test.html">
<meta property="og:site_name" content="Knner.Wang&#39;s Blog">
<meta property="og:description" content="prometheus operator 手动入门实战虽然生产中我们大部分都是通过Helm的方式来安装Prometheus-Operator，但是我们也是需要明白Prometheus Operator的原理，以及其中5个CRD的YAML定义方式，这里我们以手动的方式来安装部署Prometheus Operator以及Prometheus Server、Alertmanager集群，配置我们需要监控的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;logos&#x2F;prometheus.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-operator.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-01-config.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;example-app-target.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;cmd-line-flags.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;alertmanager-status.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;alertmanager-ins.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-alerts-rules.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-rules.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-alerts.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;prometheus-alerting.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;alertmanager-alerting.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;email-alerting.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;Prometheus-Operator-test&#x2F;custom-metrics-elements.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;knner&#x2F;wx.jpg">
<meta property="og:updated_time" content="2019-11-20T06:27:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;logos&#x2F;prometheus.jpg">

<link rel="canonical" href="https://knner.wang/2019/11/20/Prometheus-Operator-test.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>Prometheus-Operator 手动入门实战 | Knner.Wang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Knner.Wang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">25</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://knner.wang/2019/11/20/Prometheus-Operator-test.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Knner.Wang">
      <meta itemprop="description" content="Knner.Wang's Blog,for sharing IT technology and also my study notes.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Knner.Wang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Prometheus-Operator 手动入门实战
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-20 14:27:55" itemprop="dateCreated datePublished" datetime="2019-11-20T14:27:55+08:00">2019-11-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus/" itemprop="url" rel="index">
                    <span itemprop="name">prometheus</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/11/20/Prometheus-Operator-test.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/20/Prometheus-Operator-test.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>prometheus operator 手动入门实战</p><p><img src="https://imgs.knner.wang/images/logos/prometheus.jpg" alt></p><p>虽然生产中我们大部分都是通过<a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" target="_blank" rel="noopener">Helm的方式来安装Prometheus-Operator</a>，但是我们也是需要明白Prometheus Operator的原理，以及其中5个CRD的YAML定义方式，这里我们以手动的方式来安装部署Prometheus Operator以及Prometheus Server、Alertmanager集群，配置我们需要监控的对象。</p><p><a href="https://github.com/coreos/prometheus-operator" target="_blank" rel="noopener">Prometheus Operator GitHub</a></p><p>本文采用的环境以及版本：</p><ul>
<li>Kubernetes 1.15.5 + Calico v3.6.5</li>
<li>Prometheus-Operator v0.34.0</li>
</ul><a id="more"></a>





<h2 id="Prometheus-Operator简介"><a href="#Prometheus-Operator简介" class="headerlink" title="Prometheus Operator简介"></a>Prometheus Operator简介</h2><h3 id="Prometheus-Operator-安装后提供如下功能："><a href="#Prometheus-Operator-安装后提供如下功能：" class="headerlink" title="Prometheus Operator 安装后提供如下功能："></a>Prometheus Operator 安装后提供如下功能：</h3><ul>
<li>很容易的在kubernetes集群中特定的Namespace中创建和销毁prometheus实例；</li>
<li>配置简单：使用kubernetes原生的方式（CRD）对prometheus的版本，持久化，数据保留，实例数进行配置；</li>
<li>通过labels来指定生成对目标监控的配置；</li>
</ul>
<p>架构图如下：</p>
<p>Operator 监控Kubernetes集群中自定义资源Prometheus、Alertmanager的变化，部署和管理Prometheus Server以及Alertmanager集群，使其状态以及配置达到用户的期望状态，同时监控k8s集群中自定义资源ServiceMonitor（它是用来指定需要收集Metrics的目标的服务），来生成Prometheus的配置信息。</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-operator.png" alt></p>
<h3 id="Prometheus-Operator-vs-kube-prometheus-vs-community-helm-chart-都是什么？"><a href="#Prometheus-Operator-vs-kube-prometheus-vs-community-helm-chart-都是什么？" class="headerlink" title="Prometheus Operator vs. kube-prometheus vs. community helm chart 都是什么？"></a>Prometheus Operator vs. kube-prometheus vs. community helm chart 都是什么？</h3><ul>
<li>prometheus operator使用kubernetes原生的方式来管理和操作prometheus和alertmanager集群。</li>
<li><a href="https://github.com/coreos/kube-prometheus" target="_blank" rel="noopener">kube-prometheus</a> 联合prometheus operator和一些manifests来帮助监控kubernetes集群本身以及跑在kubernetes上面的应用。</li>
<li><a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" target="_blank" rel="noopener">stable/prometheus-operator</a>  Helm chart 提供简单的功能集来创建kube-prometheus。</li>
</ul>
<h3 id="前提依赖以及兼容性："><a href="#前提依赖以及兼容性：" class="headerlink" title="前提依赖以及兼容性："></a>前提依赖以及兼容性：</h3><p>推荐Kubernetes集群版本在1.8以上。</p>
<p>快速安装Kubernetes测试集群：</p>
<p>兼容的prometheus版本：v1.4.0–v2.10.0，<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/compatibility.md" target="_blank" rel="noopener">参考</a></p>
<p>兼容的alertmanager版本：&gt;= v0.15，<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/compatibility.md" target="_blank" rel="noopener">参考</a></p>
<h3 id="CRD（Custom-Resource-Definitions-自定义资源）"><a href="#CRD（Custom-Resource-Definitions-自定义资源）" class="headerlink" title="CRD（Custom Resource Definitions 自定义资源）"></a>CRD（Custom Resource Definitions 自定义资源）</h3><ul>
<li><code>Prometheus</code>：定义期望的Prometheus实例，同时保证任何时候有期望的Prometheus实例在运行。</li>
<li><code>ServiceMonitor</code>：通过声明式的方式指定哪些服务需要被监控，它自动生成Prometheus 的scrape配置。</li>
<li><code>PodMonitor</code>：通过声明式的方式指定哪些pod需要被监控，它自动生成Prometheus 的scrape配置。</li>
<li><code>PrometheusRule</code>：配置Prometheus rule文件，包括recording rules和alerting，它能够自动被Prometheus加载。</li>
<li><code>Alertmanager</code>：定义期望的Alertmanager实例，同时保证任何时候有期望的Alertmanager实例在运行，对于指定多台Alertmanager，prometheus operator会自动将它们配置成集群。</li>
</ul>
<h2 id="安装prometheus-operator"><a href="#安装prometheus-operator" class="headerlink" title="安装prometheus-operator"></a>安装prometheus-operator</h2><p>下载prometheus-operator YAML文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget -c <span class="string">"https://github.com/coreos/prometheus-operator/raw/master/bundle.yaml"</span></span><br></pre></td></tr></table></figure>

<p>更改bundel.yaml 文件中的image地址，默认是使用quay.io的镜像，这里修改成quay.azk8s.cn的地址，可以快速的下载镜像，同时更改默认的namespace为prometheus</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sed -i <span class="string">'s#quay.io#quay.azk8s.cn#g'</span> bundle.yaml</span><br><span class="line">$ sed -i <span class="string">'s#namespace: default#namespace: prometheus#g'</span> bundle.yaml</span><br></pre></td></tr></table></figure>

<p>更改后的显示如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--kubelet-service=kube-system/kubelet</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--logtostderr=true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--config-reloader-image=quay.azk8s.cn/coreos/configmap-reload:v0.0.1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">--prometheus-config-reloader=quay.azk8s.cn/coreos/prometheus-config-reloader:v0.34.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/coreos/prometheus-operator:v0.34.0</span></span><br></pre></td></tr></table></figure>

<p>安装prometheus-operator 到prometheus namespace中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create ns prometheus</span><br><span class="line">namespace/prometheus created</span><br><span class="line">$ kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   4d6h</span><br><span class="line">kube-node-lease   Active   4d6h</span><br><span class="line">kube-public       Active   4d6h</span><br><span class="line">kube-system       Active   4d6h</span><br><span class="line">prometheus        Active   7s</span><br><span class="line">$ kubectl apply -f bundle.yaml</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus-operator configured</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus-operator unchanged</span><br><span class="line">deployment.apps/prometheus-operator created</span><br><span class="line">serviceaccount/prometheus-operator created</span><br><span class="line">service/prometheus-operator created</span><br></pre></td></tr></table></figure>

<p>检查安装状态：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus get all</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/prometheus-operator-5748cc95dd-ssn7s   1/1     Running   0          2m45s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/prometheus-operator   ClusterIP   None         &lt;none&gt;        8080/TCP   2m46s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/prometheus-operator   1/1     1            1           2m46s</span><br><span class="line"></span><br><span class="line">NAME                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/prometheus-operator-5748cc95dd   1         1         1       2m46s</span><br></pre></td></tr></table></figure>

<p>查看prometheus operator的启动参数，以及命令帮助：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进入prometheus operator容器内：</span></span><br><span class="line">$ kubectl -n prometheus <span class="built_in">exec</span> -it prometheus-operator-5748cc95dd-ssn7s -- sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看operator启动参数：</span></span><br><span class="line">$ ps -ef|more</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 nobody    0:04 /bin/operator --kubelet-service=kube-system/kubelet --logtostderr=<span class="literal">true</span> --config-reloader-image=quay.azk8s.cn/coreos/configmap-reload:v0.0.1 --prometheus-config-reloader=quay.azk8s.cn/coreos/prometheus-config-reloader:v0.34.0</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查看operator的命令帮助：</span></span><br><span class="line">$ operator --<span class="built_in">help</span></span><br><span class="line">Usage of operator:</span><br><span class="line">  -alertmanager-default-base-image string</span><br><span class="line">    	Alertmanager default base image (default <span class="string">"quay.io/prometheus/alertmanager"</span>)</span><br><span class="line">  -alertmanager-instance-namespaces value</span><br><span class="line">    	Namespaces <span class="built_in">where</span> Alertmanager custom resources and corresponding StatefulSets are watched/created. If <span class="built_in">set</span> this takes precedence over --namespaces or --deny-namespaces <span class="keyword">for</span> Alertmanager custom resources.</span><br><span class="line">  -alertmanager-instance-selector string</span><br><span class="line">    	Label selector to filter AlertManager CRDs to manage</span><br><span class="line">  -alsologtostderr</span><br><span class="line">    	<span class="built_in">log</span> to standard error as well as files</span><br><span class="line">  -apiserver string</span><br><span class="line">    	API Server addr, e.g. <span class="string">' - NOT RECOMMENDED FOR PRODUCTION - http://127.0.0.1:8080'</span>. Omit parameter to run <span class="keyword">in</span> on-cluster mode and utilize the service account token.</span><br><span class="line">  -ca-file string</span><br><span class="line">    	- NOT RECOMMENDED FOR PRODUCTION - Path to TLS CA file.</span><br><span class="line">  -cert-file string</span><br><span class="line">    	 - NOT RECOMMENDED FOR PRODUCTION - Path to public TLS certificate file.</span><br><span class="line">  -config-reloader-cpu string</span><br><span class="line">    	Config Reloader CPU. Value <span class="string">"0"</span> disables it and causes no <span class="built_in">limit</span> to be configured. (default <span class="string">"100m"</span>)</span><br><span class="line">  -config-reloader-image string</span><br><span class="line">    	Reload Image (default <span class="string">"quay.io/coreos/configmap-reload:v0.0.1"</span>)</span><br><span class="line">  -config-reloader-memory string</span><br><span class="line">    	Config Reloader Memory. Value <span class="string">"0"</span> disables it and causes no <span class="built_in">limit</span> to be configured. (default <span class="string">"25Mi"</span>)</span><br><span class="line">  -crd-kinds value</span><br><span class="line">    	 - EXPERIMENTAL (could be removed <span class="keyword">in</span> future releases) - customize CRD kind names</span><br><span class="line">  -deny-namespaces value</span><br><span class="line">    	Namespaces not to scope the interaction of the Prometheus Operator (deny list). This is mutually exclusive with --namespaces.</span><br><span class="line">  -key-file string</span><br><span class="line">    	- NOT RECOMMENDED FOR PRODUCTION - Path to private TLS certificate file.</span><br><span class="line">  -kubelet-service string</span><br><span class="line">    	Service/Endpoints object to write kubelets into <span class="keyword">in</span> format <span class="string">"namespace/name"</span></span><br><span class="line">  -labels value</span><br><span class="line">    	Labels to be add to all resources created by the operator</span><br><span class="line">  -localhost string</span><br><span class="line">    	EXPERIMENTAL (could be removed <span class="keyword">in</span> future releases) - Host used to communicate between <span class="built_in">local</span> services on a pod. Fixes issues <span class="built_in">where</span> localhost resolves incorrectly. (default <span class="string">"localhost"</span>)</span><br><span class="line">  -<span class="built_in">log</span>-format string</span><br><span class="line">    	Log format to use. Possible values: logfmt, json (default <span class="string">"logfmt"</span>)</span><br><span class="line">  -<span class="built_in">log</span>-level string</span><br><span class="line">    	Log level to use. Possible values: all, debug, info, warn, error, none (default <span class="string">"info"</span>)</span><br><span class="line">  -log_backtrace_at value</span><br><span class="line">    	when logging hits line file:N, emit a stack trace</span><br><span class="line">  -log_dir string</span><br><span class="line">    	If non-empty, write <span class="built_in">log</span> files <span class="keyword">in</span> this directory</span><br><span class="line">  -log_file string</span><br><span class="line">    	If non-empty, use this <span class="built_in">log</span> file</span><br><span class="line">  -log_file_max_size uint</span><br><span class="line">    	Defines the maximum size a <span class="built_in">log</span> file can grow to. Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)</span><br><span class="line">  -logtostderr</span><br><span class="line">    	<span class="built_in">log</span> to standard error instead of files (default <span class="literal">true</span>)</span><br><span class="line">  -manage-crds</span><br><span class="line">    	Manage all CRDs with the Prometheus Operator. (default <span class="literal">true</span>)</span><br><span class="line">  -namespaces value</span><br><span class="line">    	Namespaces to scope the interaction of the Prometheus Operator and the apiserver (allow list). This is mutually exclusive with --deny-namespaces.</span><br><span class="line">  -prometheus-config-reloader string</span><br><span class="line">    	Prometheus config reloader image (default <span class="string">"quay.io/coreos/prometheus-config-reloader:v0.34.0"</span>)</span><br><span class="line">  -prometheus-default-base-image string</span><br><span class="line">    	Prometheus default base image (default <span class="string">"quay.io/prometheus/prometheus"</span>)</span><br><span class="line">  -prometheus-instance-namespaces value</span><br><span class="line">    	Namespaces <span class="built_in">where</span> Prometheus custom resources and corresponding Secrets, Configmaps and StatefulSets are watched/created. If <span class="built_in">set</span> this takes precedence over --namespaces or --deny-namespaces <span class="keyword">for</span> Prometheus custom resources.</span><br><span class="line">  -prometheus-instance-selector string</span><br><span class="line">    	Label selector to filter Prometheus CRDs to manage</span><br><span class="line">  -skip_headers</span><br><span class="line">    	If <span class="literal">true</span>, avoid header prefixes <span class="keyword">in</span> the <span class="built_in">log</span> messages</span><br><span class="line">  -skip_log_headers</span><br><span class="line">    	If <span class="literal">true</span>, avoid headers when opening <span class="built_in">log</span> files</span><br><span class="line">  -stderrthreshold value</span><br><span class="line">    	logs at or above this threshold go to stderr (default 2)</span><br><span class="line">  -thanos-default-base-image string</span><br><span class="line">    	Thanos default base image (default <span class="string">"quay.io/thanos/thanos"</span>)</span><br><span class="line">  -tls-insecure</span><br><span class="line">    	- NOT RECOMMENDED FOR PRODUCTION - Don<span class="string">'t verify API server'</span>s CA certificate.</span><br><span class="line">  -v value</span><br><span class="line">    	number <span class="keyword">for</span> the <span class="built_in">log</span> level verbosity</span><br><span class="line">  -vmodule value</span><br><span class="line">    	comma-separated list of pattern=N settings <span class="keyword">for</span> file-filtered logging</span><br><span class="line">  -with-validation</span><br><span class="line">    	Include the validation spec <span class="keyword">in</span> the CRD (default <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>



<h2 id="安装Prometheus-Operator-CRDs"><a href="#安装Prometheus-Operator-CRDs" class="headerlink" title="安装Prometheus Operator CRDs ??"></a>安装Prometheus Operator CRDs ??</h2><p>安装完prometheus operator 我们还需要手动的安装Prometheus-Operator所需的CRD嘛？</p>
<p>至少GitHub上没有写安装，但是如果不需要手动安装对应的CRD，那么是谁安装的呢？这是我的疑问，相信你们也会有；那么我们先检查一下是否已经有了这些CRD呢？</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get crd | grep monitoring.coreos.com</span><br><span class="line">alertmanagers.monitoring.coreos.com           2019-11-16T12:19:01Z</span><br><span class="line">podmonitors.monitoring.coreos.com             2019-11-16T12:19:02Z</span><br><span class="line">prometheuses.monitoring.coreos.com            2019-11-16T12:19:01Z</span><br><span class="line">prometheusrules.monitoring.coreos.com         2019-11-16T12:19:02Z</span><br><span class="line">servicemonitors.monitoring.coreos.com         2019-11-16T12:19:02Z</span><br></pre></td></tr></table></figure>

<p>我们发现这些CRD已经安装上了，那么是谁安装的呢？答案只有一个，那就是Prometheus Operator了，我们来检查一下，首先检查一下安装Operator的yaml文件：bundle.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 其中的ClusterRole，我们发现它是有权限去安装CRD的，而且对应的权限都是*，也就是可以对需要的资源做任何操作。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/component:</span> <span class="string">controller</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/name:</span> <span class="string">prometheus-operator</span></span><br><span class="line">    <span class="attr">app.kubernetes.io/version:</span> <span class="string">v0.34.0</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-operator</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apiextensions.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">customresourcedefinitions</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">monitoring.coreos.com</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alertmanagers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheuses</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheuses/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alertmanagers/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">servicemonitors</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">podmonitors</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">prometheusrules</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">apps</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">statefulsets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">secrets</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'*'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services/finalizers</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">create</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">update</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">delete</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>

<p>检查一下Operator的启动日志：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus logs prometheus-operator-5748cc95dd-wgkhn </span><br><span class="line">ts=2019-11-17T01:21:50.319966698Z <span class="built_in">caller</span>=main.go:199 msg=<span class="string">"Starting Prometheus Operator version '0.34.0'."</span></span><br><span class="line">ts=2019-11-17T01:21:50.324753193Z <span class="built_in">caller</span>=main.go:96 msg=<span class="string">"Staring insecure server on :8080"</span></span><br><span class="line">level=info ts=2019-11-17T01:21:50.417372629Z <span class="built_in">caller</span>=operator.go:441 component=prometheusoperator msg=<span class="string">"connection established"</span> cluster-version=v1.15.5</span><br><span class="line">level=info ts=2019-11-17T01:21:50.417486093Z <span class="built_in">caller</span>=operator.go:219 component=alertmanageroperator msg=<span class="string">"connection established"</span> cluster-version=v1.15.5</span><br><span class="line">level=info ts=2019-11-17T01:21:51.315610123Z <span class="built_in">caller</span>=operator.go:641 component=alertmanageroperator msg=<span class="string">"CRD updated"</span> crd=Alertmanager</span><br><span class="line">level=info ts=2019-11-17T01:21:51.415575543Z <span class="built_in">caller</span>=operator.go:1870 component=prometheusoperator msg=<span class="string">"CRD updated"</span> crd=Prometheus</span><br><span class="line">level=info ts=2019-11-17T01:21:51.427497667Z <span class="built_in">caller</span>=operator.go:1870 component=prometheusoperator msg=<span class="string">"CRD updated"</span> crd=ServiceMonitor</span><br><span class="line">level=info ts=2019-11-17T01:21:51.439926809Z <span class="built_in">caller</span>=operator.go:1870 component=prometheusoperator msg=<span class="string">"CRD updated"</span> crd=PodMonitor</span><br><span class="line">level=info ts=2019-11-17T01:21:51.449866666Z <span class="built_in">caller</span>=operator.go:1870 component=prometheusoperator msg=<span class="string">"CRD updated"</span> crd=PrometheusRule</span><br><span class="line">level=info ts=2019-11-17T01:21:54.415708201Z <span class="built_in">caller</span>=operator.go:235 component=alertmanageroperator msg=<span class="string">"CRD API endpoints ready"</span></span><br><span class="line">level=info ts=2019-11-17T01:21:54.616157837Z <span class="built_in">caller</span>=operator.go:190 component=alertmanageroperator msg=<span class="string">"successfully synced all caches"</span></span><br><span class="line">level=info ts=2019-11-17T01:22:03.528619385Z <span class="built_in">caller</span>=operator.go:457 component=prometheusoperator msg=<span class="string">"CRD API endpoints ready"</span></span><br><span class="line">level=info ts=2019-11-17T01:22:04.330326124Z <span class="built_in">caller</span>=operator.go:387 component=prometheusoperator msg=<span class="string">"successfully synced all caches"</span></span><br></pre></td></tr></table></figure>

<p>我们发现有如下几个CRD被创建了：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">msg=&quot;CRD updated&quot; crd=Alertmanager</span><br><span class="line">msg=&quot;CRD updated&quot; crd=Prometheus</span><br><span class="line">msg=&quot;CRD updated&quot; crd=ServiceMonitor</span><br><span class="line">msg=&quot;CRD updated&quot; crd=PodMonitor</span><br><span class="line">msg=&quot;CRD updated&quot; crd=PrometheusRule</span><br></pre></td></tr></table></figure>

<p>正式我们需要的5个。</p>
<p>我们查看一下Kubernetes中的API：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方式1</span></span><br><span class="line">$ kubectl api-versions </span><br><span class="line">admissionregistration.k8s.io/v1beta1</span><br><span class="line">apiextensions.k8s.io/v1beta1</span><br><span class="line">apiregistration.k8s.io/v1</span><br><span class="line">apiregistration.k8s.io/v1beta1</span><br><span class="line">apps/v1</span><br><span class="line">apps/v1beta1</span><br><span class="line">apps/v1beta2</span><br><span class="line">authentication.k8s.io/v1</span><br><span class="line">authentication.k8s.io/v1beta1</span><br><span class="line">authorization.k8s.io/v1</span><br><span class="line">authorization.k8s.io/v1beta1</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br><span class="line">batch/v1</span><br><span class="line">batch/v1beta1</span><br><span class="line">certificates.k8s.io/v1beta1</span><br><span class="line">coordination.k8s.io/v1</span><br><span class="line">coordination.k8s.io/v1beta1</span><br><span class="line">crd.projectcalico.org/v1</span><br><span class="line">events.k8s.io/v1beta1</span><br><span class="line">extensions/v1beta1</span><br><span class="line">monitoring.coreos.com/v1</span><br><span class="line">networking.k8s.io/v1</span><br><span class="line">networking.k8s.io/v1beta1</span><br><span class="line">node.k8s.io/v1beta1</span><br><span class="line">policy/v1beta1</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line">rbac.authorization.k8s.io/v1beta1</span><br><span class="line">scheduling.k8s.io/v1</span><br><span class="line">scheduling.k8s.io/v1beta1</span><br><span class="line">storage.k8s.io/v1</span><br><span class="line">storage.k8s.io/v1beta1</span><br><span class="line">v1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方式2：</span></span><br><span class="line">$ kubectl get APIService</span><br><span class="line">NAME                                   SERVICE   AVAILABLE   AGE</span><br><span class="line">v1.                                    Local     True        4d20h</span><br><span class="line">v1.apps                                Local     True        4d20h</span><br><span class="line">v1.authentication.k8s.io               Local     True        4d20h</span><br><span class="line">v1.authorization.k8s.io                Local     True        4d20h</span><br><span class="line">v1.autoscaling                         Local     True        4d20h</span><br><span class="line">v1.batch                               Local     True        4d20h</span><br><span class="line">v1.coordination.k8s.io                 Local     True        4d20h</span><br><span class="line">v1.crd.projectcalico.org               Local     True        4d16h</span><br><span class="line">v1.monitoring.coreos.com               Local     True        13h</span><br><span class="line">v1.networking.k8s.io                   Local     True        4d20h</span><br><span class="line">v1.rbac.authorization.k8s.io           Local     True        4d20h</span><br><span class="line">v1.scheduling.k8s.io                   Local     True        4d20h</span><br><span class="line">v1.storage.k8s.io                      Local     True        4d20h</span><br><span class="line">v1beta1.admissionregistration.k8s.io   Local     True        4d20h</span><br><span class="line">v1beta1.apiextensions.k8s.io           Local     True        4d20h</span><br><span class="line">v1beta1.apps                           Local     True        4d20h</span><br><span class="line">v1beta1.authentication.k8s.io          Local     True        4d20h</span><br><span class="line">v1beta1.authorization.k8s.io           Local     True        4d20h</span><br><span class="line">v1beta1.batch                          Local     True        4d20h</span><br><span class="line">v1beta1.certificates.k8s.io            Local     True        4d20h</span><br><span class="line">v1beta1.coordination.k8s.io            Local     True        4d20h</span><br><span class="line">v1beta1.events.k8s.io                  Local     True        4d20h</span><br><span class="line">v1beta1.extensions                     Local     True        4d20h</span><br><span class="line">v1beta1.networking.k8s.io              Local     True        4d20h</span><br><span class="line">v1beta1.node.k8s.io                    Local     True        4d20h</span><br><span class="line">v1beta1.policy                         Local     True        4d20h</span><br><span class="line">v1beta1.rbac.authorization.k8s.io      Local     True        4d20h</span><br><span class="line">v1beta1.scheduling.k8s.io              Local     True        4d20h</span><br><span class="line">v1beta1.storage.k8s.io                 Local     True        4d20h</span><br><span class="line">v1beta2.apps                           Local     True        4d20h</span><br><span class="line">v2beta1.autoscaling                    Local     True        4d20h</span><br><span class="line">v2beta2.autoscaling                    Local     True        4d20h</span><br></pre></td></tr></table></figure>

<p>我们发现有monitoring.coreos.com这个API：v1.monitoring.coreos.com，我们来具体的查看一下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ kubectl get --raw /apis/monitoring.coreos.com/v1 | python -m json.tool</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"apiVersion"</span>: <span class="string">"v1"</span>,</span><br><span class="line">    <span class="attr">"groupVersion"</span>: <span class="string">"monitoring.coreos.com/v1"</span>,</span><br><span class="line">    <span class="attr">"kind"</span>: <span class="string">"APIResourceList"</span>,</span><br><span class="line">    <span class="attr">"resources"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"PodMonitor"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"podmonitors"</span>,</span><br><span class="line">            <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"singularName"</span>: <span class="string">"podmonitor"</span>,</span><br><span class="line">            <span class="attr">"storageVersionHash"</span>: <span class="string">"t6BHpUAzPig="</span>,</span><br><span class="line">            <span class="attr">"verbs"</span>: [</span><br><span class="line">                <span class="string">"delete"</span>,</span><br><span class="line">                <span class="string">"deletecollection"</span>,</span><br><span class="line">                <span class="string">"get"</span>,</span><br><span class="line">                <span class="string">"list"</span>,</span><br><span class="line">                <span class="string">"patch"</span>,</span><br><span class="line">                <span class="string">"create"</span>,</span><br><span class="line">                <span class="string">"update"</span>,</span><br><span class="line">                <span class="string">"watch"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"PrometheusRule"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"prometheusrules"</span>,</span><br><span class="line">            <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"singularName"</span>: <span class="string">"prometheusrule"</span>,</span><br><span class="line">            <span class="attr">"storageVersionHash"</span>: <span class="string">"RSJ8iG+KDOo="</span>,</span><br><span class="line">            <span class="attr">"verbs"</span>: [</span><br><span class="line">                <span class="string">"delete"</span>,</span><br><span class="line">                <span class="string">"deletecollection"</span>,</span><br><span class="line">                <span class="string">"get"</span>,</span><br><span class="line">                <span class="string">"list"</span>,</span><br><span class="line">                <span class="string">"patch"</span>,</span><br><span class="line">                <span class="string">"create"</span>,</span><br><span class="line">                <span class="string">"update"</span>,</span><br><span class="line">                <span class="string">"watch"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"Alertmanager"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"alertmanagers"</span>,</span><br><span class="line">            <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"singularName"</span>: <span class="string">"alertmanager"</span>,</span><br><span class="line">            <span class="attr">"storageVersionHash"</span>: <span class="string">"NshW3zg1K7o="</span>,</span><br><span class="line">            <span class="attr">"verbs"</span>: [</span><br><span class="line">                <span class="string">"delete"</span>,</span><br><span class="line">                <span class="string">"deletecollection"</span>,</span><br><span class="line">                <span class="string">"get"</span>,</span><br><span class="line">                <span class="string">"list"</span>,</span><br><span class="line">                <span class="string">"patch"</span>,</span><br><span class="line">                <span class="string">"create"</span>,</span><br><span class="line">                <span class="string">"update"</span>,</span><br><span class="line">                <span class="string">"watch"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"ServiceMonitor"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"servicemonitors"</span>,</span><br><span class="line">            <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"singularName"</span>: <span class="string">"servicemonitor"</span>,</span><br><span class="line">            <span class="attr">"storageVersionHash"</span>: <span class="string">"JLhPcfa+5xE="</span>,</span><br><span class="line">            <span class="attr">"verbs"</span>: [</span><br><span class="line">                <span class="string">"delete"</span>,</span><br><span class="line">                <span class="string">"deletecollection"</span>,</span><br><span class="line">                <span class="string">"get"</span>,</span><br><span class="line">                <span class="string">"list"</span>,</span><br><span class="line">                <span class="string">"patch"</span>,</span><br><span class="line">                <span class="string">"create"</span>,</span><br><span class="line">                <span class="string">"update"</span>,</span><br><span class="line">                <span class="string">"watch"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"kind"</span>: <span class="string">"Prometheus"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"prometheuses"</span>,</span><br><span class="line">            <span class="attr">"namespaced"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"singularName"</span>: <span class="string">"prometheus"</span>,</span><br><span class="line">            <span class="attr">"storageVersionHash"</span>: <span class="string">"C8naPY4eojU="</span>,</span><br><span class="line">            <span class="attr">"verbs"</span>: [</span><br><span class="line">                <span class="string">"delete"</span>,</span><br><span class="line">                <span class="string">"deletecollection"</span>,</span><br><span class="line">                <span class="string">"get"</span>,</span><br><span class="line">                <span class="string">"list"</span>,</span><br><span class="line">                <span class="string">"patch"</span>,</span><br><span class="line">                <span class="string">"create"</span>,</span><br><span class="line">                <span class="string">"update"</span>,</span><br><span class="line">                <span class="string">"watch"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<div class="note sucess">
            <p>所以呢：在安装完Prometheus-Operator后不需要我们在手动的方式安装所需的CRD了。</p>
          </div>



<p>来看一下GitHub上对应的CRD目录：</p>
<p><a href="https://github.com/coreos/prometheus-operator/tree/master/example/prometheus-operator-crd" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator/tree/master/example/prometheus-operator-crd</a></p>
<div class="note danger">
            <p>注意：再使用Helm的方式安装Operator的时候，可能需要提前的手动安装一下，可以通过下面的方式直接安装，总共5个CRD：<a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator#helm-fails-to-create-crds" target="_blank" rel="noopener">参考</a></p>
          </div>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f https://github.com/coreos/prometheus-operator/raw/master/example/prometheus-operator-crd/servicemonitor.crd.yaml</span><br><span class="line">$ kubectl apply -f https://github.com/coreos/prometheus-operator/raw/master/example/prometheus-operator-crd/prometheusrule.crd.yaml</span><br><span class="line">$ kubectl apply -f https://github.com/coreos/prometheus-operator/raw/master/example/prometheus-operator-crd/prometheus.crd.yaml</span><br><span class="line">$ kubectl apply -f https://github.com/coreos/prometheus-operator/raw/master/example/prometheus-operator-crd/podmonitor.crd.yaml</span><br><span class="line">$ kubectl apply -f https://github.com/coreos/prometheus-operator/raw/master/example/prometheus-operator-crd/alertmanager.crd.yaml</span><br></pre></td></tr></table></figure>



<p>Prometheus Operator 以及对应的CRD都已经安装并且成功启动，下面我们来通过kubernetes原生的方式来创建prometheus，alertmanager实例，以及配置监控对象和规则等。</p>
<h2 id="Prometheus-Operator-实战"><a href="#Prometheus-Operator-实战" class="headerlink" title="Prometheus Operator 实战"></a>Prometheus Operator 实战</h2><blockquote>
<p>参考：</p>
<p><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md</a></p>
</blockquote>
<h3 id="创建Prometheus实例："><a href="#创建Prometheus实例：" class="headerlink" title="创建Prometheus实例："></a>创建Prometheus实例：</h3><p>不知道怎么创建，直接看上面的参考吧，我摘录下来：</p>
<h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><p>Prometheus defines a Prometheus deployment.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>metadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a></td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>spec</td>
<td>Specification of the desired behavior of the Prometheus cluster. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec" target="_blank" rel="noopener">PrometheusSpec</a></td>
<td>true</td>
</tr>
<tr>
<td>status</td>
<td>Most recent observed status of the Prometheus cluster. Read-only. Not included when requesting from the apiserver, only from the Prometheus Operator API itself. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusstatus" target="_blank" rel="noopener">PrometheusStatus</a></td>
<td>false</td>
</tr>
</tbody></table>
<p>发现只有PrometheusSpec是必须的，看下面：</p>
<h4 id="PrometheusSpec"><a href="#PrometheusSpec" class="headerlink" title="PrometheusSpec"></a>PrometheusSpec</h4><p>PrometheusSpec is a specification of the desired behavior of the Prometheus cluster. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>podMetadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a> Metadata Labels and Annotations gets propagated to the prometheus pods.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>serviceMonitorSelector</td>
<td>ServiceMonitors to be selected for target discovery.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>serviceMonitorNamespaceSelector</td>
<td>Namespaces to be selected for ServiceMonitor discovery. If nil, only check own namespace.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>podMonitorSelector</td>
<td><em>Experimental</em> PodMonitors to be selected for target discovery.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>podMonitorNamespaceSelector</td>
<td>Namespaces to be selected for PodMonitor discovery. If nil, only check own namespace.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>version</td>
<td>Version of Prometheus to be deployed.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>tag</td>
<td>Tag of Prometheus container image to be deployed. Defaults to the value of <code>version</code>. Version is ignored if Tag is set.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>sha</td>
<td>SHA of Prometheus container image to be deployed. Defaults to the value of <code>version</code>. Similar to a tag, but the SHA explicitly deploys an immutable container image. Version and Tag are ignored if SHA is set.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>paused</td>
<td>When a Prometheus deployment is paused, no actions except for deletion will be performed on the underlying objects.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>image</td>
<td>Image if specified has precedence over baseImage, tag and sha combinations. Specifying the version is still necessary to ensure the Prometheus Operator knows what version of Prometheus is being configured.</td>
<td>*string</td>
<td>false</td>
</tr>
<tr>
<td>baseImage</td>
<td>Base image to use for a Prometheus deployment.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>imagePullSecrets</td>
<td>An optional list of references to secrets in the same namespace to use for pulling prometheus and alertmanager images from registries see <a href="http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod" target="_blank" rel="noopener">http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod</a></td>
<td>[]<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#localobjectreference-v1-core" target="_blank" rel="noopener">v1.LocalObjectReference</a></td>
<td>false</td>
</tr>
<tr>
<td>replicas</td>
<td>Number of instances to deploy for a Prometheus deployment.</td>
<td>*int32</td>
<td>false</td>
</tr>
<tr>
<td>replicaExternalLabelName</td>
<td>Name of Prometheus external label used to denote replica name. Defaults to the value of <code>prometheus_replica</code>. External label will <em>not</em> be added when value is set to empty string (<code>\&quot;\&quot;</code>).</td>
<td>*string</td>
<td>false</td>
</tr>
<tr>
<td>prometheusExternalLabelName</td>
<td>Name of Prometheus external label used to denote Prometheus instance name. Defaults to the value of <code>prometheus</code>. External label will <em>not</em> be added when value is set to empty string (<code>\&quot;\&quot;</code>).</td>
<td>*string</td>
<td>false</td>
</tr>
<tr>
<td>retention</td>
<td>Time duration Prometheus shall retain data for. Default is ‘24h’, and must match the regular expression `[0-9]+(ms</td>
<td>s</td>
<td>m</td>
</tr>
<tr>
<td>retentionSize</td>
<td>Maximum amount of disk space used by blocks.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>walCompression</td>
<td>Enable compression of the write-ahead log using Snappy. This flag is only available in versions of Prometheus &gt;= 2.11.0.</td>
<td>*bool</td>
<td>false</td>
</tr>
<tr>
<td>logLevel</td>
<td>Log level for Prometheus to be configured with.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>logFormat</td>
<td>Log format for Prometheus to be configured with.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>scrapeInterval</td>
<td>Interval between consecutive scrapes.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>evaluationInterval</td>
<td>Interval between consecutive evaluations.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>rules</td>
<td>/–rules.*/ command-line arguments.</td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#rules" target="_blank" rel="noopener">Rules</a></td>
<td>false</td>
</tr>
<tr>
<td>externalLabels</td>
<td>The labels to add to any time series or alerts when communicating with external systems (federation, remote storage, Alertmanager).</td>
<td>map[string]string</td>
<td>false</td>
</tr>
<tr>
<td>enableAdminAPI</td>
<td>Enable access to prometheus web admin API. Defaults to the value of <code>false</code>. WARNING: Enabling the admin APIs enables mutating endpoints, to delete data, shutdown Prometheus, and more. Enabling this should be done with care and the user is advised to add additional authentication authorization via a proxy to ensure only clients authorized to perform these actions can do so. For more information see <a href="https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/querying/api/#tsdb-admin-apis</a></td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>externalUrl</td>
<td>The external URL the Prometheus instances will be available under. This is necessary to generate correct URLs. This is necessary if Prometheus is not served from root of a DNS name.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>routePrefix</td>
<td>The route prefix Prometheus registers HTTP handlers for. This is useful, if using ExternalURL and a proxy is rewriting HTTP routes of a request, and the actual ExternalURL is still true, but the server serves requests under a different route prefix. For example for use with <code>kubectl proxy</code>.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>query</td>
<td>QuerySpec defines the query command line flags when starting Prometheus.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#queryspec" target="_blank" rel="noopener">QuerySpec</a></td>
<td>false</td>
</tr>
<tr>
<td>storage</td>
<td>Storage spec to specify how storage shall be used.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#storagespec" target="_blank" rel="noopener">StorageSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>volumes</td>
<td>Volumes allows configuration of additional volumes on the output StatefulSet definition. Volumes specified will be appended to other volumes that are generated as a result of StorageSpec objects.</td>
<td>[]v1.Volume</td>
<td>false</td>
</tr>
<tr>
<td>ruleSelector</td>
<td>A selector to select which PrometheusRules to mount for loading alerting rules from. Until (excluding) Prometheus Operator v0.24.0 Prometheus Operator will migrate any legacy rule ConfigMaps to PrometheusRule custom resources selected by RuleSelector. Make sure it does not match any config maps that you do not want to be migrated.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>ruleNamespaceSelector</td>
<td>Namespaces to be selected for PrometheusRules discovery. If unspecified, only the same namespace as the Prometheus object is in is used.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>alerting</td>
<td>Define details regarding alerting.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertingspec" target="_blank" rel="noopener">AlertingSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>resources</td>
<td>Define resources requests and limits for single Pods.</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#resourcerequirements-v1-core" target="_blank" rel="noopener">v1.ResourceRequirements</a></td>
<td>false</td>
</tr>
<tr>
<td>nodeSelector</td>
<td>Define which Nodes the Pods are scheduled on.</td>
<td>map[string]string</td>
<td>false</td>
</tr>
<tr>
<td>serviceAccountName</td>
<td>ServiceAccountName is the name of the ServiceAccount to use to run the Prometheus Pods.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>secrets</td>
<td>Secrets is a list of Secrets in the same namespace as the Prometheus object, which shall be mounted into the Prometheus Pods. The Secrets are mounted into /etc/prometheus/secrets/.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>configMaps</td>
<td>ConfigMaps is a list of ConfigMaps in the same namespace as the Prometheus object, which shall be mounted into the Prometheus Pods. The ConfigMaps are mounted into /etc/prometheus/configmaps/.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>affinity</td>
<td>If specified, the pod’s scheduling constraints.</td>
<td>*v1.Affinity</td>
<td>false</td>
</tr>
<tr>
<td>tolerations</td>
<td>If specified, the pod’s tolerations.</td>
<td>[]v1.Toleration</td>
<td>false</td>
</tr>
<tr>
<td>remoteWrite</td>
<td>If specified, the remote_write spec. This is an experimental feature, it may change in any upcoming release in a breaking way.</td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#remotewritespec" target="_blank" rel="noopener">RemoteWriteSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>remoteRead</td>
<td>If specified, the remote_read spec. This is an experimental feature, it may change in any upcoming release in a breaking way.</td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#remotereadspec" target="_blank" rel="noopener">RemoteReadSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>securityContext</td>
<td>SecurityContext holds pod-level security attributes and common container settings. This defaults to the default PodSecurityContext.</td>
<td>*v1.PodSecurityContext</td>
<td>false</td>
</tr>
<tr>
<td>listenLocal</td>
<td>ListenLocal makes the Prometheus server listen on loopback, so that it does not bind against the Pod IP.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>containers</td>
<td>Containers allows injecting additional containers or modifying operator generated containers. This can be used to allow adding an authentication proxy to a Prometheus pod or to change the behavior of an operator generated container. Containers described here modify an operator generated container if they share the same name and modifications are done via a strategic merge patch. The current container names are: <code>prometheus</code>, <code>prometheus-config-reloader</code>, <code>rules-configmap-reloader</code>, and <code>thanos-sidecar</code>. Overriding containers is entirely outside the scope of what the maintainers will support and by doing so, you accept that this behaviour may break at any time without notice.</td>
<td>[]v1.Container</td>
<td>false</td>
</tr>
<tr>
<td>initContainers</td>
<td>InitContainers allows adding initContainers to the pod definition. Those can be used to e.g. fetch secrets for injection into the Prometheus configuration from external sources. Any errors during the execution of an initContainer will lead to a restart of the Pod. More info: <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/</a> Using initContainers for any use case other then secret fetching is entirely outside the scope of what the maintainers will support and by doing so, you accept that this behaviour may break at any time without notice.</td>
<td>[]v1.Container</td>
<td>false</td>
</tr>
<tr>
<td>additionalScrapeConfigs</td>
<td>AdditionalScrapeConfigs allows specifying a key of a Secret containing additional Prometheus scrape configurations. Scrape configurations specified are appended to the configurations generated by the Prometheus Operator. Job configurations specified must have the form as specified in the official Prometheus documentation: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config</a>. As scrape configs are appended, the user is responsible to make sure it is valid. Note that using this feature may expose the possibility to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible scrape configs are going to break Prometheus after the upgrade.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#secretkeyselector-v1-core" target="_blank" rel="noopener">v1.SecretKeySelector</a></td>
<td>false</td>
</tr>
<tr>
<td>additionalAlertRelabelConfigs</td>
<td>AdditionalAlertRelabelConfigs allows specifying a key of a Secret containing additional Prometheus alert relabel configurations. Alert relabel configurations specified are appended to the configurations generated by the Prometheus Operator. Alert relabel configurations specified must have the form as specified in the official Prometheus documentation: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alert_relabel_configs" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alert_relabel_configs</a>. As alert relabel configs are appended, the user is responsible to make sure it is valid. Note that using this feature may expose the possibility to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible alert relabel configs are going to break Prometheus after the upgrade.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#secretkeyselector-v1-core" target="_blank" rel="noopener">v1.SecretKeySelector</a></td>
<td>false</td>
</tr>
<tr>
<td>additionalAlertManagerConfigs</td>
<td>AdditionalAlertManagerConfigs allows specifying a key of a Secret containing additional Prometheus AlertManager configurations. AlertManager configurations specified are appended to the configurations generated by the Prometheus Operator. Job configurations specified must have the form as specified in the official Prometheus documentation: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#alertmanager_config</a>. As AlertManager configs are appended, the user is responsible to make sure it is valid. Note that using this feature may expose the possibility to break upgrades of Prometheus. It is advised to review Prometheus release notes to ensure that no incompatible AlertManager configs are going to break Prometheus after the upgrade.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#secretkeyselector-v1-core" target="_blank" rel="noopener">v1.SecretKeySelector</a></td>
<td>false</td>
</tr>
<tr>
<td>apiserverConfig</td>
<td>APIServerConfig allows specifying a host and auth methods to access apiserver. If left empty, Prometheus is assumed to run inside of the cluster and will discover API servers automatically and use the pod’s CA certificate and bearer token file at /var/run/secrets/kubernetes.io/serviceaccount/.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#apiserverconfig" target="_blank" rel="noopener">APIServerConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>thanos</td>
<td>Thanos configuration allows configuring various aspects of a Prometheus server in a Thanos environment.\n\nThis section is experimental, it may change significantly without deprecation notice in any release.\n\nThis is experimental and may change significantly without backward compatibility in any release.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#thanosspec" target="_blank" rel="noopener">ThanosSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>priorityClassName</td>
<td>Priority class assigned to the Pods</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>portName</td>
<td>Port name used for the pods and governing service. This defaults to web</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>arbitraryFSAccessThroughSMs</td>
<td>ArbitraryFSAccessThroughSMs configures whether configuration based on a service monitor can access arbitrary files on the file system of the Prometheus container e.g. bearer token files.</td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#arbitraryfsaccessthroughsmsconfig" target="_blank" rel="noopener">ArbitraryFSAccessThroughSMsConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>overrideHonorLabels</td>
<td>OverrideHonorLabels if set to true overrides all user configured honor_labels. If HonorLabels is set in ServiceMonitor or PodMonitor to true, this overrides honor_labels to false.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>overrideHonorTimestamps</td>
<td>OverrideHonorTimestamps allows to globally enforce honoring timestamps in all scrape configs.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>ignoreNamespaceSelectors</td>
<td>IgnoreNamespaceSelectors if set to true will ignore NamespaceSelector settings from the podmonitor and servicemonitor configs, and they will only discover endpoints within their current namespace. Defaults to false.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>enforcedNamespaceLabel</td>
<td>EnforcedNamespaceLabel enforces adding a namespace label of origin for each alert and metric that is user created. The label value will always be the namespace of the object that is being created.</td>
<td>string</td>
<td>false</td>
</tr>
</tbody></table>
<p>我们发现也没有必须要填的，那就先创建一个默认的吧：prometheus.yaml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appley一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus.yaml</span></span><br></pre></td></tr></table></figure>

<p>查看一下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus get all</span><br><span class="line">NAME                                       READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/prometheus-operator-5748cc95dd-wgkhn   1/1     Running             0          31h</span><br><span class="line">pod/prometheus-prometheus-0                0/3     ContainerCreating   0          4m11s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                          TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/prometheus-operated   ClusterIP   None         &lt;none&gt;        9090/TCP   4m11s</span><br><span class="line">service/prometheus-operator   ClusterIP   None         &lt;none&gt;        8080/TCP   31h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/prometheus-operator   1/1     1            1           31h</span><br><span class="line"></span><br><span class="line">NAME                                             DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/prometheus-operator-5748cc95dd   1         1         1       31h</span><br><span class="line"></span><br><span class="line">NAME                                     READY   AGE</span><br><span class="line">statefulset.apps/prometheus-prometheus   0/1     4m11s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们看到operator 创建了一个statefulSet 为prometheus，查看一下对应的pod</span></span><br><span class="line">$ kubectl -n prometheus get po</span><br><span class="line">NAME                                   READY   STATUS              RESTARTS   AGE</span><br><span class="line">prometheus-operator-5748cc95dd-wgkhn   1/1     Running             0          31h</span><br><span class="line">prometheus-prometheus-0                0/3     ContainerCreating   0          3m11s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看一下描述信息</span></span><br><span class="line">$ kubectl -n prometheus describe po prometheus-prometheus-0</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason     Age   From                          Message</span><br><span class="line">  ----    ------     ----  ----                          -------</span><br><span class="line">  Normal  Scheduled  56s   default-scheduler             Successfully assigned prometheus/prometheus-prometheus-0 to k8s03.test.awsbj.cn</span><br><span class="line">  Normal  Pulling    55s   kubelet, k8s03.test.awsbj.cn  Pulling image <span class="string">"quay.io/prometheus/prometheus:v2.7.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 还在拉取镜像，而且版本还是v2.7.1的，截止到目前官方最新版本是：v2.14.0，operator兼容的最高prometheus版本是：v2.10.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 稍等片刻即可：</span></span><br><span class="line">$ kubectl -n prometheus get po</span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">prometheus-operator-5748cc95dd-wgkhn   1/1     Running   0          32h</span><br><span class="line">prometheus-prometheus-0                3/3     Running   1          53m</span><br></pre></td></tr></table></figure>

<p>我们创建prometheus实例的service：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-svc.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appley一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-svc.yaml</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看具体的svc的nodeport</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">prometheus</span> <span class="string">get</span> <span class="string">svc</span></span><br><span class="line"><span class="string">NAME</span>                  <span class="string">TYPE</span>        <span class="string">CLUSTER-IP</span>      <span class="string">EXTERNAL-IP</span>   <span class="string">PORT(S)</span>          <span class="string">AGE</span></span><br><span class="line"><span class="string">prometheus</span>            <span class="string">NodePort</span>    <span class="number">10.100</span><span class="number">.56</span><span class="number">.198</span>   <span class="string">&lt;none&gt;</span>        <span class="number">9090</span><span class="string">:32766/TCP</span>   <span class="string">4s</span></span><br><span class="line"><span class="string">prometheus-operated</span>   <span class="string">ClusterIP</span>   <span class="string">None</span>            <span class="string">&lt;none&gt;</span>        <span class="number">9090</span><span class="string">/TCP</span>         <span class="string">65m</span></span><br><span class="line"><span class="string">prometheus-operator</span>   <span class="string">ClusterIP</span>   <span class="string">None</span>            <span class="string">&lt;none&gt;</span>        <span class="number">8080</span><span class="string">/TCP</span>         <span class="string">32h</span></span><br></pre></td></tr></table></figure>

<p>我们访问测试一下，看看具体的配置文件吧：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-01-config.jpg" alt></p>
<h4 id="指定prometheus-server的版本"><a href="#指定prometheus-server的版本" class="headerlink" title="指定prometheus server的版本"></a>指定prometheus server的版本</h4><p>默认创建的prometheus server版本太低了，我们更换成operator兼容列表中最高的prometheus server版本：</p>
<p>我们注意到在上面的：<a href="#PrometheusSpec">PrometheusSpec</a>跟版本有关的总共有三个：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>version</td>
<td>Version of Prometheus to be deployed. 部署的prometheus server版本</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>tag</td>
<td>Tag of Prometheus container image to be deployed. Defaults to the value of <code>version</code>. Version is ignored if Tag is set. 部署的prometheus server版本，优先级高于version</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>image</td>
<td>Image if specified has precedence over baseImage, tag and sha combinations. Specifying the version is still necessary to ensure the Prometheus Operator knows what version of Prometheus is being configured. 当指定image时优先级高于baseImage，tag 和sha。但是仍然需要指定version来告诉operator是哪个版本的prometheus需要被配置</td>
<td>*string</td>
<td>false</td>
</tr>
</tbody></table>
<p>所以呢：这里我们使用image+version的方式：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-image.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-image.yaml</span></span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>注意：<strong>image中需要指定prometheus的版本v2.10.0*</strong>，否则就会拉取latest的版本;</p><p>这里的version只是告诉operator哪个prometheus版本需要被配置的，对于使用哪个版本是由image指定的。</p><p>version中的版本要和image中的版本一致，否则可能会出现未知的错误。</p>
          </div>

<p>apply后，operator会根据我们定义的声明式yaml文件重新部署prometheus server，稍等片刻我们来验证一下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus get po prometheus-prometheus-0 -o yaml --<span class="built_in">export</span> | grep image</span><br><span class="line">Flag --<span class="built_in">export</span> has been deprecated, This flag is deprecated and will be removed <span class="keyword">in</span> future.</span><br><span class="line">    image: quay.azk8s.cn/prometheus/prometheus:v2.10.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    image: quay.azk8s.cn/coreos/prometheus-config-reloader:v0.34.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    image: quay.azk8s.cn/coreos/configmap-reload:v0.0.1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>我们发现连基础的镜像都是用了我们配置的image的镜像源：quay.azk8s.cn，所以呢，如果使用了自建的docker registry也需要提前拉取好这些镜像。</p><p>因为我们使用的Azure的镜像，它就是quay的镜像，所以默认都已经存在了，所以不需要手动再去拉取的。</p><p>所以推荐使用Azure中国镜像，使用方式请参考：<a href="/2019/11/13/docker-io-gcr-io-k8s-gcr-io-quay-io-Chinese-source.html" title="docker.io gcr.io k8s.gcr.io quay.io 中国区加速">docker.io gcr.io k8s.gcr.io quay.io 中国区加速</a></p>
          </div>

<p>我们继续，我们看到prometheus-prometheus-0 这个statefulSet创建的pod中，另外两个关于重载prometheus配置的pod都已经配置了资源限制，只有prometheus server这个没有配置，显然不符合生产要求。</p>
<h4 id="指定prometheus-server的资源限制："><a href="#指定prometheus-server的资源限制：" class="headerlink" title="指定prometheus server的资源限制："></a>指定prometheus server的资源限制：</h4><p>从上面的<a href="#PrometheusSpec">PrometheusSpec</a>中我们看到有resource字段，内用和原声的kubernetes resource是一样的。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-image-resource.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-image-resource.yaml</span></span><br></pre></td></tr></table></figure>

<p>检查一下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus get po prometheus-prometheus-0 -o yaml --<span class="built_in">export</span></span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - --web.console.templates=/etc/prometheus/consoles</span><br><span class="line">    - --web.console.libraries=/etc/prometheus/console_libraries</span><br><span class="line">    - --config.file=/etc/prometheus/config_out/prometheus.env.yaml</span><br><span class="line">    - --storage.tsdb.path=/prometheus</span><br><span class="line">    - --storage.tsdb.retention.time=24h</span><br><span class="line">    - --web.enable-lifecycle</span><br><span class="line">    - --storage.tsdb.no-lockfile</span><br><span class="line">    - --web.route-prefix=/</span><br><span class="line">    image: quay.azk8s.cn/prometheus/prometheus:v2.10.0</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  ...</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: 500m</span><br><span class="line">        memory: 512Mi</span><br><span class="line">      requests:</span><br><span class="line">        cpu: 200m</span><br><span class="line">        memory: 400Mi</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h4 id="配置prometheus-server的存储以及数据保留期限"><a href="#配置prometheus-server的存储以及数据保留期限" class="headerlink" title="配置prometheus server的存储以及数据保留期限"></a>配置prometheus server的存储以及数据保留期限</h4><p>查看具体的api：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>retention</td>
<td>Time duration Prometheus shall retain data for. Default is ‘24h’, and must match the regular expression `[0-9]+(ms</td>
<td>s</td>
<td>m</td>
</tr>
<tr>
<td>storage</td>
<td>Storage spec to specify how storage shall be used.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#storagespec" target="_blank" rel="noopener">StorageSpec</a></td>
<td>false</td>
</tr>
</tbody></table>
<h5 id="StorageSpec"><a href="#StorageSpec" class="headerlink" title="StorageSpec"></a>StorageSpec</h5><p>StorageSpec defines the configured storage for a group Prometheus servers. If neither <code>emptyDir</code> nor <code>volumeClaimTemplate</code> is specified, then by default an <a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir" target="_blank" rel="noopener">EmptyDir</a> will be used.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>emptyDir</td>
<td>EmptyDirVolumeSource to be used by the Prometheus StatefulSets. If specified, used in place of any volumeClaimTemplate. More info: <a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/volumes/#emptydir</a></td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#emptydirvolumesource-v1-core" target="_blank" rel="noopener">v1.EmptyDirVolumeSource</a></td>
<td>false</td>
</tr>
<tr>
<td>volumeClaimTemplate</td>
<td>A PVC spec to be used by the Prometheus StatefulSets.</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#persistentvolumeclaim-v1-core" target="_blank" rel="noopener">v1.PersistentVolumeClaim</a></td>
<td>false</td>
</tr>
</tbody></table>
<p>volumeClaimTemplate 中和kubernetes statefulSet 中定义的是一样的。</p>
<p><a href="https://github.com/coreos/prometheus-operator/tree/master/example/storage" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">1d</span> <span class="comment"># 保留1天</span></span><br><span class="line">  <span class="attr">storage:</span></span><br><span class="line">    <span class="attr">volumeClaimTemplate:</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">storageClassName:</span> <span class="string">ssd</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">40Gi</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 准备storageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ssd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">gp2</span></span><br></pre></td></tr></table></figure>

<p>由于我这里还没有storageClass的环境，所以不再测试，后期搭建一个Rook-Ceph测试一下。</p>
<h4 id="配置prometheus-server-ingress，并配置basicAuth-用户名密码认证"><a href="#配置prometheus-server-ingress，并配置basicAuth-用户名密码认证" class="headerlink" title="配置prometheus server ingress，并配置basicAuth 用户名密码认证"></a>配置prometheus server ingress，并配置basicAuth 用户名密码认证</h4><p><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/exposing-prometheus-and-alertmanager.md" target="_blank" rel="noopener">Prometheus Operator参考</a></p>
<p><a href="https://kubernetes.github.io/ingress-nginx/examples/auth/basic/" target="_blank" rel="noopener">Nginx Ingress Basic Auth参考</a></p>
<p>由于默认的prometheus dashboard没有认证的，对于生产来说公网访问不安全，所以需要加上认证。</p>
<p>安装htpasswd命令：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo yum install httpd-tools -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看一下htpasswd命令帮助：</span></span><br><span class="line">$ htpasswd --<span class="built_in">help</span></span><br><span class="line">Usage:</span><br><span class="line">4htpasswd [-cimBdpsDv] [-C cost] passwordfile username</span><br><span class="line">4htpasswd -b[cmBdpsDv] [-C cost] passwordfile username password</span><br><span class="line"></span><br><span class="line">4htpasswd -n[imBdps] [-C cost] username</span><br><span class="line">4htpasswd -nb[mBdps] [-C cost] username password</span><br><span class="line"> -c  Create a new file.</span><br><span class="line"> -n  Don<span class="string">'t update file; display results on stdout.</span></span><br><span class="line"><span class="string"> -b  Use the password from the command line rather than prompting for it.</span></span><br><span class="line"><span class="string"> -i  Read password from stdin without verification (for script usage).</span></span><br><span class="line"><span class="string"> -m  Force MD5 encryption of the password (default).</span></span><br><span class="line"><span class="string"> -B  Force bcrypt encryption of the password (very secure).</span></span><br><span class="line"><span class="string"> -C  Set the computing time used for the bcrypt algorithm</span></span><br><span class="line"><span class="string">     (higher is more secure but slower, default: 5, valid: 4 to 17).</span></span><br><span class="line"><span class="string"> -d  Force CRYPT encryption of the password (8 chars max, insecure).</span></span><br><span class="line"><span class="string"> -s  Force SHA encryption of the password (insecure).</span></span><br><span class="line"><span class="string"> -p  Do not encrypt the password (plaintext, insecure).</span></span><br><span class="line"><span class="string"> -D  Delete the specified user.</span></span><br><span class="line"><span class="string"> -v  Verify password for the specified user.</span></span><br><span class="line"><span class="string">On other systems than Windows and NetWare the '</span>-p<span class="string">' flag will probably not work.</span></span><br><span class="line"><span class="string">The SHA algorithm does not use a salt and is less secure than the MD5 algorithm.</span></span><br></pre></td></tr></table></figure>

<p>创建nginx ingress所需的密码文件：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># auth 为创建的文件名，prometheus为用户名，然后输入两次一样的密码</span></span><br><span class="line">$ htpasswd -c auth prometheus</span><br><span class="line">New password: xxx</span><br><span class="line">Re-type new password: xxx</span><br><span class="line">Adding password <span class="keyword">for</span> user prometheus</span><br><span class="line"></span><br><span class="line">$ cat auth </span><br><span class="line">prometheus:<span class="variable">$apr1</span><span class="variable">$JhroPTnp</span><span class="variable">$dzelC968rK0QkCnq1NnrY1</span></span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>注意：文件名必须为auth，否则报503错误，用户名无所谓。</p>
          </div>

<p>创建对应的kubernetes secret：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ $ kubectl -n prometheus create secret generic basic-auth --from-file=auth</span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>注意：secret必须要和ingress在同一个namespace，注意是ingress yaml文件的资源所在的namespace，不是nginx-ingress-controller所在的namespace。否则也会报503错误。</p><p>我这里ingress是准备在prometheus这个namespace下的，所以这个namespace也是在prometheus这个namespace。</p>
          </div>

<p>创建prometheus的ingress，在prometheus这个namespace：我这里没有证书，所以把tls的部分注释掉了。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-ingress.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">"Authentication Required Prometheus"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#tls:</span></span><br><span class="line">  <span class="comment">#  - hosts:</span></span><br><span class="line">  <span class="comment">#    - prometheus.test.aws.test.com</span></span><br><span class="line">  <span class="comment">#    secretName: prometheus.test.aws.test.com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prometheus.test.aws.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">http</span></span><br></pre></td></tr></table></figure>

<p>配置好域名解析访问就会提示输入我们设定的用户名密码。</p>
<h5 id="配置ingress的prometheus-path路径为-prometheus"><a href="#配置ingress的prometheus-path路径为-prometheus" class="headerlink" title="配置ingress的prometheus path路径为 /prometheus"></a>配置ingress的prometheus path路径为 /prometheus</h5><p>有的朋友可能会问到：</p>
<p>这里是直接把域名的/根路径给了prometheus，后期的alertmanager还得需要域名，不太好，建议用prometheus.test.aws.test.com/promethues 访问prometheus，prometheus.test.aws.test.com/alertmanager来访问alertmanager。</p>
<p>要实现这种：配置如下：</p>
<p>首先看一下prometheus的参数：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--web.external-url=&lt;URL&gt;   The URL under which Prometheus is externally reachable (for example, if Prometheus is served via a reverse proxy). Used for generating relative and absolute links back to Prometheus itself. If the URL has a path portion, it will be used to prefix all HTTP endpoints served by Prometheus. If omitted, relevant URL components will be derived automatically.</span><br><span class="line"></span><br><span class="line">--web.route-prefix=&lt;path&gt;  Prefix for the internal routes of web endpoints. Defaults to path of --web.external-url.</span><br></pre></td></tr></table></figure>

<p>直接在<strong>非docker环境</strong>启动测试OK，如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./prometheus --config.file=prometheus.yml --web.enable-lifecycle --web.enable-admin-api --web.route-prefix=<span class="string">"/prometheus"</span> --web.external-url=<span class="string">"http://prometheus.test.aws.test.com/prometheus"</span></span><br></pre></td></tr></table></figure>

<p>测试：发现都加上了我们的 /prometheus 这个path：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://prometheus.test.aws.test.com</span><br><span class="line">&lt;a href=<span class="string">"/prometheus"</span>&gt;Found&lt;/a&gt;.</span><br><span class="line"></span><br><span class="line">$ curl http://prometheus.test.aws.test.com/prometheus</span><br><span class="line">&lt;a href=<span class="string">"/prometheus/"</span>&gt;Moved Permanently&lt;/a&gt;.</span><br><span class="line"></span><br><span class="line">$ curl http://prometheus.test.aws.test.com/prometheus -L</span><br><span class="line">&lt;a href=<span class="string">"/prometheus/graph"</span>&gt;Found&lt;/a&gt;.</span><br></pre></td></tr></table></figure>

<p>那么k8s环境中prometheus-operator如何配置呢？</p>
<p>查看一下：<a href="#PrometheusSpec">PrometheusSpec</a></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>externalUrl</td>
<td>The external URL the Prometheus instances will be available under. This is necessary to generate correct URLs. This is necessary if Prometheus is not served from root of a DNS name.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>routePrefix</td>
<td>The route prefix Prometheus registers HTTP handlers for. This is useful, if using ExternalURL and a proxy is rewriting HTTP routes of a request, and the actual ExternalURL is still true, but the server serves requests under a different route prefix. For example for use with <code>kubectl proxy</code>.</td>
<td>string</td>
<td>false</td>
</tr>
</tbody></table>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-path.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">1d</span></span><br><span class="line">  <span class="attr">externalUrl:</span> <span class="string">http://prometheus.test.aws.microoak.cn/prometheus</span></span><br><span class="line">  <span class="attr">routePrefix:</span> <span class="string">/prometheus</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appley 一下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-path.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 记得把prometheus ingress中的path更换成</span></span><br><span class="line"><span class="attr">path:</span> <span class="string">/prometheus</span></span><br></pre></td></tr></table></figure>

<p>测试一下吧：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># curl -L 表示跟谁301/302.返回正常</span></span><br><span class="line">$ curl -L http://prometheus.test.aws.test.com/prometheus -uprometheus -p </span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">'prometheus'</span>:</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span>&gt;</span><br><span class="line">        &lt;meta name=<span class="string">"robots"</span> content=<span class="string">"noindex,nofollow"</span>&gt;</span><br><span class="line">        &lt;title&gt;Prometheus Time Series Collection and Processing Server&lt;/title&gt;</span><br><span class="line">        &lt;link rel=<span class="string">"shortcut icon"</span> href=<span class="string">"/prometheus/static/img/favicon.ico?v=d20e84d0fb64aff2f62a977adc8cfb656da4e286"</span>&gt;</span><br><span class="line">        &lt;script src=<span class="string">"/prometheus/static/vendor/js/jquery-3.3.1.min.js?v=d20e84d0fb64aff2f62a977adc8cfb656da4e286"</span>&gt;&lt;/script&gt;    </span><br><span class="line">        &lt;script src=<span class="string">"/prometheus/static/vendor/js/popper.min.js?v=d20e84d0fb64aff2f62a977adc8cfb656da4e286"</span>&gt;&lt;/script&gt;</span><br><span class="line">        &lt;script src=<span class="string">"/prometheus/static/vendor/bootstrap-4.3.1/js/bootstrap.min.js?v=d20e84d0fb64aff2f62a977adc8cfb656da4e286"</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>注意：如果你使用的是Helm安装prometheus服务的，或者在k8s上手动安装prometheus，而不是通过prometheus-operator的，需要更改一些参数。</p><p>prometheus-operator只需要配置这两个参数即可，它自动的把下面的都配置好了。</p><p>需要更改如下：</p><ul><li>readinessProbe路径为：/prometheus/-/ready</li><li>livenessProbe路径为：/prometheus/-/healthy</li><li>prometheus sidecar用于发现配置更改重载prometheus的服务的参数：- –webhook-url=<a href="http://127.0.0.1:9090/prometheus/-/reload" target="_blank" rel="noopener">http://127.0.0.1:9090/prometheus/-/reload</a></li><li>如果你的prometheus也收集了本身，需要配置收集的路径为：/prometheus/metircs</li></ul>
          </div>

<p>好了，关于operator的Prometheus资源配置就到这里，如果有其他的配置，建议参考：<a href="#PrometheusSpec">PrometheusSpec</a></p>
<h3 id="ServiceMonitor-配置"><a href="#ServiceMonitor-配置" class="headerlink" title="ServiceMonitor 配置"></a>ServiceMonitor 配置</h3><p><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/user-guides/getting-started.md" target="_blank" rel="noopener">参考</a></p>
<p>我们首先部署一下我们要搜集的目标服务：注意是在default名称空间下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fabxc/instrumented_app</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>检查这个服务：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get svc,po</span><br><span class="line">NAME                  TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/example-app   ClusterIP   10.100.151.33   &lt;none&gt;        8080/TCP   45s</span><br><span class="line">service/kubernetes    ClusterIP   10.100.0.1      &lt;none&gt;        443/TCP    7d2h</span><br><span class="line">service/nginx         ClusterIP   10.100.54.82    &lt;none&gt;        80/TCP     5d23h</span><br><span class="line"></span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/example-app-66db748757-lmtsk   1/1     Running   0          45s</span><br><span class="line">pod/example-app-66db748757-pzc6w   1/1     Running   0          45s</span><br><span class="line">pod/example-app-66db748757-tchgl   1/1     Running   0          45s</span><br><span class="line">pod/nginx-9cb7f8c7d-wk89s          1/1     Running   0          5d23h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看其metrics：</span></span><br><span class="line">$ curl 10.100.151.33:8080/metrics</span><br><span class="line"><span class="comment"># HELP codelab_api_http_requests_in_progress The current number of API HTTP requests in progress.</span></span><br><span class="line"><span class="comment"># TYPE codelab_api_http_requests_in_progress gauge</span></span><br><span class="line">codelab_api_http_requests_in_progress 1</span><br><span class="line"><span class="comment"># HELP codelab_api_request_duration_seconds A histogram of the API HTTP request durations in seconds.</span></span><br><span class="line"><span class="comment"># TYPE codelab_api_request_duration_seconds histogram</span></span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0001"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.00015000000000000001"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.00022500000000000002"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0003375"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.00050625"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.000759375"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0011390624999999999"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0017085937499999998"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0025628906249999996"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.0038443359374999994"</span>&#125; 0</span><br><span class="line">codelab_api_request_duration_seconds_bucket&#123;method=<span class="string">"GET"</span>,path=<span class="string">"/api/bar"</span>,status=<span class="string">"200"</span>,le=<span class="string">"0.00576650390625"</span>&#125; 0</span><br></pre></td></tr></table></figure>

<p>好了，让我们配置ServiceMonitor，来让prometheus搜集吧。</p>
<p>老规矩，先看ServiceMonitor的api吧，我也不知道怎么配置。</p>
<h4 id="ServiceMonitor"><a href="#ServiceMonitor" class="headerlink" title="ServiceMonitor"></a>ServiceMonitor</h4><p>ServiceMonitor defines monitoring for a set of services.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>metadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a></td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>spec</td>
<td>Specification of desired Service selection for target discrovery by Prometheus.</td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#servicemonitorspec" target="_blank" rel="noopener">ServiceMonitorSpec</a></td>
<td>true</td>
</tr>
</tbody></table>
<h4 id="ServiceMonitorSpec"><a href="#ServiceMonitorSpec" class="headerlink" title="ServiceMonitorSpec"></a>ServiceMonitorSpec</h4><p>ServiceMonitorSpec contains specification parameters for a ServiceMonitor.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>jobLabel</td>
<td>The label to use to retrieve the job name from.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>targetLabels</td>
<td>TargetLabels transfers labels on the Kubernetes Service onto the target.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>podTargetLabels</td>
<td>PodTargetLabels transfers labels on the Kubernetes Pod onto the target.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>endpoints</td>
<td>A list of endpoints allowed as part of this ServiceMonitor.</td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#endpoint" target="_blank" rel="noopener">Endpoint</a></td>
<td>true</td>
</tr>
<tr>
<td>selector</td>
<td>Selector to select Endpoints objects.</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#labelselector-v1-meta" target="_blank" rel="noopener">metav1.LabelSelector</a></td>
<td>true</td>
</tr>
<tr>
<td>namespaceSelector</td>
<td>Selector to select which namespaces the Endpoints objects are discovered from.</td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#namespaceselector" target="_blank" rel="noopener">NamespaceSelector</a></td>
<td>false</td>
</tr>
<tr>
<td>sampleLimit</td>
<td>SampleLimit defines per-scrape limit on number of scraped samples that will be accepted.</td>
<td>uint64</td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="Endpoint"><a href="#Endpoint" class="headerlink" title="Endpoint"></a>Endpoint</h4><p>Endpoint defines a scrapeable endpoint serving Prometheus metrics.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>port</td>
<td>Name of the service port this endpoint refers to. Mutually exclusive with targetPort.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>targetPort</td>
<td>Name or number of the target port of the endpoint. Mutually exclusive with port.</td>
<td>*intstr.IntOrString</td>
<td>false</td>
</tr>
<tr>
<td>path</td>
<td>HTTP path to scrape for metrics.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>scheme</td>
<td>HTTP scheme to use for scraping.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>params</td>
<td>Optional HTTP URL parameters</td>
<td>map[string][]string</td>
<td>false</td>
</tr>
<tr>
<td>interval</td>
<td>Interval at which metrics should be scraped</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>scrapeTimeout</td>
<td>Timeout after which the scrape is ended</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>tlsConfig</td>
<td>TLS configuration to use when scraping the endpoint</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#tlsconfig" target="_blank" rel="noopener">TLSConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>bearerTokenFile</td>
<td>File to read bearer token for scraping targets.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>bearerTokenSecret</td>
<td>Secret to mount to read bearer token for scraping targets. The secret needs to be in the same namespace as the service monitor and accessible by the Prometheus Operator.</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#secretkeyselector-v1-core" target="_blank" rel="noopener">v1.SecretKeySelector</a></td>
<td>false</td>
</tr>
<tr>
<td>honorLabels</td>
<td>HonorLabels chooses the metric’s labels on collisions with target labels.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>honorTimestamps</td>
<td>HonorTimestamps controls whether Prometheus respects the timestamps present in scraped data.</td>
<td>*bool</td>
<td>false</td>
</tr>
<tr>
<td>basicAuth</td>
<td>BasicAuth allow an endpoint to authenticate over basic authentication More info: <a href="https://prometheus.io/docs/operating/configuration/#endpoints" target="_blank" rel="noopener">https://prometheus.io/docs/operating/configuration/#endpoints</a></td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#basicauth" target="_blank" rel="noopener">BasicAuth</a></td>
<td>false</td>
</tr>
<tr>
<td>metricRelabelings</td>
<td>MetricRelabelConfigs to apply to samples before ingestion.</td>
<td>[]*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#relabelconfig" target="_blank" rel="noopener">RelabelConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>relabelings</td>
<td>RelabelConfigs to apply to samples before scraping. More info: <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config</a></td>
<td>[]*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#relabelconfig" target="_blank" rel="noopener">RelabelConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>proxyUrl</td>
<td>ProxyURL eg <a href="http://proxyserver:2195/" target="_blank" rel="noopener">http://proxyserver:2195</a> Directs scrapes to proxy through this endpoint.</td>
<td>*string</td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="NamespaceSelector"><a href="#NamespaceSelector" class="headerlink" title="NamespaceSelector"></a>NamespaceSelector</h4><p>NamespaceSelector is a selector for selecting either all namespaces or a list of namespaces.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>any</td>
<td>Boolean describing whether all namespaces are selected in contrast to a list restricting them.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>matchNames</td>
<td>List of namespace names.</td>
<td>[]string</td>
<td>false</td>
</tr>
</tbody></table>
<p>有两个必须要提供的：</p>
<p>ServiceMonitor.spec.endpoints</p>
<p>ServiceMonitor.spec.selector</p>
<p>我们来定义serviceMonitor：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">example-app-ServiceMonitor.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span> <span class="comment"># 我把ServiceMonitor资源放到了prometheus 空间下了</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># 需要配置自身的标签，以便prometheus能够通过标签找到自己</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span> <span class="comment"># 而目标的service在default 空间下，需要指定；如果不指定那么就默认找自己所在的空间</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">example-app</span> <span class="comment"># 需要搜集对象service的labels，通过service的lables找到server对应的endpoint。</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">web</span> <span class="comment"># 需要搜集对象service中对应的端口名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 应用一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">example-app-ServiceMonitor.yaml</span></span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>如果希望ServiceMonitor可以关联任何空间下的标签，可以通过下面的方式定义：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">any:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>如果监控的目标对应中有basicAuth认证的话，需要配置如下：</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ServiceMonitor</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">namespaceSelector:</span></span><br><span class="line">    <span class="attr">matchNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">example-app</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">basicAuth:</span></span><br><span class="line">      <span class="attr">password:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">      <span class="attr">username:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">username</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># basicAuth 关联了目标对象的secret，需要手动创建</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">basic-auth</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">cHJvbWV0aGV1c0AxMjM=</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">cHJvbWV0aGV1cw==</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>
          </div>

<p>检查一下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus get servicemonitors.monitoring.coreos.com </span><br><span class="line">NAME          AGE</span><br><span class="line">example-app   7m58s</span><br></pre></td></tr></table></figure>

<p>OK了，刷新一下prometheus dashboard看一下吧。呀，啥也没有呢，没生效？</p>
<div class="note danger">
            <p>其实是这样的：</p><p>ServiceMonitor定义了目标收集相关的，比如端口啊，哪个service啊等，但是还没有指定是由哪个prometheus去搜集呢？</p><p>Prometheus,Alertmanager,ServiceMonitor等自定义的资源在一个k8s集群中可能都有多个，比如定义了两台prometheus server，并且定义了多个ServiceMonitor，那么哪个prometheus通过哪个ServiceMonitor去搜集呢？是不是？</p>
          </div>

<p>所以还需要更改之前定义的Prometheus自定义资源，因为prometheus server是通过kubernetes_sd_configs自动发现的，所以需要给prometheus server权限去发现：所以呢，首先定义prometheus server所需的RBAC：</p>
<p><a href="https://github.com/coreos/prometheus-operator/tree/master/example/rbac/prometheus" target="_blank" rel="noopener">参考</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget -c <span class="string">"https://github.com/coreos/prometheus-operator/raw/master/example/rbac/prometheus/prometheus-cluster-role-binding.yaml"</span></span><br><span class="line">$ wget -c <span class="string">"https://github.com/coreos/prometheus-operator/raw/master/example/rbac/prometheus/prometheus-cluster-role.yaml"</span></span><br><span class="line">$ wget -c <span class="string">"https://github.com/coreos/prometheus-operator/raw/master/example/rbac/prometheus/prometheus-service-account.yaml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 因为我把prometheus安装到了prometheus空间中，所以需要修改上面的namespace：这两个文件需要修改</span></span><br><span class="line">prometheus-service-account.yaml 和 prometheus-cluster-role-binding.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后appley一下：</span></span><br><span class="line">$ kubectl apply -f ./</span><br></pre></td></tr></table></figure>

<p>serviceAccount 配置OK了，prometheus怎么用呢？以及怎么选择对应的serviceMonitor呢？当然是通过强大的labels选择器了啊：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-path.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">1d</span></span><br><span class="line">  <span class="attr">externalUrl:</span> <span class="string">http://prometheus.test.aws.microoak.cn/prometheus</span></span><br><span class="line">  <span class="attr">routePrefix:</span> <span class="string">/prometheus</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span> <span class="comment"># 指定需要serviceAccount</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span> <span class="comment"># 通过label找到具体的serviceMonitor</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次应用一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-path.yaml</span></span><br></pre></td></tr></table></figure>

<p>好了，再次刷新一下prometheus dashboard：</p>
<p>target：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/example-app-target.jpg" alt></p>
<p>UI 上查看具体的prometheus 配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">prometheus/prometheus</span></span><br><span class="line">    <span class="attr">prometheus_replica:</span> <span class="string">prometheus-prometheus-0</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">prometheus_replica</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">labeldrop</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules/prometheus-prometheus-rulefiles-0/*.yaml</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus/example-app/0</span></span><br><span class="line">  <span class="attr">honor_timestamps:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">    <span class="attr">namespaces:</span></span><br><span class="line">      <span class="attr">names:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_label_app]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">example-app</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_endpoint_port_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_endpoint_address_target_kind,</span> <span class="string">__meta_kubernetes_endpoint_address_target_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">Node;(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">node</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_endpoint_address_target_kind,</span> <span class="string">__meta_kubernetes_endpoint_address_target_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">Pod;(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">namespace</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">pod</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">    <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">job</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">(.*)</span></span><br><span class="line">    <span class="attr">target_label:</span> <span class="string">endpoint</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">replace</span></span><br></pre></td></tr></table></figure>

<p>command-line flags 截图：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/cmd-line-flags.png" alt></p>
<h3 id="创建Alertmanager实例："><a href="#创建Alertmanager实例：" class="headerlink" title="创建Alertmanager实例："></a>创建Alertmanager实例：</h3><p>老规矩先看其api：</p>
<h4 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h4><p>Alertmanager describes an Alertmanager cluster.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>metadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a></td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>spec</td>
<td>Specification of the desired behavior of the Alertmanager cluster. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerspec" target="_blank" rel="noopener">AlertmanagerSpec</a></td>
<td>true</td>
</tr>
<tr>
<td>status</td>
<td>Most recent observed status of the Alertmanager cluster. Read-only. Not included when requesting from the apiserver, only from the Prometheus Operator API itself. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerstatus" target="_blank" rel="noopener">AlertmanagerStatus</a></td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="AlertmanagerSpec"><a href="#AlertmanagerSpec" class="headerlink" title="AlertmanagerSpec"></a>AlertmanagerSpec</h4><p>AlertmanagerSpec is a specification of the desired behavior of the Alertmanager cluster. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</a></p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>podMetadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a> Metadata Labels and Annotations gets propagated to the prometheus pods.</td>
<td>*<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>image</td>
<td>Image if specified has precedence over baseImage, tag and sha combinations. Specifying the version is still necessary to ensure the Prometheus Operator knows what version of Alertmanager is being configured.</td>
<td>*string</td>
<td>false</td>
</tr>
<tr>
<td>version</td>
<td>Version the cluster should be on.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>tag</td>
<td>Tag of Alertmanager container image to be deployed. Defaults to the value of <code>version</code>. Version is ignored if Tag is set.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>sha</td>
<td>SHA of Alertmanager container image to be deployed. Defaults to the value of <code>version</code>. Similar to a tag, but the SHA explicitly deploys an immutable container image. Version and Tag are ignored if SHA is set.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>baseImage</td>
<td>Base image that is used to deploy pods, without tag.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>imagePullSecrets</td>
<td>An optional list of references to secrets in the same namespace to use for pulling prometheus and alertmanager images from registries see <a href="http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod" target="_blank" rel="noopener">http://kubernetes.io/docs/user-guide/images#specifying-imagepullsecrets-on-a-pod</a></td>
<td>[]<a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#localobjectreference-v1-core" target="_blank" rel="noopener">v1.LocalObjectReference</a></td>
<td>false</td>
</tr>
<tr>
<td>secrets</td>
<td>Secrets is a list of Secrets in the same namespace as the Alertmanager object, which shall be mounted into the Alertmanager Pods. The Secrets are mounted into /etc/alertmanager/secrets/.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>configMaps</td>
<td>ConfigMaps is a list of ConfigMaps in the same namespace as the Alertmanager object, which shall be mounted into the Alertmanager Pods. The ConfigMaps are mounted into /etc/alertmanager/configmaps/.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>configSecret</td>
<td>ConfigSecret is the name of a Kubernetes Secret in the same namespace as the Alertmanager object, which contains configuration for this Alertmanager instance. Defaults to ‘alertmanager-‘ The secret is mounted into /etc/alertmanager/config.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>logLevel</td>
<td>Log level for Alertmanager to be configured with.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>logFormat</td>
<td>Log format for Alertmanager to be configured with.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>replicas</td>
<td>Size is the expected size of the alertmanager cluster. The controller will eventually make the size of the running cluster equal to the expected size.</td>
<td>*int32</td>
<td>false</td>
</tr>
<tr>
<td>retention</td>
<td>Time duration Alertmanager shall retain data for. Default is ‘120h’, and must match the regular expression `[0-9]+(ms</td>
<td>s</td>
<td>m</td>
</tr>
<tr>
<td>storage</td>
<td>Storage is the definition of how storage will be used by the Alertmanager instances.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#storagespec" target="_blank" rel="noopener">StorageSpec</a></td>
<td>false</td>
</tr>
<tr>
<td>volumes</td>
<td>Volumes allows configuration of additional volumes on the output StatefulSet definition. Volumes specified will be appended to other volumes that are generated as a result of StorageSpec objects.</td>
<td>[]v1.Volume</td>
<td>false</td>
</tr>
<tr>
<td>volumeMounts</td>
<td>VolumeMounts allows configuration of additional VolumeMounts on the output StatefulSet definition. VolumeMounts specified will be appended to other VolumeMounts in the alertmanager container, that are generated as a result of StorageSpec objects.</td>
<td>[]v1.VolumeMount</td>
<td>false</td>
</tr>
<tr>
<td>externalUrl</td>
<td>The external URL the Alertmanager instances will be available under. This is necessary to generate correct URLs. This is necessary if Alertmanager is not served from root of a DNS name.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>routePrefix</td>
<td>The route prefix Alertmanager registers HTTP handlers for. This is useful, if using ExternalURL and a proxy is rewriting HTTP routes of a request, and the actual ExternalURL is still true, but the server serves requests under a different route prefix. For example for use with <code>kubectl proxy</code>.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>paused</td>
<td>If set to true all actions on the underlaying managed objects are not goint to be performed, except for delete actions.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>nodeSelector</td>
<td>Define which Nodes the Pods are scheduled on.</td>
<td>map[string]string</td>
<td>false</td>
</tr>
<tr>
<td>resources</td>
<td>Define resources requests and limits for single Pods.</td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#resourcerequirements-v1-core" target="_blank" rel="noopener">v1.ResourceRequirements</a></td>
<td>false</td>
</tr>
<tr>
<td>affinity</td>
<td>If specified, the pod’s scheduling constraints.</td>
<td>*v1.Affinity</td>
<td>false</td>
</tr>
<tr>
<td>tolerations</td>
<td>If specified, the pod’s tolerations.</td>
<td>[]v1.Toleration</td>
<td>false</td>
</tr>
<tr>
<td>securityContext</td>
<td>SecurityContext holds pod-level security attributes and common container settings. This defaults to the default PodSecurityContext.</td>
<td>*v1.PodSecurityContext</td>
<td>false</td>
</tr>
<tr>
<td>serviceAccountName</td>
<td>ServiceAccountName is the name of the ServiceAccount to use to run the Prometheus Pods.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>listenLocal</td>
<td>ListenLocal makes the Alertmanager server listen on loopback, so that it does not bind against the Pod IP. Note this is only for the Alertmanager UI, not the gossip communication.</td>
<td>bool</td>
<td>false</td>
</tr>
<tr>
<td>containers</td>
<td>Containers allows injecting additional containers. This is meant to allow adding an authentication proxy to an Alertmanager pod.</td>
<td>[]v1.Container</td>
<td>false</td>
</tr>
<tr>
<td>initContainers</td>
<td>InitContainers allows adding initContainers to the pod definition. Those can be used to e.g. fetch secrets for injection into the Alertmanager configuration from external sources. Any errors during the execution of an initContainer will lead to a restart of the Pod. More info: <a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/</a> Using initContainers for any use case other then secret fetching is entirely outside the scope of what the maintainers will support and by doing so, you accept that this behaviour may break at any time without notice.</td>
<td>[]v1.Container</td>
<td>false</td>
</tr>
<tr>
<td>priorityClassName</td>
<td>Priority class assigned to the Pods</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>additionalPeers</td>
<td>AdditionalPeers allows injecting a set of additional Alertmanagers to peer with to form a highly available cluster.</td>
<td>[]string</td>
<td>false</td>
</tr>
<tr>
<td>portName</td>
<td>Port name used for the pods and governing service. This defaults to web</td>
<td>string</td>
<td>false</td>
</tr>
</tbody></table>
<p>好吧，既然没有必须的那就参考上面配置的Prometheus，指定如下配置：</p>
<ul>
<li>replicas为3，创建以3台alertmanager组成的集群</li>
<li>更改image资源为Azure中国的</li>
<li>配置一下resource限制</li>
<li>同时采用类似prometheus 的ingress path为 /alertmanager</li>
<li>配置数据保留期限</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-alertmanager.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Alertmanager</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/alertmanager:v0.17.0</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v0.17.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">24h</span> <span class="comment"># 注意这里最大的单位是h，没有d。</span></span><br><span class="line">  <span class="attr">externalUrl:</span> <span class="string">http://prometheus.test.aws.microoak.cn/alertmanager</span></span><br><span class="line">  <span class="attr">routePrefix:</span> <span class="string">/alertmanager</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply一下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查一下：</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">prometheus</span> <span class="string">get</span> <span class="string">po</span></span><br><span class="line"><span class="string">NAME</span>                                   <span class="string">READY</span>   <span class="string">STATUS</span>              <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">alertmanager-alertmanager-0</span>            <span class="number">0</span><span class="string">/2</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">109s</span></span><br><span class="line"><span class="string">alertmanager-alertmanager-1</span>            <span class="number">0</span><span class="string">/2</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">109s</span></span><br><span class="line"><span class="string">alertmanager-alertmanager-2</span>            <span class="number">0</span><span class="string">/2</span>     <span class="string">ContainerCreating</span>   <span class="number">0</span>          <span class="string">109s</span></span><br><span class="line"><span class="string">prometheus-operator-5748cc95dd-wgkhn</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>             <span class="number">0</span>          <span class="string">2d11h</span></span><br><span class="line"><span class="string">prometheus-prometheus-0</span>                <span class="number">3</span><span class="string">/3</span>     <span class="string">Running</span>             <span class="number">1</span>          <span class="string">3h47m</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现需要创建配置文件：alertmanager-alertmanager 而且是secret</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">prometheus</span> <span class="string">describe</span> <span class="string">po</span> <span class="string">alertmanager-alertmanager-0</span></span><br><span class="line"><span class="attr">Events:</span></span><br><span class="line">  <span class="string">Type</span>     <span class="string">Reason</span>       <span class="string">Age</span>                <span class="string">From</span>                          <span class="string">Message</span></span><br><span class="line">  <span class="string">----</span>     <span class="string">------</span>       <span class="string">----</span>               <span class="string">----</span>                          <span class="string">-------</span></span><br><span class="line">  <span class="string">Normal</span>   <span class="string">Scheduled</span>    <span class="string">97s</span>                <span class="string">default-scheduler</span>             <span class="string">Successfully</span> <span class="string">assigned</span> <span class="string">prometheus/alertmanager-alertmanager-1</span> <span class="string">to</span> <span class="string">k8s03.test.awsbj.cn</span></span><br><span class="line">  <span class="string">Warning</span>  <span class="string">FailedMount</span>  <span class="string">33s</span> <span class="string">(x8</span> <span class="string">over</span> <span class="string">96s)</span>  <span class="string">kubelet,</span> <span class="string">k8s03.test.awsbj.cn</span>  <span class="string">MountVolume.SetUp</span> <span class="string">failed</span> <span class="string">for</span> <span class="string">volume</span> <span class="string">"config-volume"</span> <span class="string">:</span> <span class="string">secret</span> <span class="string">"alertmanager-alertmanager"</span> <span class="string">not</span> <span class="string">found</span></span><br></pre></td></tr></table></figure>

<p>准备alertmanager的配置文件：名为：alertmanager-&lt;Alertmanager&gt;  格式的secret，其中&lt;Alertmanager&gt;为创建Alertmanager资源对象的名称：</p>
<p>这里配置了email以及企业微信的告警：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">alertmanager.yaml</span></span><br><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span></span><br><span class="line">  <span class="comment"># smtp</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">alert@xxx.xx</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">smtphm.qiye.163.com:465</span></span><br><span class="line">  <span class="attr">smtp_hello:</span> <span class="string">alert@xxx.xx</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">alert@xxx.xx</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">xxx</span></span><br><span class="line">  <span class="attr">smtp_require_tls:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># wechat</span></span><br><span class="line">  <span class="attr">wechat_api_secret:</span> <span class="string">PxxxxxxxxxxxxxxxxxxxxSc</span></span><br><span class="line">  <span class="attr">wechat_api_corp_id:</span> <span class="string">wxxxxxxxxxxx7</span></span><br><span class="line"></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">alertname</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">instance</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">1m</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">5m</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'email-receiver'</span></span><br><span class="line">  <span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">receiver:</span> <span class="string">"wechat-receiver"</span></span><br><span class="line">    <span class="attr">match_re:</span></span><br><span class="line">      <span class="attr">job:</span> <span class="string">pushgw|grafana</span></span><br><span class="line"></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'email-receiver'</span></span><br><span class="line">  <span class="attr">email_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">xxx@xxx.xx</span></span><br><span class="line">      <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'wechat-receiver'</span></span><br><span class="line">  <span class="attr">wechat_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">send_resolved:</span> <span class="literal">true</span>  </span><br><span class="line">      <span class="attr">agent_id:</span> <span class="string">1xxxx3</span></span><br><span class="line">      <span class="attr">to_user:</span> <span class="string">'@all'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">inhibit_rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">source_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'critical'</span></span><br><span class="line">    <span class="attr">target_match:</span></span><br><span class="line">      <span class="attr">severity:</span> <span class="string">'warning'</span></span><br><span class="line">    <span class="attr">equal:</span> <span class="string">['alertname',</span> <span class="string">'service'</span><span class="string">,</span> <span class="string">'instance'</span><span class="string">]</span></span><br></pre></td></tr></table></figure>

<p>创建secret，注意是在和Alertmanager所在的namespace，我这里是prometheus：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n prometheus create secret generic alertmanager-alertmanager --from-file=alertmanager.yaml</span><br></pre></td></tr></table></figure>

<p>注意alertmanager的配置文件名称必须是alertmanager.yaml，为啥呢？</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">-n</span> <span class="string">prometheus</span> <span class="string">get</span> <span class="string">statefulsets.apps</span> <span class="string">alertmanager-alertmanager</span> <span class="string">-o</span> <span class="string">yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="string">\......</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--config.file=/etc/alertmanager/config/alertmanager.yaml</span> <span class="comment"># 这里指定的就是alertmanager.yaml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cluster.listen-address=[$(POD_IP)]:9094</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--storage.path=/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--data.retention=24h</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--web.listen-address=:9093</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--web.external-url=http://prometheus.test.aws.microoak.cn/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--web.route-prefix=/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cluster.peer=alertmanager-alertmanager-0.alertmanager-operated.prometheus.svc:9094</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cluster.peer=alertmanager-alertmanager-1.alertmanager-operated.prometheus.svc:9094</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cluster.peer=alertmanager-alertmanager-2.alertmanager-operated.prometheus.svc:9094</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/alertmanager:v0.17.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="string">\......</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/alertmanager/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/alertmanager</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">alertmanager-alertmanager-db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-webhook-url=http://localhost:9093/-/reload</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-volume-dir=/etc/alertmanager/config</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.azk8s.cn/coreos/configmap-reload:v0.0.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">config-reloader</span></span><br><span class="line">       <span class="string">\......</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/alertmanager/config</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">     <span class="string">\......</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">secret:</span> <span class="comment"># secret类型的</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">420</span></span><br><span class="line">          <span class="attr">secretName:</span> <span class="string">alertmanager-alertmanager</span> <span class="comment"># secret的名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">alertmanager-alertmanager-db</span></span><br></pre></td></tr></table></figure>

<p>创建alertmanager的service：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">alertmanager-svc.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">alertmanager:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">alertmanager-svc.yaml</span></span><br></pre></td></tr></table></figure>

<p>创建alertmanager的ingress：用户名密码直接复用prometheus的</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">alertmanager-ingress.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">"nginx"</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-type:</span> <span class="string">basic</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-secret:</span> <span class="string">basic-auth</span></span><br><span class="line">    <span class="attr">nginx.ingress.kubernetes.io/auth-realm:</span> <span class="string">"Authentication Required Prometheus"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment">#tls:</span></span><br><span class="line">  <span class="comment">#  - hosts:</span></span><br><span class="line">  <span class="comment">#    - prometheus.test.aws.test.com</span></span><br><span class="line">  <span class="comment">#    secretName: prometheus.test.aws.test.com</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">prometheus.test.aws.test.com</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/alertmanager</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">alertmanager</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="string">web</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">alertmanager-ingress.yaml</span></span><br></pre></td></tr></table></figure>

<p>好了，访问测试一下：<a href="http://prometheus.test.aws.test.com" target="_blank" rel="noopener">http://prometheus.test.aws.test.com</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -L http://prometheus.test.aws.test.com/alertmanager -uprometheus -p</span><br><span class="line">Enter host password <span class="keyword">for</span> user <span class="string">'prometheus'</span>:</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">        &lt;meta name=<span class="string">"viewport"</span> content=<span class="string">"width=device-width, initial-scale=1, shrink-to-fit=no"</span>&gt;</span><br><span class="line">        &lt;title&gt;Alertmanager&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>

<p>下图可以看到三台alertmanager已经组成了集群。</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/alertmanager-status.jpg" alt></p>
<p>好了，alertmanager完事了，如果告知前面创建的prometheus呢？</p>
<p>还是查看一下<a href="#PrometheusSpec">PrometheusSpec</a>：</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>alerting</td>
<td>Define details regarding alerting.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertingspec" target="_blank" rel="noopener">AlertingSpec</a></td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="AlertingSpec"><a href="#AlertingSpec" class="headerlink" title="AlertingSpec"></a>AlertingSpec</h4><p>AlertingSpec defines parameters for alerting configuration of Prometheus servers.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>alertmanagers</td>
<td>AlertmanagerEndpoints Prometheus should fire alerts against.</td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#alertmanagerendpoints" target="_blank" rel="noopener">AlertmanagerEndpoints</a></td>
<td>true</td>
</tr>
</tbody></table>
<h4 id="AlertmanagerEndpoints"><a href="#AlertmanagerEndpoints" class="headerlink" title="AlertmanagerEndpoints"></a>AlertmanagerEndpoints</h4><p>AlertmanagerEndpoints defines a selection of a single Endpoints object containing alertmanager IPs to fire alerts against.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>namespace</td>
<td>Namespace of Endpoints object.</td>
<td>string</td>
<td>true</td>
</tr>
<tr>
<td>name</td>
<td>Name of Endpoints object in Namespace.</td>
<td>string</td>
<td>true</td>
</tr>
<tr>
<td>port</td>
<td>Port the Alertmanager API is exposed on.</td>
<td>intstr.IntOrString</td>
<td>true</td>
</tr>
<tr>
<td>scheme</td>
<td>Scheme to use when firing alerts.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>pathPrefix</td>
<td>Prefix for the HTTP path alerts are pushed to.</td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>tlsConfig</td>
<td>TLS Config to use for alertmanager connection.</td>
<td>*<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#tlsconfig" target="_blank" rel="noopener">TLSConfig</a></td>
<td>false</td>
</tr>
<tr>
<td>bearerTokenFile</td>
<td>BearerTokenFile to read from filesystem to use when authenticating to Alertmanager.</td>
<td>string</td>
<td>false</td>
</tr>
</tbody></table>
<p>Prometheus定义如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-path.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">1d</span></span><br><span class="line">  <span class="attr">externalUrl:</span> <span class="string">http://prometheus.test.aws.microoak.cn/prometheus</span></span><br><span class="line">  <span class="attr">routePrefix:</span> <span class="string">/prometheus</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">alerting:</span> <span class="comment"># 这里定义alerting</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespace:</span> <span class="string">prometheus</span> <span class="comment"># alertmanager endpoint对象所在namespace</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">alertmanager</span> <span class="comment"># alertmanager endpoint名称，等同于service名称</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span> <span class="comment"># alertmanager端口</span></span><br><span class="line">      <span class="attr">pathPrefix:</span> <span class="string">/alertmanager</span> <span class="comment"># alertmanager path的前缀，因为我们定义了/alertmanager</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br></pre></td></tr></table></figure>

<div class="note danger">
            <p>注意：</p><p>如果你没有配置：routePrefix和externalUrl，那么这里也不需要配置pathPrefix</p><p>如果你配置了如上的：routePrefix和externalUrl，那么pathPrefix需要配置成和routePrefix一致：</p><p>pathPrefix: /alertmanager：</p><p>否则prometheus去通知alertmanager的时候会报404错误：</p><blockquote><p>level=error ts=2019-11-20T03:01:24.934Z caller=notifier.go:487 component=notifier alertmanager=<a href="http://10.101.217.208:9093/api/v1/alerts" target="_blank" rel="noopener">http://10.101.217.208:9093/api/v1/alerts</a> count=0 msg=”Error sending alert” err=”bad response status 404 Not Found”<br>level=error ts=2019-11-20T03:01:24.934Z caller=notifier.go:487 component=notifier alertmanager=<a href="http://10.101.253.80:9093/api/v1/alerts" target="_blank" rel="noopener">http://10.101.253.80:9093/api/v1/alerts</a> count=0 msg=”Error sending alert” err=”bad response status 404 Not Found”<br>level=error ts=2019-11-20T03:01:24.934Z caller=notifier.go:487 component=notifier alertmanager=<a href="http://10.101.253.81:9093/api/v1/alerts" target="_blank" rel="noopener">http://10.101.253.81:9093/api/v1/alerts</a> count=0 msg=”Error sending alert” err=”bad response status 404 Not Found”</p></blockquote>
          </div>

<p>检查一下prometheus dashboard 中alerting的配置吧：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alert_relabel_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">    <span class="attr">regex:</span> <span class="string">prometheus_replica</span></span><br><span class="line">    <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">labeldrop</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">namespaces:</span></span><br><span class="line">        <span class="attr">names:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">path_prefix:</span> <span class="string">/alertmanager</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">      <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">alertmanager</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_endpoint_port_name]</span></span><br><span class="line">      <span class="attr">separator:</span> <span class="string">;</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">$1</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br></pre></td></tr></table></figure>

<p>查看prometheus是否发现了alertmanager实例呢：prometheus dashboard—Status—Runtime &amp; BUild Information：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/alertmanager-ins.jpg" alt="Alertmanager-ins"></p>
<p>好了alertmanager 实例已经创建了，现在可以创建告警以及规则了。</p>
<h3 id="通过PrometheusRule-创建rule，以及alert告警"><a href="#通过PrometheusRule-创建rule，以及alert告警" class="headerlink" title="通过PrometheusRule 创建rule，以及alert告警"></a>通过PrometheusRule 创建rule，以及alert告警</h3><p>老规矩，查看<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusrule" target="_blank" rel="noopener">api</a>：</p>
<h4 id="PrometheusRule"><a href="#PrometheusRule" class="headerlink" title="PrometheusRule"></a>PrometheusRule</h4><p>PrometheusRule defines alerting rules for a Prometheus instance</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>metadata</td>
<td>Standard object’s metadata. More info: <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata" target="_blank" rel="noopener">https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#metadata</a></td>
<td><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.11/#objectmeta-v1-meta" target="_blank" rel="noopener">metav1.ObjectMeta</a></td>
<td>false</td>
</tr>
<tr>
<td>spec</td>
<td>Specification of desired alerting rule definitions for Prometheus.</td>
<td><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusrulespec" target="_blank" rel="noopener">PrometheusRuleSpec</a></td>
<td>true</td>
</tr>
</tbody></table>
<h4 id="PrometheusRuleSpec-这里的定义是跟prometheus中定义rules，alert是一样的。具体可以alerting-rules，rules"><a href="#PrometheusRuleSpec-这里的定义是跟prometheus中定义rules，alert是一样的。具体可以alerting-rules，rules" class="headerlink" title="PrometheusRuleSpec  这里的定义是跟prometheus中定义rules，alert是一样的。具体可以alerting-rules，rules"></a>PrometheusRuleSpec  这里的定义是跟prometheus中定义rules，alert是一样的。具体可以<a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">alerting-rules</a>，<a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" target="_blank" rel="noopener">rules</a></h4><p>PrometheusRuleSpec contains specification parameters for a Rule.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>groups</td>
<td>Content of Prometheus rule file</td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#rulegroup" target="_blank" rel="noopener">RuleGroup</a></td>
<td>false</td>
</tr>
</tbody></table>
<h4 id="RuleGroup"><a href="#RuleGroup" class="headerlink" title="RuleGroup"></a>RuleGroup</h4><p>RuleGroup is a list of sequentially evaluated recording and alerting rules.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td></td>
<td>string</td>
<td>true</td>
</tr>
<tr>
<td>interval</td>
<td></td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>rules</td>
<td></td>
<td>[]<a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#rule" target="_blank" rel="noopener">Rule</a></td>
<td>true</td>
</tr>
</tbody></table>
<h4 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h4><p>Rule describes an alerting or recording rule.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
<th>Scheme</th>
<th>Required</th>
</tr>
</thead>
<tbody><tr>
<td>record</td>
<td></td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>alert</td>
<td></td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>expr</td>
<td></td>
<td>intstr.IntOrString</td>
<td>true</td>
</tr>
<tr>
<td>for</td>
<td></td>
<td>string</td>
<td>false</td>
</tr>
<tr>
<td>labels</td>
<td></td>
<td>map[string]string</td>
<td>false</td>
</tr>
<tr>
<td>annotations</td>
<td></td>
<td>map[string]string</td>
<td>false</td>
</tr>
</tbody></table>
<p>定义prometheusrule如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheusrule.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PrometheusRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rules-alerts</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">labels:</span> <span class="comment"># 需要定义labels，方便prometheus进行筛选。</span></span><br><span class="line">    <span class="attr">prometheus:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">rules-alerts</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alerting-group</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">13s</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">InstanceDown</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">up</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">for:</span> <span class="string">1m</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">error</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> down"</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> of job <span class="template-variable">&#123;&#123; $labels.job &#125;&#125;</span> has been down for more than 3 minutes."</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">WatchDog</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">vector(1)</span></span><br><span class="line">      <span class="attr">for:</span> <span class="string">10m</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">info</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">summary:</span> <span class="string">"watchdog service every 10m send message."</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rules-group</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="string">30s</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">record:</span> <span class="string">http_requests_total:avg_rate1m</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">avg(rate(http_requests_total[1m]))</span> <span class="string">by</span> <span class="string">(instance,job,method,service,code)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># apply一下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheusrule.yaml</span></span><br></pre></td></tr></table></figure>

<p>定义完了prometheusrule其实还不能用：类似与serviceMonitor、Alertmanager都需要在Prometheus资源中通过lables进行筛选prometheus需要的。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">prometheus-path.yaml</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">monitoring.coreos.com/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v2.10.0</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">quay.azk8s.cn/prometheus/prometheus:v2.10.0</span></span><br><span class="line">  <span class="attr">retention:</span> <span class="string">1d</span></span><br><span class="line">  <span class="attr">externalUrl:</span> <span class="string">http://prometheus.test.aws.microoak.cn/prometheus</span></span><br><span class="line">  <span class="attr">routePrefix:</span> <span class="string">/prometheus</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">serviceMonitorSelector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">team:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">alerting:</span></span><br><span class="line">    <span class="attr">alertmanagers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">namespace:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">      <span class="attr">port:</span> <span class="string">web</span></span><br><span class="line">      <span class="attr">pathPrefix:</span> <span class="string">/alertmanager</span></span><br><span class="line">  <span class="attr">ruleSelector:</span> <span class="comment"># 通过labels筛选prometheusRule</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">prometheus:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">role:</span> <span class="string">rules-alerts</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">400Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">200m</span></span><br><span class="line">    <span class="attr">limits:</span></span><br><span class="line">      <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">      <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># apply一下</span></span><br><span class="line"><span class="string">$</span> <span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-path.yaml</span></span><br></pre></td></tr></table></figure>

<p>等待prometheus的自动reload，然后检查如下：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-alerts-rules.jpg" alt="rules"></p>
<p>查询一下定义的rule：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-rules.jpg" alt="查询rules"></p>
<p>查看alert：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-alerts.jpg" alt="Alerts"></p>
<p>等待10分钟再次查看：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/prometheus-alerting.jpg" alt="Alerting-FIRING"></p>
<p>在Alertmanager上查看：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/alertmanager-alerting.jpg" alt="Alertmanager-alerting"></p>
<p>查看邮件通知：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/email-alerting.jpg" alt="Email-alerting"></p>
<p>点击上面的Source能够跳转到Prometheus：</p>
<p><a href="http://prometheus.test.aws.test.com/prometheus/graph?g0.expr=vector%281%29&amp;g0.tab=1" target="_blank" rel="noopener">http://prometheus.test.aws.test.com/prometheus/graph?g0.expr=vector%281%29&amp;g0.tab=1</a></p>
<h2 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h2><p>看到上面的Prometheus、Alertmanager、ServiceMonitor、PrometheusRule、PodMonitor，以及其中的依赖关系，是不是觉得很懵逼呢？看个图就明白了很多：</p>
<p><img src="https://imgs.knner.wang/images/Prometheus-Operator-test/custom-metrics-elements.png" alt></p>
<div class="note sucess">
            <p>Prometheus、Alertmanager、ServiceMonitor、PrometheusRule、PodMonitor在一个Kubernetes集群中都可能会有多个。</p><p>Alertmanager定义alertmanager server，负责等待prometheus server推送过来的告警，然后根据告警规则通知最终用户。</p><p>ServiceMonitor、PodMonitor都是定义要搜集的目标，以及怎么搜集，都是通过prometheus的kubernetes自动发现配置的，所以需要为prometheus配置RBAC权限，让它有权限去发现对应的目标。</p><p>然后就是Prometheus去部署一个prometheus server，然后通过标签选择要搜集的对象（ServiceMonitor、PodMonitor）、告警和规则（PrometheusRule）、以及当发生告警时要通知那些alertmanager（Alertmanager）。</p><p>所有的这些操作都是通过kubernetes的声明式API配置的，operator定义了如上几个CRD，用户定义期望的值（配置的这些的CRD），operator负责根据Prometheus、Alertmanager部署prometheus server，alertmanager server，然后根据ServiceMonitor、PrometheusRule、PodMonitor 来生成prometheus的配置文件，prometheus pod内的sidecar负责重载配置，最终尽可能的达到用户的期望值。</p>
          </div>



<h2 id="移除Prometheus-Operator"><a href="#移除Prometheus-Operator" class="headerlink" title="移除Prometheus Operator"></a>移除Prometheus Operator</h2><p>我们以手动的方式测试完prometheus operator，了解其中的原理后，我们需要将其卸载掉，因为我们后续会使用<a href="https://github.com/helm/charts/tree/master/stable/prometheus-operator" target="_blank" rel="noopener">Helm的方式来安装Prometheus-Operator</a>（后面会有博文去介绍，欢迎期待），这样会帮助我们安装<a href="https://github.com/coreos/kube-prometheus" target="_blank" rel="noopener">kube-prometheus</a>、监控Kubernetes集群所需的Manifests，以及对应的Grafana和Dashboard，这样会大大的解放我们双手。</p>
<p><a href="https://github.com/coreos/prometheus-operator#removal" target="_blank" rel="noopener">移除的方法参考GitHub</a></p>
<p>要移除prometheus operator首先要移除在每个namespace下面的定义的CRD（5个），operator会自动的的关闭prometheus和alertmanager pod以及其关联的ConfigMaps。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">for</span> n <span class="keyword">in</span> $(kubectl get namespaces -o jsonpath=&#123;..metadata.name&#125;); <span class="keyword">do</span></span><br><span class="line">  kubectl delete --all --namespace=<span class="variable">$n</span> prometheus,servicemonitor,podmonitor,alertmanager</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<p>然后再移除operator本身：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl delete -f bundle.yaml</span><br></pre></td></tr></table></figure>

<p>清理operator自动在每个namespace下面创建的service，以及5个CRD：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> $(kubectl get namespaces -o jsonpath=&#123;..metadata.name&#125;); <span class="keyword">do</span></span><br><span class="line">  kubectl delete --ignore-not-found --namespace=<span class="variable">$n</span> service prometheus-operated alertmanager-operated</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">kubectl delete --ignore-not-found customresourcedefinitions \</span><br><span class="line">  prometheuses.monitoring.coreos.com \</span><br><span class="line">  servicemonitors.monitoring.coreos.com \</span><br><span class="line">  podmonitors.monitoring.coreos.com \</span><br><span class="line">  alertmanagers.monitoring.coreos.com \</span><br><span class="line">  prometheusrules.monitoring.coreos.com</span><br></pre></td></tr></table></figure>



<p>参考：</p>
<blockquote>
<p><a href="https://coreos.com/blog/the-prometheus-operator.html" target="_blank" rel="noopener">https://coreos.com/blog/the-prometheus-operator.html</a></p>
<p><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/troubleshooting.md" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator/blob/master/Documentation/troubleshooting.md</a></p>
<p><a href="https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md" target="_blank" rel="noopener">https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md</a> # 重要</p>
<p><a href="https://zhangguanzhang.github.io/2018/10/12/prometheus-operator/" target="_blank" rel="noopener">https://zhangguanzhang.github.io/2018/10/12/prometheus-operator/</a></p>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/</a></p>
<p><a href="https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/" target="_blank" rel="noopener">https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/</a></p>
</blockquote>
<hr>
<blockquote>
<p>本文到这里就结束了，欢迎期待后面的文章。您可以关注下方的公众号二维码，在第一时间查看新文章。</p>
<p><img src="https://imgs.knner.wang/images/knner/wx.jpg" alt="公众号"></p>
</blockquote>
<hr>

    </div>

    
    
    
      
        <div class="reward-container">
  <div>如有疏忽错误欢迎在留言区评论指正，如果对您有所帮助欢迎点击下方进行打赏。</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/knner/wechatpay.jpg" alt="Knner.Wang 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/knner/alipay.jpg" alt="Knner.Wang 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Knner.Wang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://knner.wang/2019/11/20/Prometheus-Operator-test.html" title="Prometheus-Operator 手动入门实战">https://knner.wang/2019/11/20/Prometheus-Operator-test.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/prometheus/" rel="tag"># prometheus</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/11/14/Pre-trial-helm3.html" rel="next" title="抢先试用Helm3，并安装nginx-ingress-controller">
                  <i class="fa fa-chevron-left"></i> 抢先试用Helm3，并安装nginx-ingress-controller
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2019/11/22/Using-Helm3-Install-InfluDB-Prometheus-Operator.html" rel="prev" title="使用Helm3安装Prometheus-Operator + InfluxDB">
                  使用Helm3安装Prometheus-Operator + InfluxDB <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus-Operator简介"><span class="nav-number">1.</span> <span class="nav-text">Prometheus Operator简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus-Operator-安装后提供如下功能："><span class="nav-number">1.1.</span> <span class="nav-text">Prometheus Operator 安装后提供如下功能：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus-Operator-vs-kube-prometheus-vs-community-helm-chart-都是什么？"><span class="nav-number">1.2.</span> <span class="nav-text">Prometheus Operator vs. kube-prometheus vs. community helm chart 都是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前提依赖以及兼容性："><span class="nav-number">1.3.</span> <span class="nav-text">前提依赖以及兼容性：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CRD（Custom-Resource-Definitions-自定义资源）"><span class="nav-number">1.4.</span> <span class="nav-text">CRD（Custom Resource Definitions 自定义资源）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装prometheus-operator"><span class="nav-number">2.</span> <span class="nav-text">安装prometheus-operator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Prometheus-Operator-CRDs"><span class="nav-number">3.</span> <span class="nav-text">安装Prometheus Operator CRDs ??</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Prometheus-Operator-实战"><span class="nav-number">4.</span> <span class="nav-text">Prometheus Operator 实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Prometheus实例："><span class="nav-number">4.1.</span> <span class="nav-text">创建Prometheus实例：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Prometheus"><span class="nav-number">4.1.1.</span> <span class="nav-text">Prometheus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PrometheusSpec"><span class="nav-number">4.1.2.</span> <span class="nav-text">PrometheusSpec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定prometheus-server的版本"><span class="nav-number">4.1.3.</span> <span class="nav-text">指定prometheus server的版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指定prometheus-server的资源限制："><span class="nav-number">4.1.4.</span> <span class="nav-text">指定prometheus server的资源限制：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置prometheus-server的存储以及数据保留期限"><span class="nav-number">4.1.5.</span> <span class="nav-text">配置prometheus server的存储以及数据保留期限</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#StorageSpec"><span class="nav-number">4.1.5.1.</span> <span class="nav-text">StorageSpec</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置prometheus-server-ingress，并配置basicAuth-用户名密码认证"><span class="nav-number">4.1.6.</span> <span class="nav-text">配置prometheus server ingress，并配置basicAuth 用户名密码认证</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#配置ingress的prometheus-path路径为-prometheus"><span class="nav-number">4.1.6.1.</span> <span class="nav-text">配置ingress的prometheus path路径为 /prometheus</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ServiceMonitor-配置"><span class="nav-number">4.2.</span> <span class="nav-text">ServiceMonitor 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ServiceMonitor"><span class="nav-number">4.2.1.</span> <span class="nav-text">ServiceMonitor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ServiceMonitorSpec"><span class="nav-number">4.2.2.</span> <span class="nav-text">ServiceMonitorSpec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Endpoint"><span class="nav-number">4.2.3.</span> <span class="nav-text">Endpoint</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NamespaceSelector"><span class="nav-number">4.2.4.</span> <span class="nav-text">NamespaceSelector</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建Alertmanager实例："><span class="nav-number">4.3.</span> <span class="nav-text">创建Alertmanager实例：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Alertmanager"><span class="nav-number">4.3.1.</span> <span class="nav-text">Alertmanager</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AlertmanagerSpec"><span class="nav-number">4.3.2.</span> <span class="nav-text">AlertmanagerSpec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AlertingSpec"><span class="nav-number">4.3.3.</span> <span class="nav-text">AlertingSpec</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AlertmanagerEndpoints"><span class="nav-number">4.3.4.</span> <span class="nav-text">AlertmanagerEndpoints</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过PrometheusRule-创建rule，以及alert告警"><span class="nav-number">4.4.</span> <span class="nav-text">通过PrometheusRule 创建rule，以及alert告警</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#PrometheusRule"><span class="nav-number">4.4.1.</span> <span class="nav-text">PrometheusRule</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PrometheusRuleSpec-这里的定义是跟prometheus中定义rules，alert是一样的。具体可以alerting-rules，rules"><span class="nav-number">4.4.2.</span> <span class="nav-text">PrometheusRuleSpec  这里的定义是跟prometheus中定义rules，alert是一样的。具体可以alerting-rules，rules</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RuleGroup"><span class="nav-number">4.4.3.</span> <span class="nav-text">RuleGroup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Rule"><span class="nav-number">4.4.4.</span> <span class="nav-text">Rule</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结："><span class="nav-number">5.</span> <span class="nav-text">总结：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#移除Prometheus-Operator"><span class="nav-number">6.</span> <span class="nav-text">移除Prometheus Operator</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Knner.Wang"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Knner.Wang</p>
  <div class="site-description" itemprop="description">Knner.Wang's Blog,for sharing IT technology and also my study notes.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wanghkkk" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://hub.docker.com/u/wanghkkk" title="DockerHub &amp;rarr; https:&#x2F;&#x2F;hub.docker.com&#x2F;u&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-docker"></i>DockerHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wanghk@live.cn" title="E-Mail &amp;rarr; mailto:wanghk@live.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备19058691号-1 </a>
      <img src="/images/knner/ga-icon.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802030660" rel="noopener" target="_blank">11010802030660 </a>
  </div>

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Knner.Wang 版权所有</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
    和<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" rel="noopener"><img width="60" style="display: inline;" src="/images/logos/upyun_logo5.png"></a>提供CDN加速/云存储服务
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  











<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '500px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://knner.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://knner.wang/2019/11/20/Prometheus-Operator-test.html",
            identifier: "2019/11/20/Prometheus-Operator-test.html",
            title: "Prometheus-Operator 手动入门实战"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://knner.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    (function() {
      var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        window.addEventListener('load', loadComments, false);
      } else {
        var disqus_scroll = () => {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
          var scrollTop = window.scrollY;

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            window.removeEventListener('scroll', disqus_scroll);
            loadComments();
          }
        };
        window.addEventListener('scroll', disqus_scroll);
      }
    })();
  
</script>

</body>
</html>
