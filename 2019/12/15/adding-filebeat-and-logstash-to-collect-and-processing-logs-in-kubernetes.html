<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <link rel="manifest" href="/images/site.webmanifest">
  <meta name="msapplication-config" content="/images/browserconfig.xml">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|consolas:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":"mac"},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":true,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="在Kubernetes日志收集的系列文章里，我们分部介绍了： 安装生产可用、高安全的Elasticsearch集群+Kibana：安装Elasticsearch 7.4集群（开启集群Auth + Transport SSL）以及 Kibana &amp;amp; Keystore 安装了Zookeeper &amp;amp; Kafka生产可用的集群：安装配置Zookeeper和Kafka集群 最终的架构图如下所">
<meta name="keywords" content="filebeat,logstash">
<meta property="og:type" content="article">
<meta property="og:title" content="使用filebeat + kafka + logstash收集处理kubernetes日志，配置收集处理nginx-ingress json日志">
<meta property="og:url" content="https:&#x2F;&#x2F;knner.wang&#x2F;2019&#x2F;12&#x2F;15&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html">
<meta property="og:site_name" content="Knner.Wang&#39;s Blog">
<meta property="og:description" content="在Kubernetes日志收集的系列文章里，我们分部介绍了： 安装生产可用、高安全的Elasticsearch集群+Kibana：安装Elasticsearch 7.4集群（开启集群Auth + Transport SSL）以及 Kibana &amp;amp; Keystore 安装了Zookeeper &amp;amp; Kafka生产可用的集群：安装配置Zookeeper和Kafka集群 最终的架构图如下所">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;felk.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;busybox-fields.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;busybox-multiline.png">
<meta property="og:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;busybox-decode_json_fields.png">
<meta property="og:updated_time" content="2019-12-15T04:28:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;felk.png">

<link rel="canonical" href="https://knner.wang/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>使用filebeat + kafka + logstash收集处理kubernetes日志，配置收集处理nginx-ingress json日志 | Knner.Wang's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Knner.Wang's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">20</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">25</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://knner.wang/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Knner.Wang">
      <meta itemprop="description" content="Knner.Wang's Blog,for sharing IT technology and also my study notes.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Knner.Wang's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          使用filebeat + kafka + logstash收集处理kubernetes日志，配置收集处理nginx-ingress json日志
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-12-15 12:28:39" itemprop="dateCreated datePublished" datetime="2019-12-15T12:28:39+08:00">2019-12-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filebeat/" itemprop="url" rel="index">
                    <span itemprop="name">filebeat</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filebeat/logstash/" itemprop="url" rel="index">
                    <span itemprop="name">logstash</span>
                  </a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/filebeat/logstash/kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">kubernetes</span>
                  </a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html#comments" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>在Kubernetes日志收集的系列文章里，我们分部介绍了：</p><ul>
<li>安装生产可用、高安全的Elasticsearch集群+Kibana：<a href="/2019/11/26/install-elasticsearch-cluster-7-4.html" title="安装Elasticsearch 7.4集群（开启集群Auth + Transport SSL）以及 Kibana &amp; Keystore">安装Elasticsearch 7.4集群（开启集群Auth + Transport SSL）以及 Kibana &amp; Keystore</a></li>
<li>安装了Zookeeper &amp; Kafka生产可用的集群：<a href="/2019/12/05/install-and-config-zookeeper-and-kafka-cluster.html" title="安装配置Zookeeper和Kafka集群">安装配置Zookeeper和Kafka集群</a></li>
</ul><p>最终的架构图如下所示：</p><p><img src="https://imgs.knner.wang/images/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes/felk.png" alt></p><p>架构说明：</p><ul>
<li>所有的beats，这里主要说明filebeat，都使用DaemonSet的方式安装的Kubernetes集群上，收集各个node节点的容器日志，并做简单的处理，例如多行等，然后将数据发送到Kafka集群中。</li>
<li>Kafka 集群这里主要安装在Kubernetes集群以外，负责解耦、缓冲beats发来的数据，同时也可以存储处理好的日志，作为中转站，方便其他需要后期处理日志的工具订阅数据。</li>
<li>Logstash 可以安装在Kubernetes集群内部或者外部，从kafka收集beat发来的日志，做一些处理，例如：geoip获取IP地址的地理位置，处理Useragent等，然后将处理好的日志clone一份，同时输出到Elasticsearch集群不同index和Kafka中不同的topic上，方便其他流处理工具进行后期的实时计算。如果日志量很大，单台logstash无法支撑，可以启动多台logstash，属于同一个消费者组，这里可以分担处理。注意：最大的logstash台数不要超过topic的partitions数量，否则，多出来的logstash也是闲置的。</li>
<li>Elasticsearch这里主要安装在Kubernetes集群以外，负责存储、查询、分析日志。</li>
<li>Kibana 可以安装在Kubernetes集群内部或者外部，通过web UI界面查看Elasticsearch数据，查询，并出图。</li>
</ul><a id="more"></a>





<div class="note sucess">
            <p>这里使用Kafka而不是用Redis的原因如下：</p><ul><li>Redis是内存型，而Kafka是硬盘型，日志毕竟是很大的数据，所以作为缓冲，放到Kafka里更合适；</li><li>kafka中已经被处理的日志也是会继续保存的，直到超过自己设定的过期时间，而redis不是；</li><li>kafka生态比较好，可以方便的和流处理工具集成</li></ul><p>综上：redis适合日质量比较小的系统，而kafka适用于比较大的日志。因为都需要保证高可用，推荐搭建Kafka集群。</p>
          </div>

<p>环境说明：</p>
<ul>
<li><p>Elasticsearch集群：版本：7.4.2</p>
<p>集群地址：</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Port</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>172.17.0.87</td>
<td>9200</td>
<td>es01</td>
</tr>
<tr>
<td>172.17.0.87</td>
<td>9201</td>
<td>es02</td>
</tr>
<tr>
<td>172.17.0.87</td>
<td>9202</td>
<td>es02</td>
</tr>
</tbody></table>
</li>
<li><p>Kafka集群：版本：2.0.0</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>Port</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>172.17.0.87</td>
<td>9092</td>
<td>kafka01</td>
</tr>
<tr>
<td>172.17.0.87</td>
<td>9093</td>
<td>kafka02</td>
</tr>
<tr>
<td>172.17.0.87</td>
<td>9094</td>
<td>kafka03</td>
</tr>
</tbody></table>
</li>
<li><p>Kubernetes 1.15.4</p>
</li>
<li><p>Filebeat + Logstash版本：7.4.2</p>
</li>
</ul>
<h2 id="Filebeat"><a href="#Filebeat" class="headerlink" title="Filebeat"></a>Filebeat</h2><h3 id="方案一：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中"><a href="#方案一：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中" class="headerlink" title="方案一： Filebeat收集K8S pod日志，直接发送到Elasticsearch中"></a>方案一： Filebeat收集K8S pod日志，直接发送到Elasticsearch中</h3><p>这里将filebeat安装在Kubernetes集群中，以收集K8S pod的日志，并将日志直接发送到ES集群当中。</p>
<blockquote>
<p>参考：</p>
<p><a href="https://github.com/elastic/beats/tree/v7.4.2/deploy/kubernetes" target="_blank" rel="noopener">https://github.com/elastic/beats/tree/v7.4.2/deploy/kubernetes</a></p>
<p><a href="https://github.com/elastic/beats/blob/v7.4.2/deploy/kubernetes/filebeat-kubernetes.yaml" target="_blank" rel="noopener">https://github.com/elastic/beats/blob/v7.4.2/deploy/kubernetes/filebeat-kubernetes.yaml</a></p>
</blockquote>
<p>我们首先下载官方的filebeat-kubernetes.yaml文件，进行修改：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">wget</span> <span class="string">-c</span> <span class="string">"https://github.com/elastic/beats/blob/v7.4.2/deploy/kubernetes/filebeat-kubernetes.yaml"</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">filebeat-kubernetes.yaml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.inputs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/var/log/containers/*.log</span></span><br><span class="line">      <span class="attr">processors:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">add_kubernetes_metadata:</span> <span class="comment"># 增加kubernetes的属性</span></span><br><span class="line">            <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">            <span class="attr">matchers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">logs_path:</span></span><br><span class="line">                <span class="attr">logs_path:</span> <span class="string">"/var/log/containers/"</span></span><br><span class="line">    <span class="comment"># To enable hints based autodiscover, remove `filebeat.inputs` configuration and uncomment this:</span></span><br><span class="line">    <span class="comment">#filebeat.autodiscover:</span></span><br><span class="line">    <span class="comment">#  providers:</span></span><br><span class="line">    <span class="comment">#    - type: kubernetes</span></span><br><span class="line">    <span class="comment">#      host: $&#123;NODE_NAME&#125;</span></span><br><span class="line">    <span class="comment">#      hints.enabled: true</span></span><br><span class="line">    <span class="comment">#      hints.default_config:</span></span><br><span class="line">    <span class="comment">#        type: container</span></span><br><span class="line">    <span class="comment">#        paths:</span></span><br><span class="line">    <span class="comment">#          - /var/log/containers/*$&#123;data.kubernetes.container.id&#125;.log</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span> <span class="comment"># 增加cloud属性，我这里是aws环境</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span> <span class="comment"># 增加k8s node节点属性</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">filebeat</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.elastic.co/beats/filebeat:7.4.2</span></span><br><span class="line">        <span class="attr">args:</span> <span class="string">[</span></span><br><span class="line">          <span class="string">"-c"</span><span class="string">,</span> <span class="string">"/etc/filebeat.yml"</span><span class="string">,</span></span><br><span class="line">          <span class="string">"-e"</span><span class="string">,</span></span><br><span class="line">        <span class="string">]</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"172.17.0.87"</span> <span class="comment"># 指定ES的地址</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PORT</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"9200"</span> <span class="comment"># 指定ES的端口</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">admin</span> <span class="comment"># 指定ES的用户名</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">admin123</span> <span class="comment"># 指定ES的密码</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTIC_CLOUD_ID</span></span><br><span class="line">          <span class="attr">value:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTIC_CLOUD_AUTH</span></span><br><span class="line">          <span class="attr">value:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NODE_NAME</span></span><br><span class="line">          <span class="attr">valueFrom:</span></span><br><span class="line">            <span class="attr">fieldRef:</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">spec.nodeName</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">0</span></span><br><span class="line">          <span class="comment"># If using Red Hat OpenShift uncomment this:</span></span><br><span class="line">          <span class="comment">#privileged: true</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/filebeat.yml</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">filebeat.yml</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/filebeat/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">defaultMode:</span> <span class="number">0600</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="comment"># data folder stores a registry of read status for all files, so we don't send everything again on a Filebeat pod restart</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/filebeat-data</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span> <span class="comment"># "" indicates the core API group</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>然后直接应用：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f filebeat-kubernetes.yaml</span><br></pre></td></tr></table></figure>

<p>检查状态：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n kube-system get po -l k8s-app=filebeat</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">filebeat-brk5b   1/1     Running   0          3d13h</span><br><span class="line">filebeat-wbwpx   1/1     Running   0          3d13h</span><br><span class="line">filebeat-z672h   1/1     Running   0          3d13h</span><br></pre></td></tr></table></figure>

<p>我们在创建测试用Pod：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">testlogs-pods.yaml</span> </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">num=1;while</span> <span class="literal">true</span><span class="string">;do</span> <span class="string">echo</span> <span class="string">"&#123;\"mydate\":\"$(date)\",\"num\":$((num=num+1))&#125;"</span><span class="string">;sleep</span> <span class="number">5</span><span class="string">;done</span></span><br></pre></td></tr></table></figure>

<p>查看测试pod的日志格式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ kubectl logs busybox-xxxxxxx</span><br><span class="line">&#123;&quot;mydate&quot;:&quot;Wed Dec 11 07:20:08 UTC 2019&quot;,&quot;num&quot;:2&#125;</span><br><span class="line">&#123;&quot;mydate&quot;:&quot;Wed Dec 11 07:20:13 UTC 2019&quot;,&quot;num&quot;:3&#125;</span><br><span class="line">&#123;&quot;mydate&quot;:&quot;Wed Dec 11 07:20:18 UTC 2019&quot;,&quot;num&quot;:4&#125;</span><br><span class="line">&#123;&quot;mydate&quot;:&quot;Wed Dec 11 07:20:23 UTC 2019&quot;,&quot;num&quot;:5&#125;</span><br><span class="line">&#123;&quot;mydate&quot;:&quot;Wed Dec 11 07:20:28 UTC 2019&quot;,&quot;num&quot;:6&#125;</span><br></pre></td></tr></table></figure>



<p>此时我们到Kibana上查看：</p>
<p>增加filebeat-*的index，然后搜索：<code>kubernetes.labels.app:&quot;busybox&quot;</code> 收集的日志格式如下：</p>
<p><img src="https://imgs.knner.wang/images/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes/busybox-fields.png" alt></p>
<p>Josn格式如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span>: <span class="string">"filebeat-7.4.1-2019.12.05-000001"</span>,</span><br><span class="line">  <span class="attr">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span>: <span class="string">"-kce724B-DEl4DemmqgT"</span>,</span><br><span class="line">  <span class="attr">"_version"</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"_score"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"_source"</span>: &#123;</span><br><span class="line">    <span class="attr">"@timestamp"</span>: <span class="string">"2019-12-10T09:23:07.847Z"</span>,</span><br><span class="line">    <span class="attr">"input"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"container"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"kubernetes"</span>: &#123;</span><br><span class="line">      <span class="attr">"node"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"k8s01.test.awsbj.cn"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"container"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"busybox"</span>,</span><br><span class="line">        <span class="attr">"image"</span>: <span class="string">"busybox:latest"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">      <span class="attr">"replicaset"</span>: &#123;</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"busybox-dc8c98dbd"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"labels"</span>: &#123;</span><br><span class="line">        <span class="attr">"pod-template-hash"</span>: <span class="string">"dc8c98dbd"</span>,</span><br><span class="line">        <span class="attr">"app"</span>: <span class="string">"busybox"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"pod"</span>: &#123;</span><br><span class="line">        <span class="attr">"uid"</span>: <span class="string">"7fae0c4a-6979-4563-926f-6187fc67815d"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"busybox-dc8c98dbd-g9jt2"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ecs"</span>: &#123;</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"1.1.0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"host"</span>: &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">      <span class="attr">"hostname"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">      <span class="attr">"architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">      <span class="attr">"os"</span>: &#123;</span><br><span class="line">        <span class="attr">"platform"</span>: <span class="string">"centos"</span>,</span><br><span class="line">        <span class="attr">"version"</span>: <span class="string">"7 (Core)"</span>,</span><br><span class="line">        <span class="attr">"family"</span>: <span class="string">"redhat"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"CentOS Linux"</span>,</span><br><span class="line">        <span class="attr">"kernel"</span>: <span class="string">"4.14.138-114.102.amzn2.x86_64"</span>,</span><br><span class="line">        <span class="attr">"codename"</span>: <span class="string">"Core"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"containerized"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"cloud"</span>: &#123;</span><br><span class="line">      <span class="attr">"provider"</span>: <span class="string">"aws"</span>,</span><br><span class="line">      <span class="attr">"instance"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"i-066bf576192908763"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"machine"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"m4.xlarge"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"region"</span>: <span class="string">"cn-north-1"</span>,</span><br><span class="line">      <span class="attr">"availability_zone"</span>: <span class="string">"cn-north-1a"</span>,</span><br><span class="line">      <span class="attr">"account"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"600060780818"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">"image"</span>: &#123;</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"ami-00c02e45635d96f87"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"log"</span>: &#123;</span><br><span class="line">      <span class="attr">"offset"</span>: <span class="number">158428</span>,</span><br><span class="line">      <span class="attr">"file"</span>: &#123;</span><br><span class="line">        <span class="attr">"path"</span>: <span class="string">"/var/log/containers/busybox-dc8c98dbd-g9jt2_default_busybox-1445d3c7e06d462fce96c0ed7da25d0105a555bedf68c3a55cb123f42f4cac47.log"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"stream"</span>: <span class="string">"stdout"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"&#123;\"mydate\":\"Tue Dec 10 09:23:07 UTC 2019\",\"num\":1240&#125;"</span>,</span><br><span class="line">    <span class="attr">"agent"</span>: &#123;</span><br><span class="line">      <span class="attr">"type"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">      <span class="attr">"ephemeral_id"</span>: <span class="string">"f9a8eb22-62bd-4b65-969b-74ea0e55fa8f"</span>,</span><br><span class="line">      <span class="attr">"hostname"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">      <span class="attr">"id"</span>: <span class="string">"32551f33-2dcf-4a5c-bacd-64ce83433f34"</span>,</span><br><span class="line">      <span class="attr">"version"</span>: <span class="string">"7.4.1"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"fields"</span>: &#123;</span><br><span class="line">    <span class="attr">"suricata.eve.timestamp"</span>: [</span><br><span class="line">      <span class="string">"2019-12-10T09:23:07.847Z"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"@timestamp"</span>: [</span><br><span class="line">      <span class="string">"2019-12-10T09:23:07.847Z"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"highlight"</span>: &#123;</span><br><span class="line">    <span class="attr">"kubernetes.labels.app"</span>: [</span><br><span class="line">      <span class="string">"@kibana-highlighted-field@busybox@/kibana-highlighted-field@"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"sort"</span>: [</span><br><span class="line">    <span class="number">1575969787847</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的效果说明：</p>
<ul>
<li>所有的K8S Pod日志都被收集到了一个filebeat的index中</li>
<li>未对pod中的json日志做格式化解析</li>
</ul>
<p>显然效果不太好。</p>
<h3 id="方案二：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能"><a href="#方案二：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能" class="headerlink" title="方案二： Filebeat收集K8S pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能"></a>方案二： Filebeat收集K8S pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能</h3><blockquote>
<p>参考：</p>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-autodiscover.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/configuration-autodiscover.html</a> 自动发现配置</p>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/configuration-autodiscover-hints.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/configuration-autodiscover-hints.html</a> 自动发现hints配置</p>
</blockquote>
<p>根据官方的filebeat-kubernetes.yaml文件中configMap部分，我们发现有一小段的注释：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># To enable hints based autodiscover, remove `filebeat.inputs` configuration and uncomment this:</span></span><br><span class="line"><span class="comment">#filebeat.autodiscover:</span></span><br><span class="line"><span class="comment">#  providers:</span></span><br><span class="line"><span class="comment">#    - type: kubernetes</span></span><br><span class="line"><span class="comment">#      host: $&#123;NODE_NAME&#125;</span></span><br><span class="line"><span class="comment">#      hints.enabled: true</span></span><br><span class="line"><span class="comment">#      hints.default_config:</span></span><br><span class="line"><span class="comment">#        type: container</span></span><br><span class="line"><span class="comment">#        paths:</span></span><br><span class="line"><span class="comment">#          - /var/log/containers/*$&#123;data.kubernetes.container.id&#125;.log</span></span><br></pre></td></tr></table></figure>

<p>我们更改filebeat的configMap配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">--</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span> <span class="comment"># 使用autodiscover功能</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/var/log/containers/*$&#123;data.kubernetes.container.id&#125;.log</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>我们应用后，发现结果是跟通过<code>filebeat.inputs:</code> 方式直接采集/var/log/containers/*.log的结果是一样的。</p>
<p>但是我们在官方文档中发现：<code>hints</code> 有特殊的玩法。我们测试一下，更改configMap的配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config.enabled:</span> <span class="literal">false</span> <span class="comment"># 我们这里将默认配置给关闭了</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们应用后，发现kibana中最近一分钟已经没有日志了。结果是对的，我们更改我们之前的测试pod：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">annotations:</span> <span class="comment"># 增加了如下annotations，开启该pod的日志收集，并配置multiline多行</span></span><br><span class="line">        <span class="attr">co.elastic.logs/enabled:</span> <span class="string">'true'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.pattern:</span> <span class="string">'^\&#123;'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.negate:</span> <span class="string">'true'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.match:</span> <span class="string">'after'</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">num=1;while</span> <span class="literal">true</span><span class="string">;do</span> <span class="string">echo</span> <span class="string">"&#123;\"mydate\":\"$(date)\",\"num\":$((num=num+1))&#125;"</span><span class="string">;echo</span> <span class="string">"wanghk-$&#123;num&#125;"</span><span class="string">;sleep</span> <span class="number">5</span><span class="string">;done</span> <span class="comment"># 这里也更改了</span></span><br></pre></td></tr></table></figure>

<p>我们查看一下该pod的日志：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">$ kubectl logs busybox-xxxxxxx</span><br><span class="line">&#123;<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 07:20:08 UTC 2019"</span>,<span class="attr">"num"</span>:<span class="number">2</span>&#125;</span><br><span class="line">wanghk-2</span><br><span class="line">&#123;<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 07:20:13 UTC 2019"</span>,<span class="attr">"num"</span>:<span class="number">3</span>&#125;</span><br><span class="line">wanghk-3</span><br><span class="line">&#123;<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 07:20:18 UTC 2019"</span>,<span class="attr">"num"</span>:<span class="number">4</span>&#125;</span><br><span class="line">wanghk-4</span><br><span class="line">&#123;<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 07:20:23 UTC 2019"</span>,<span class="attr">"num"</span>:<span class="number">5</span>&#125;</span><br><span class="line">wanghk-5</span><br><span class="line">&#123;<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 07:20:28 UTC 2019"</span>,<span class="attr">"num"</span>:<span class="number">6</span>&#125;</span><br></pre></td></tr></table></figure>



<p>我们再到Kibana中查看，发现只有该pod的日志，并且多行的配置已经生效了。</p>
<p><img src="https://imgs.knner.wang/images/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes/busybox-multiline.png" alt></p>
<p>但是呢，测试pod中的json字段还是没有解析，好吧，我们根据hints文档，更改pod的annotations：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">co.elastic.logs/enabled:</span> <span class="string">'true'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.pattern:</span> <span class="string">'^\&#123;'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.negate:</span> <span class="string">'true'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/multiline.match:</span> <span class="string">'after'</span></span><br><span class="line">        <span class="attr">co.elastic.logs/processors.1.decode_json_fields.fields:</span> <span class="string">"message"</span> <span class="comment"># 使用decode_json_fields</span></span><br><span class="line">        <span class="attr">co.elastic.logs/processors.1.decode_json_fields.add_error_key:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="attr">co.elastic.logs/processors.1.decode_json_fields.overwrite_keys:</span> <span class="string">"true"</span></span><br><span class="line">        <span class="attr">co.elastic.logs/processors.1.decode_json_fields.target:</span> <span class="string">""</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">num=1;while</span> <span class="literal">true</span><span class="string">;do</span> <span class="string">echo</span> <span class="string">"&#123;\"mydate\":\"$(date)\",\"num\":$((num=num+1))&#125;"</span><span class="string">;sleep</span> <span class="number">5</span><span class="string">;done</span></span><br></pre></td></tr></table></figure>

<p>我们这里增加了一个processors <code>decode_json_fields</code>，官网参考：</p>
<blockquote>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/filtering-and-enhancing-data.html</a> processors</p>
<p><a href="https://www.elastic.co/guide/en/beats/filebeat/current/decode-json-fields.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/decode-json-fields.html</a> decode_json_fields配置</p>
</blockquote>
<p>再次查看Kibana，发现json日志已经被解析了：</p>
<p><img src="https://imgs.knner.wang/images/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes/busybox-decode_json_fields.png" alt></p>
<h3 id="方案三：-通过Filebeat自动发现功能收集K8S-pod日志，直接发送到Elasticsearch的不同index中"><a href="#方案三：-通过Filebeat自动发现功能收集K8S-pod日志，直接发送到Elasticsearch的不同index中" class="headerlink" title="方案三： 通过Filebeat自动发现功能收集K8S pod日志，直接发送到Elasticsearch的不同index中"></a>方案三： 通过Filebeat自动发现功能收集K8S pod日志，直接发送到Elasticsearch的不同index中</h3><p>好了，还有一个问题，就是所有的pod日志都输出到了一个叫filebeat-xxx的index中了，我们如何自定义将不通的服务输出到不同的index呢？</p>
<p>还是更改filebeat的configMap如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config.enabled:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line">      <span class="attr">indices:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">"busybox-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>"</span></span><br><span class="line">          <span class="attr">when.regexp:</span> <span class="comment"># 通过when.regexp 正则表达式匹配</span></span><br><span class="line">            <span class="attr">kubernetes.labels.app:</span> <span class="string">busybox.*</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 输出到elasticsearch中的配置，参考官方：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html</a></p>
<p>filebeat的条件判断配置，参考官方：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/defining-processors.html#conditions" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/defining-processors.html#conditions</a></p>
</blockquote>
<p>我们通过正则匹配kubernetes.labels.app中的值，如果匹配busybox.*的则输出到busybox-%{+yyyy.MM.dd} index中，如果不匹配的还是走默认filebeat index中。</p>
<p>我们在kibana中增加index：busybox-*，发现里边有了我们的busybox容器的日志。</p>
<p>好了，大部分问题都解决了（解析容器Josn日志，输出到不同的index中），但是K8S中的其他pod怎么办呢，难道都需要配置annotations嘛，那也太麻烦了，我们测试一下在开启hints的默认配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">--</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span> <span class="comment"># 使用autodiscover功能</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config:</span> <span class="comment"># 开启默认的配置</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/var/log/containers/*$&#123;data.kubernetes.container.id&#125;.log</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output.elasticsearch:</span></span><br><span class="line">      <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line">      <span class="attr">indices:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">"busybox-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>"</span></span><br><span class="line">          <span class="attr">when.regexp:</span></span><br><span class="line">            <span class="attr">kubernetes.labels.app:</span> <span class="string">busybox.*</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p>应用后，我们发现其他的pod日志都存在默认的index中：filebeat-xxxx，而我们的测试pod busybox还是输出在busybox-xxx中，并且还是能够解析json日志的。</p>
<p>所以我们得出结论：</p>
<ul>
<li>开启hints的默认配置，以收集所有容器的日志</li>
<li>对已特殊容器，需要解析json的，或者配置多行的，我们通过annotations对该容器进行特殊配置</li>
</ul>
<p>好了，我们进行最终的方案：</p>
<h3 id="方案四：-Filebeat收集K8S-pod日志，通过自动发现功能，发送到Kafka集群中"><a href="#方案四：-Filebeat收集K8S-pod日志，通过自动发现功能，发送到Kafka集群中" class="headerlink" title="方案四： Filebeat收集K8S pod日志，通过自动发现功能，发送到Kafka集群中"></a>方案四： Filebeat收集K8S pod日志，通过自动发现功能，发送到Kafka集群中</h3><p>更改filebeat的configMap：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">filebeat-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">filebeat</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">filebeat.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">filebeat.autodiscover:</span></span><br><span class="line">      <span class="attr">providers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">kubernetes</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">$&#123;NODE_NAME&#125;</span></span><br><span class="line">          <span class="attr">hints.enabled:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">hints.default_config:</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">container</span></span><br><span class="line">            <span class="attr">paths:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">/var/log/containers/*$&#123;data.kubernetes.container.id&#125;.log</span></span><br><span class="line">    <span class="attr">processors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_cloud_metadata:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">add_host_metadata:</span></span><br><span class="line">    <span class="attr">cloud.id:</span> <span class="string">$&#123;ELASTIC_CLOUD_ID&#125;</span></span><br><span class="line">    <span class="attr">cloud.auth:</span> <span class="string">$&#123;ELASTIC_CLOUD_AUTH&#125;</span></span><br><span class="line">    <span class="attr">output:</span></span><br><span class="line">      <span class="attr">elasticsearch:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 关闭了elasticsearch的输出</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">['$&#123;ELASTICSEARCH_HOST:elasticsearch&#125;:$&#123;ELASTICSEARCH_PORT:9200&#125;']</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">$&#123;ELASTICSEARCH_USERNAME&#125;</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">$&#123;ELASTICSEARCH_PASSWORD&#125;</span></span><br><span class="line">        <span class="attr">indices:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">"busybox-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>"</span></span><br><span class="line">            <span class="attr">when.regexp:</span></span><br><span class="line">              <span class="attr">kubernetes.labels.app:</span> <span class="string">busybox.*</span></span><br><span class="line">      <span class="attr">kafka:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 增加kafka的输出</span></span><br><span class="line">        <span class="attr">hosts:</span> <span class="string">["172.17.0.87:9092","172.17.0.87:9093","172.17.0.87:9094"]</span></span><br><span class="line">        <span class="attr">topic:</span> <span class="string">filebeat</span></span><br><span class="line">        <span class="attr">max_message_bytes:</span> <span class="number">5242880</span></span><br><span class="line">        <span class="attr">partition.round_robin:</span></span><br><span class="line">          <span class="attr">reachable_only:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">keep-alive:</span> <span class="number">120</span></span><br><span class="line">        <span class="attr">required_acks:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>关于如何配置Kafka的输出，请参考官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/kafka-output.html</a></p>
<p>创建所需的Topic：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./kafka01/bin/kafka-topics.sh --zookeeper zk01:2181 --create --topic filebeat --partitions 5 --replication-factor 1</span><br><span class="line">Created topic <span class="string">"filebeat"</span>.</span><br><span class="line"></span><br><span class="line">$ ./kafka01/bin/kafka-topics.sh --zookeeper zk01:2181 --list</span><br><span class="line">__consumer_offsets</span><br><span class="line">filebeat</span><br><span class="line">my-replicated-topic</span><br><span class="line"><span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ ./kafka01/bin/kafka-topics.sh --zookeeper zk01:2181 --describe --topic filebeat</span><br><span class="line">Topic:filebeat	PartitionCount:5	ReplicationFactor:1	Configs:</span><br><span class="line">4Topic: filebeat	Partition: 0	Leader: 0	Replicas: 0	Isr: 0</span><br><span class="line">4Topic: filebeat	Partition: 1	Leader: 1	Replicas: 1	Isr: 1</span><br><span class="line">4Topic: filebeat	Partition: 2	Leader: 2	Replicas: 2	Isr: 2</span><br><span class="line">4Topic: filebeat	Partition: 3	Leader: 0	Replicas: 0	Isr: 0</span><br><span class="line">Topic: filebeat	Partition: 4	Leader: 1	Replicas: 1	Isr: 1</span><br></pre></td></tr></table></figure>

<p>好了，应用filebeat的配置后，我们启动一个消费者看看是否有日志近来：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./kafka01/bin/kafka-console-consumer.sh --bootstrap-server kafka01:9092,kafka02:9093,kafka03:9094 --topic filebeat --from-beginning</span><br></pre></td></tr></table></figure>

<p>收到日志如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">收到的：</span><br><span class="line">&#123;<span class="attr">"@timestamp"</span>:<span class="string">"2019-12-11T13:45:55.958Z"</span>,<span class="attr">"@metadata"</span>:&#123;<span class="attr">"beat"</span>:<span class="string">"filebeat"</span>,<span class="attr">"type"</span>:<span class="string">"_doc"</span>,<span class="attr">"version"</span>:<span class="string">"7.4.1"</span>,<span class="attr">"topic"</span>:<span class="string">"filebeat"</span>&#125;,<span class="attr">"kubernetes"</span>:&#123;<span class="attr">"namespace"</span>:<span class="string">"default"</span>,<span class="attr">"replicaset"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"busybox-bf68bcffd"</span>&#125;,<span class="attr">"labels"</span>:&#123;<span class="attr">"app"</span>:<span class="string">"busybox"</span>,<span class="attr">"pod-template-hash"</span>:<span class="string">"bf68bcffd"</span>&#125;,<span class="attr">"pod"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"busybox-bf68bcffd-h7595"</span>,<span class="attr">"uid"</span>:<span class="string">"f7a1f370-938d-401e-8a54-8f12a0b0cf3d"</span>&#125;,<span class="attr">"node"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"k8s01.test.awsbj.cn"</span>&#125;,<span class="attr">"container"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"busybox"</span>,<span class="attr">"image"</span>:<span class="string">"busybox"</span>&#125;&#125;,<span class="attr">"num"</span>:<span class="number">2566</span>,<span class="attr">"stream"</span>:<span class="string">"stdout"</span>,<span class="attr">"message"</span>:<span class="string">"&#123;\"mydate\":\"Wed Dec 11 13:45:55 UTC 2019\",\"num\":2566&#125;"</span>,<span class="attr">"input"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"container"</span>&#125;,<span class="attr">"host"</span>:&#123;<span class="attr">"name"</span>:<span class="string">"k8s01.test.awsbj.cn"</span>,<span class="attr">"hostname"</span>:<span class="string">"k8s01.test.awsbj.cn"</span>,<span class="attr">"architecture"</span>:<span class="string">"x86_64"</span>,<span class="attr">"os"</span>:&#123;<span class="attr">"family"</span>:<span class="string">"redhat"</span>,<span class="attr">"name"</span>:<span class="string">"CentOS Linux"</span>,<span class="attr">"kernel"</span>:<span class="string">"4.14.138-114.102.amzn2.x86_64"</span>,<span class="attr">"codename"</span>:<span class="string">"Core"</span>,<span class="attr">"platform"</span>:<span class="string">"centos"</span>,<span class="attr">"version"</span>:<span class="string">"7 (Core)"</span>&#125;,<span class="attr">"containerized"</span>:<span class="literal">true</span>&#125;,<span class="attr">"agent"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"filebeat"</span>,<span class="attr">"ephemeral_id"</span>:<span class="string">"74d3b9f0-f9f3-4ead-b82b-7dd6a214046e"</span>,<span class="attr">"hostname"</span>:<span class="string">"k8s01.test.awsbj.cn"</span>,<span class="attr">"id"</span>:<span class="string">"32551f33-2dcf-4a5c-bacd-64ce83433f34"</span>,<span class="attr">"version"</span>:<span class="string">"7.4.1"</span>&#125;,<span class="attr">"cloud"</span>:&#123;<span class="attr">"image"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"ami-00c02e45635d96f87"</span>&#125;,<span class="attr">"instance"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"i-066bf576192908763"</span>&#125;,<span class="attr">"provider"</span>:<span class="string">"aws"</span>,<span class="attr">"machine"</span>:&#123;<span class="attr">"type"</span>:<span class="string">"m4.xlarge"</span>&#125;,<span class="attr">"region"</span>:<span class="string">"cn-north-1"</span>,<span class="attr">"availability_zone"</span>:<span class="string">"cn-north-1a"</span>,<span class="attr">"account"</span>:&#123;<span class="attr">"id"</span>:<span class="string">"600060780818"</span>&#125;&#125;,<span class="attr">"log"</span>:&#123;<span class="attr">"offset"</span>:<span class="number">329362</span>,<span class="attr">"file"</span>:&#123;<span class="attr">"path"</span>:<span class="string">"/var/lib/docker/containers/3ca6b693a233756466f827451f66745a3199b0bfa32c54f68422706295baa053/3ca6b693a233756466f827451f66745a3199b0bfa32c54f68422706295baa053-json.log"</span>&#125;&#125;,<span class="attr">"mydate"</span>:<span class="string">"Wed Dec 11 13:45:55 UTC 2019"</span>,<span class="attr">"ecs"</span>:&#123;<span class="attr">"version"</span>:<span class="string">"1.1.0"</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">格式化后的：</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"@metadata"</span>: &#123;</span><br><span class="line">        <span class="attr">"beat"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">        <span class="attr">"topic"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="attr">"version"</span>: <span class="string">"7.4.1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"@timestamp"</span>: <span class="string">"2019-12-11T13:45:55.958Z"</span>,</span><br><span class="line">    <span class="attr">"agent"</span>: &#123;</span><br><span class="line">        <span class="attr">"ephemeral_id"</span>: <span class="string">"74d3b9f0-f9f3-4ead-b82b-7dd6a214046e"</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">        <span class="attr">"id"</span>: <span class="string">"32551f33-2dcf-4a5c-bacd-64ce83433f34"</span>,</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"filebeat"</span>,</span><br><span class="line">        <span class="attr">"version"</span>: <span class="string">"7.4.1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"cloud"</span>: &#123;</span><br><span class="line">        <span class="attr">"account"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"600060780818"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"availability_zone"</span>: <span class="string">"cn-north-1a"</span>,</span><br><span class="line">        <span class="attr">"image"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"ami-00c02e45635d96f87"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"instance"</span>: &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="string">"i-066bf576192908763"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"machine"</span>: &#123;</span><br><span class="line">            <span class="attr">"type"</span>: <span class="string">"m4.xlarge"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"provider"</span>: <span class="string">"aws"</span>,</span><br><span class="line">        <span class="attr">"region"</span>: <span class="string">"cn-north-1"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ecs"</span>: &#123;</span><br><span class="line">        <span class="attr">"version"</span>: <span class="string">"1.1.0"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"host"</span>: &#123;</span><br><span class="line">        <span class="attr">"architecture"</span>: <span class="string">"x86_64"</span>,</span><br><span class="line">        <span class="attr">"containerized"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">"hostname"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"k8s01.test.awsbj.cn"</span>,</span><br><span class="line">        <span class="attr">"os"</span>: &#123;</span><br><span class="line">            <span class="attr">"codename"</span>: <span class="string">"Core"</span>,</span><br><span class="line">            <span class="attr">"family"</span>: <span class="string">"redhat"</span>,</span><br><span class="line">            <span class="attr">"kernel"</span>: <span class="string">"4.14.138-114.102.amzn2.x86_64"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"CentOS Linux"</span>,</span><br><span class="line">            <span class="attr">"platform"</span>: <span class="string">"centos"</span>,</span><br><span class="line">            <span class="attr">"version"</span>: <span class="string">"7 (Core)"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"input"</span>: &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"container"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="attr">"container"</span>: &#123;</span><br><span class="line">            <span class="attr">"image"</span>: <span class="string">"busybox"</span>,</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"busybox"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"labels"</span>: &#123;</span><br><span class="line">            <span class="attr">"app"</span>: <span class="string">"busybox"</span>,</span><br><span class="line">            <span class="attr">"pod-template-hash"</span>: <span class="string">"bf68bcffd"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"namespace"</span>: <span class="string">"default"</span>,</span><br><span class="line">        <span class="attr">"node"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"k8s01.test.awsbj.cn"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"pod"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"busybox-bf68bcffd-h7595"</span>,</span><br><span class="line">            <span class="attr">"uid"</span>: <span class="string">"f7a1f370-938d-401e-8a54-8f12a0b0cf3d"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"replicaset"</span>: &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"busybox-bf68bcffd"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"log"</span>: &#123;</span><br><span class="line">        <span class="attr">"file"</span>: &#123;</span><br><span class="line">            <span class="attr">"path"</span>: <span class="string">"/var/lib/docker/containers/3ca6b693a233756466f827451f66745a3199b0bfa32c54f68422706295baa053/3ca6b693a233756466f827451f66745a3199b0bfa32c54f68422706295baa053-json.log"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"offset"</span>: <span class="number">329362</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"&#123;\"mydate\":\"Wed Dec 11 13:45:55 UTC 2019\",\"num\":2566&#125;"</span>,</span><br><span class="line">    <span class="attr">"mydate"</span>: <span class="string">"Wed Dec 11 13:45:55 UTC 2019"</span>,</span><br><span class="line">    <span class="attr">"num"</span>: <span class="number">2566</span>,</span><br><span class="line">    <span class="attr">"stream"</span>: <span class="string">"stdout"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试没有问题，接下来，我们按照logstash，来从filebeat topic采集日志。</p>
<h2 id="Logstash"><a href="#Logstash" class="headerlink" title="Logstash"></a>Logstash</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>我们使用二进制的方式安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tar xf logstash-7.4.2.tar.gz -C /data/knner</span><br><span class="line">$ <span class="built_in">cd</span> /data/knner</span><br><span class="line">$ ln -s logstash-7.4.2 logstash</span><br></pre></td></tr></table></figure>



<h4 id="目录结构："><a href="#目录结构：" class="headerlink" title="目录结构："></a>目录结构：</h4><p><code>.zip</code> and <code>.tar.gz</code> </p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Default Location</th>
<th>Setting</th>
</tr>
</thead>
<tbody><tr>
<td><strong>home</strong></td>
<td>Home directory of the Logstash installation.</td>
<td><code>{extract.path}- Directory created by unpacking the archive</code></td>
<td></td>
</tr>
<tr>
<td><strong>bin</strong></td>
<td>Binary scripts, including <code>logstash</code> to start Logstash and <code>logstash-plugin</code> to install plugins</td>
<td><code>{extract.path}/bin</code></td>
<td></td>
</tr>
<tr>
<td><strong>settings</strong></td>
<td>Configuration files, including <code>logstash.yml</code> and <code>jvm.options</code></td>
<td><code>{extract.path}/config</code></td>
<td><code>path.settings</code></td>
</tr>
<tr>
<td><strong>logs</strong></td>
<td>Log files</td>
<td><code>{extract.path}/logs</code></td>
<td><code>path.logs</code></td>
</tr>
<tr>
<td><strong>plugins</strong></td>
<td>Local, non Ruby-Gem plugin files. Each plugin is contained in a subdirectory. Recommended for development only.</td>
<td><code>{extract.path}/plugins</code></td>
<td><code>path.plugins</code></td>
</tr>
<tr>
<td><strong>data</strong></td>
<td>Data files used by logstash and its plugins for any persistence needs.</td>
<td><code>{extract.path}/data</code></td>
<td><code>path.data</code></td>
</tr>
</tbody></table>
<p>Debian and RPM</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Default Location</th>
<th>Setting</th>
</tr>
</thead>
<tbody><tr>
<td><strong>home</strong></td>
<td>Home directory of the Logstash installation.</td>
<td><code>/usr/share/logstash</code></td>
<td></td>
</tr>
<tr>
<td><strong>bin</strong></td>
<td>Binary scripts including <code>logstash</code> to start Logstash and <code>logstash-plugin</code> to install plugins</td>
<td><code>/usr/share/logstash/bin</code></td>
<td></td>
</tr>
<tr>
<td><strong>settings</strong></td>
<td>Configuration files, including <code>logstash.yml</code>, <code>jvm.options</code>, and <code>startup.options</code></td>
<td><code>/etc/logstash</code></td>
<td><code>path.settings</code></td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>Logstash pipeline configuration files</td>
<td><code>/etc/logstash/conf.d/*.conf</code></td>
<td><code>See /etc/logstash/pipelines.yml</code></td>
</tr>
<tr>
<td><strong>logs</strong></td>
<td>Log files</td>
<td><code>/var/log/logstash</code></td>
<td><code>path.logs</code></td>
</tr>
<tr>
<td><strong>plugins</strong></td>
<td>Local, non Ruby-Gem plugin files. Each plugin is contained in a subdirectory. Recommended for development only.</td>
<td><code>/usr/share/logstash/plugins</code></td>
<td><code>path.plugins</code></td>
</tr>
<tr>
<td><strong>data</strong></td>
<td>Data files used by logstash and its plugins for any persistence needs.</td>
<td><code>/var/lib/logstash</code></td>
<td><code>path.data</code></td>
</tr>
</tbody></table>
<p>Docker images:</p>
<p>没有logs的目录，所有的日志都是标准输出。</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>Default Location</th>
<th>Setting</th>
</tr>
</thead>
<tbody><tr>
<td><strong>home</strong></td>
<td>Home directory of the Logstash installation.</td>
<td><code>/usr/share/logstash</code></td>
<td></td>
</tr>
<tr>
<td><strong>bin</strong></td>
<td>Binary scripts, including <code>logstash</code> to start Logstash and <code>logstash-plugin</code> to install plugins</td>
<td><code>/usr/share/logstash/bin</code></td>
<td></td>
</tr>
<tr>
<td><strong>settings</strong></td>
<td>Configuration files, including <code>logstash.yml</code> and <code>jvm.options</code></td>
<td><code>/usr/share/logstash/config</code></td>
<td><code>path.settings</code></td>
</tr>
<tr>
<td><strong>conf</strong></td>
<td>Logstash pipeline configuration files</td>
<td><code>/usr/share/logstash/pipeline</code></td>
<td><code>path.config</code></td>
</tr>
<tr>
<td><strong>plugins</strong></td>
<td>Local, non Ruby-Gem plugin files. Each plugin is contained in a subdirectory. Recommended for development only.</td>
<td><code>/usr/share/logstash/plugins</code></td>
<td><code>path.plugins</code></td>
</tr>
<tr>
<td><strong>data</strong></td>
<td>Data files used by logstash and its plugins for any persistence needs.</td>
<td><code>/usr/share/logstash/data</code></td>
<td><code>path.data</code></td>
</tr>
</tbody></table>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><blockquote>
<p>参考：<a href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html</a></p>
</blockquote>
<p>在Logstash主要分为三步：<code>input</code> -&gt; <code>filter</code> -&gt; <code>output</code> 。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="值类型"><a href="#值类型" class="headerlink" title="值类型"></a>值类型</h4><ul>
<li><p>string</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">user =&gt; &quot;knner&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lists</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">path =&gt; [ &quot;/var/log/messages&quot;, &quot;/var/log/*.log&quot; ]</span><br><span class="line">uris =&gt; [ &quot;http://elastic.co&quot;, &quot;http://example.net&quot; ]</span><br></pre></td></tr></table></figure>
</li>
<li><p>Boolean<br><code>true</code> or <code>false</code>，注意不需要引号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssl_enable =&gt; true</span><br></pre></td></tr></table></figure>
</li>
<li><p>Bytes<br>其实就是string类型，包括了bytes的单位：支持：k,M,G,T    Ki,Mi,Gi,Ti</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my_bytes =&gt; &quot;1113&quot;   # 1113 bytes</span><br><span class="line">my_bytes =&gt; &quot;10MiB&quot;  # 10485760 bytes</span><br><span class="line">my_bytes =&gt; &quot;100kib&quot; # 102400 bytes</span><br><span class="line">my_bytes =&gt; &quot;180 mb&quot; # 180000000 bytes</span><br></pre></td></tr></table></figure>
</li>
<li><p>Codec<br>在logstash中叫做编码解码器，用于在input中解码，在output中编码。默认是：plain</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">codec =&gt; &quot;json&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Hash<br>就是kv格式，<code>&quot;field1&quot; =&gt; &quot;value1&quot;</code> 写法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">match =&gt; &#123;</span><br><span class="line">&quot;field1&quot; =&gt; &quot;value1&quot;</span><br><span class="line">&quot;field2&quot; =&gt; &quot;value2&quot;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"># or as a single line. No commas between entries:</span><br><span class="line">match =&gt; &#123; &quot;field1&quot; =&gt; &quot;value1&quot; &quot;field2&quot; =&gt; &quot;value2&quot; &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Number<br>数字，包括浮点数(floating)和整数(integer)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">port =&gt; 33</span><br></pre></td></tr></table></figure>
</li>
<li><p>Password<br>就是string类型，只是不会被打印出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my_password =&gt; &quot;password&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>URI<br>可以是完整的域名：<code>http://elastic.co</code>，可以是简单的字符串：<code>foobar</code>。如果是格式：<code>http://user:pass@knner.wang</code> 此时的密码也不会被打印。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my_uri =&gt; &quot;http://foo:bar@knner.wang&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Path<br>系统路径，string类型</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">my_path =&gt; &quot;/tmp/logstash&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Comments 注释</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 我就是注释</span><br><span class="line">input &#123; # comments can appear at the end of a line, too</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="在Logstash使用Events和fields中的数据"><a href="#在Logstash使用Events和fields中的数据" class="headerlink" title="在Logstash使用Events和fields中的数据"></a>在Logstash使用Events和fields中的数据</h4><blockquote>
<p>参考：<a href="https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/event-dependent-configuration.html</a></p>
</blockquote>
<h5 id="引用field字段"><a href="#引用field字段" class="headerlink" title="引用field字段"></a>引用field字段</h5><p>最简单的语法就是<code>[fieldname]</code>来引用名为fieldname的字段；</p>
<p>如果该字段是顶级的，可以省略<code>[]</code>，而直接使用<code>fieldname</code>。</p>
<p>如果该字段是嵌套的，你必须指定该field的绝对路径：<code>[top-level-field][nested-field]</code>。</p>
<p>例如：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"agent"</span>: <span class="string">"Mozilla/5.0 (compatible; MSIE 9.0)"</span>,</span><br><span class="line">  <span class="attr">"ip"</span>: <span class="string">"192.168.24.44"</span>,</span><br><span class="line">  <span class="attr">"request"</span>: <span class="string">"/index.html"</span></span><br><span class="line">  <span class="string">"response"</span>: &#123;</span><br><span class="line">    <span class="attr">"status"</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">"bytes"</span>: <span class="number">52353</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"ua"</span>: &#123;</span><br><span class="line">    <span class="attr">"os"</span>: <span class="string">"Windows 7"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果引用<code>os</code> 字段，需要指定：<code>[ua][os]</code></p>
<p>如果引用<code>ip</code> 字段，可以通过<code>[ip]</code> 或者直接<code>ip</code>的方式</p>
<h5 id="printf-format"><a href="#printf-format" class="headerlink" title="printf format"></a>printf format</h5><p>字段引用格式也在Logstash中使用，称作：<code>print format</code>。使用改格式，你可以获取字段中的值，进行动态的配置。</p>
<p>例如：输出elasticsearch中的index上，你可以引用字段的值，来动态输出到不同的index中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    host =&gt; [&quot;localhost:9200&quot;]</span><br><span class="line">    index =&gt; &quot;apache-%&#123;[response][status]&#125;-%&#123;+yyyy.MM.dd.HH&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以呢，从上面的apache log中，根据不同的响应码，而输出到不同的index中，例如：状态码为200的，将输出到index：<code>apache-200-2019.12.15</code>，状态码为503的将输出到index：<code>apache-503-2019.12.15</code> 中。</p>
<h5 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h5><p>在logstash中的<code>filter</code> ，<code>output</code> 中可以使用条件语句进行不同的操作。</p>
<p>logstash中的条件语句关键词有<code>if,else if,else</code>，等同于shell中的<code>if,elif,else</code>，语法如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if EXPRESSION &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">else if EXPRESSION &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">else &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>EXPRESSION</code> 表达式中可以使用如下操作符：</p>
<p>比较操作符：</p>
<ul>
<li>等于：==    不等于：!=    大于：&gt;    小于：&lt;    大于等于：&gt;=    小于等于：&lt;=</li>
<li>正则匹配：=~     正则不匹配：!~</li>
<li>in，not in</li>
</ul>
<p>布尔运算符：</p>
<ul>
<li>and（与），or（或），nand（非与），xor（非或）</li>
</ul>
<p>一元运算符：</p>
<ul>
<li>!</li>
</ul>
<p>表达式可以很长或者很复杂，可以使用<code>!</code> 取反，使用<code>()</code> 进行分组运算。</p>
<p>例如：当<code>action</code> 字段值为<code>login</code> 时，使用<code>mutate</code> 移除<code>secret</code> 字段</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [action] == &quot;login&quot; &#123;</span><br><span class="line">    mutate &#123; remove_field =&gt; &quot;secret&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在一行指定多个表达式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  # Send production errors to pagerduty</span><br><span class="line">  if [loglevel] == &quot;ERROR&quot; and [deployment] == &quot;production&quot; &#123;</span><br><span class="line">    pagerduty &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>您可以使用<code>in</code>操作符来测试字段是否包含特定的字符串、键或(用于列表)元素:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  if [foo] in [foobar] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in &quot;foo&quot; &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in string&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if &quot;hello&quot; in [greeting] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;string in field&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [foo] in [&quot;hello&quot;, &quot;world&quot;, &quot;foo&quot;] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;field in list&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if [missing] in [alsomissing] &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldnotexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if !(&quot;foo&quot; in [&quot;hello&quot;, &quot;world&quot;]) &#123;</span><br><span class="line">    mutate &#123; add_tag =&gt; &quot;shouldexist&quot; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在条件句中使用<code>not in</code>也是一样的。例如，当grok成功时，你可以使用<code>not in</code>将事件路由到Elasticsearch:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  if &quot;_grokparsefailure&quot; not in [tags] &#123;</span><br><span class="line">    elasticsearch &#123; ... &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你没有办法判断一个字段是否存在，还是其值是false或者空值：</p>
<p>例如：表达式<code>if [foo]</code>在下面的情况下都是<code>false</code>：</p>
<ul>
<li><code>foo</code> 字段不存在</li>
<li><code>foo</code> 字段是flase</li>
<li><code>foo</code> 字段存在，但是值为空值</li>
</ul>
<h5 id="metadata-字段"><a href="#metadata-字段" class="headerlink" title="@metadata 字段"></a>@metadata 字段</h5><p>在logstash中有一个特殊的字段<code>@metadata</code>，该字段在output的时候是看不见的，它会在output的时候被清除掉。最佳实践就是通过<code>@metadata</code> 字段进行条件判断。</p>
<p>例如：从<code>stdin</code> 进入的都会存放到<code>message</code> 字段中，通过使用<code>mutate</code>在filter中增加字段：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; "show" =&gt; "This data will be in the output" &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; "[@metadata][test]" =&gt; "Hello" &#125; &#125;</span><br><span class="line">  mutate &#123; add_field =&gt; &#123; "[@metadata][no_show]" =&gt; "This data will not be in the output" &#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  if [@metadata][test] == "Hello" &#123;</span><br><span class="line">    stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们运行一下看看，会发生什么：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf # 手动输入的</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:42:51.496Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot; # 手动输入的放到了message字段中</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现，添加的<code>[@metadata][test]</code> 和<code>[@metadata][no_show]</code> 并没有看到。</p>
<p>在rubydebug的output中可以使用<code>metadata =&gt; true</code> 来显示<code>@metadata</code> 字段，注意：只有在rubydebug中才允许使用<code>metadata =&gt; true</code>查看<code>@metadata</code> 字段。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">stdout &#123; codec =&gt; rubydebug &#123; metadata =&gt; true &#125; &#125;</span><br></pre></td></tr></table></figure>

<p>再次查看：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">asdf</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2016-06-30T02:46:48.565Z,</span><br><span class="line">     &quot;@metadata&quot; =&gt; &#123; # 这里看到了我们添加的两个字段</span><br><span class="line">           &quot;test&quot; =&gt; &quot;Hello&quot;,</span><br><span class="line">        &quot;no_show&quot; =&gt; &quot;This data will not be in the output&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">          &quot;show&quot; =&gt; &quot;This data will be in the output&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;asdf&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用<code>@metadata</code> 作为临时的字段，用于判断，但是有不想在output中真实的看到该字段。</p>
<p>例如：使用来自apache，nginx日志中的timestamp，用完之后，你还需要删除timestamp。但是通过<code>@metadata</code> 则不需要删除，如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">input &#123; stdin &#123; &#125; &#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  grok &#123; match =&gt; [ &quot;message&quot;, &quot;%&#123;HTTPDATE:[@metadata][timestamp]&#125;&quot; ] &#125;</span><br><span class="line">  date &#123; match =&gt; [ &quot;[@metadata][timestamp]&quot;, &quot;dd/MMM/yyyy:HH:mm:ss Z&quot; ] &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123; codec =&gt; rubydebug &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：使用grok 来通过正则匹配日志：正则的匹配格式为：HTTPDATE，已经内置在logstash中，可以在GitHub上查看，如下：</p>
<blockquote>
<p><a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" target="_blank" rel="noopener">https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns</a></p>
<p><a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns" target="_blank" rel="noopener">https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns</a></p>
<p>HTTPDATE %{MONTHDAY}/%{MONTH}/%{YEAR}:%{TIME} %{INT}</p>
<p>MONTHDAY (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])</p>
<p>MONTH \b(?:[Jj]an(?:uary|uar)?|[Ff]eb(?:ruary|ruar)?|<a href="?:a|ä">Mm</a>?r(?:ch|z)?|[Aa]pr(?:il)?|[Mm]a(?:y|i)?|[Jj]un(?:e|i)?|[Jj]ul(?:y)?|[Aa]ug(?:ust)?|[Ss]ep(?:tember)?|<a href="?:c|k">Oo</a>?t(?:ober)?|[Nn]ov(?:ember)?|[Dd]e(?:c|z)(?:ember)?)\b</p>
<p>YEAR (?&gt;\d\d){1,2}</p>
<p>TIME (?!&lt;[0-9])%{HOUR}:%{MINUTE}(?::%{SECOND})(?![0-9])</p>
<p>INT (?:[+-]?(?:[0-9]+))</p>
</blockquote>
<p>将匹配到的存入到：<code>[@metadata][timestamp]</code> 中，然后date在从<code>[@metadata][timestamp]</code> 获取以替代@timestamp。</p>
<p>测试如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ bin/logstash -f ../test.conf</span><br><span class="line">Pipeline main started</span><br><span class="line">02/Mar/2014:15:36:43 +0100 ## 手动输入</span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2014-03-02T14:36:43.000Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;example.com&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;02/Mar/2014:15:36:43 +0100&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们了解了Logstash的基本配置后，测试一下：</p>
<figure class="highlight bash"><figcaption><span>logstash/config/filebeat-kafka.conf</span></figcaption><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">"kafka01:9092,kafka02:9093,kafka03:9094"</span></span><br><span class="line">    client_id =&gt; <span class="string">"logstash01"</span></span><br><span class="line">    topics =&gt; [<span class="string">"filebeat"</span>]</span><br><span class="line">    group_id =&gt; <span class="string">"logstash"</span></span><br><span class="line">    decorate_events =&gt; <span class="literal">true</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"http://es01:9200"</span>,<span class="string">"http://es02:9201"</span>,<span class="string">"http://es03:9202"</span>]</span><br><span class="line">    index =&gt; <span class="string">"filebeat-kafka-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    user =&gt; <span class="string">"admin"</span></span><br><span class="line">    password =&gt; <span class="string">"admin123"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>查看一下logstash的命令帮助：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./bin/logstash --<span class="built_in">help</span></span><br><span class="line">Thread.exclusive is deprecated, use Thread::Mutex</span><br><span class="line">Usage:</span><br><span class="line">    bin/logstash [OPTIONS]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">    -n, --node.name NAME          Specify the name of this logstash instance, <span class="keyword">if</span> no value is given</span><br><span class="line">                                  it will default to the current hostname.</span><br><span class="line">                                   (default: <span class="string">"test01.dev.awsbj.cn"</span>)</span><br><span class="line">    -f, --path.config CONFIG_PATH Load the logstash config from a specific file</span><br><span class="line">                                  or directory.  If a directory is given, all</span><br><span class="line">                                  files <span class="keyword">in</span> that directory will be concatenated</span><br><span class="line">                                  <span class="keyword">in</span> lexicographical order and <span class="keyword">then</span> parsed as a</span><br><span class="line">                                  single config file. You can also specify</span><br><span class="line">                                  wildcards (globs) and any matched files will</span><br><span class="line">                                  be loaded <span class="keyword">in</span> the order described above.</span><br><span class="line">    -e, --config.string CONFIG_STRING Use the given string as the configuration</span><br><span class="line">                                  data. Same syntax as the config file. If no</span><br><span class="line">                                  input is specified, <span class="keyword">then</span> the following is</span><br><span class="line">                                  used as the default input:</span><br><span class="line">                                  <span class="string">"input &#123; stdin &#123; type =&gt; stdin &#125; &#125;"</span></span><br><span class="line">                                  and <span class="keyword">if</span> no output is specified, <span class="keyword">then</span> the</span><br><span class="line">                                  following is used as the default output:</span><br><span class="line">                                  <span class="string">"output &#123; stdout &#123; codec =&gt; rubydebug &#125; &#125;"</span></span><br><span class="line">                                  If you wish to use both defaults, please use</span><br><span class="line">                                  the empty string <span class="keyword">for</span> the <span class="string">'-e'</span> flag.</span><br><span class="line">                                   (default: nil)</span><br><span class="line">    --field-reference-parser MODE (DEPRECATED) This option is no longer</span><br><span class="line">                                  configurable.</span><br><span class="line">                                  </span><br><span class="line">                                  Use the given MODE when parsing field</span><br><span class="line">                                  references.</span><br><span class="line">                                  </span><br><span class="line">                                  The field reference parser is used to expand</span><br><span class="line">                                  field references <span class="keyword">in</span> your pipeline configs,</span><br><span class="line">                                  and has become more strict to better handle</span><br><span class="line">                                  ambiguous- and illegal-syntax inputs.</span><br><span class="line">                                  </span><br><span class="line">                                  The only available MODE is:</span><br><span class="line">                                   - `STRICT`: parse <span class="keyword">in</span> a strict manner; when</span><br><span class="line">                                     given ambiguous- or illegal-syntax input,</span><br><span class="line">                                     raises a runtime exception that should</span><br><span class="line">                                     be handled by the calling plugin.</span><br><span class="line">                                  </span><br><span class="line">                                   (default: <span class="string">"STRICT"</span>)</span><br><span class="line">    --modules MODULES             Load Logstash modules.</span><br><span class="line">                                  Modules can be defined using multiple instances</span><br><span class="line">                                  <span class="string">'--modules module1 --modules module2'</span>,</span><br><span class="line">                                     or comma-separated syntax</span><br><span class="line">                                  <span class="string">'--modules=module1,module2'</span></span><br><span class="line">                                  Cannot be used <span class="keyword">in</span> conjunction with <span class="string">'-e'</span> or <span class="string">'-f'</span></span><br><span class="line">                                  Use of <span class="string">'--modules'</span> will override modules declared</span><br><span class="line">                                  <span class="keyword">in</span> the <span class="string">'logstash.yml'</span> file.</span><br><span class="line">    -M, --modules.variable MODULES_VARIABLE Load variables <span class="keyword">for</span> module template.</span><br><span class="line">                                  Multiple instances of <span class="string">'-M'</span> or</span><br><span class="line">                                  <span class="string">'--modules.variable'</span> are supported.</span><br><span class="line">                                  Ignored <span class="keyword">if</span> <span class="string">'--modules'</span> flag is not used.</span><br><span class="line">                                  Should be <span class="keyword">in</span> the format of</span><br><span class="line">                                  <span class="string">'-M "MODULE_NAME.var.PLUGIN_TYPE.PLUGIN_NAME.VARIABLE_NAME=VALUE"'</span></span><br><span class="line">                                  as <span class="keyword">in</span></span><br><span class="line">                                  <span class="string">'-M "example.var.filter.mutate.fieldname=fieldvalue"'</span></span><br><span class="line">    --setup                       Load index template into Elasticsearch, and saved searches, </span><br><span class="line">                                  index-pattern, visualizations, and dashboards into Kibana when</span><br><span class="line">                                  running modules.</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    --cloud.id CLOUD_ID           Sets the elasticsearch and kibana host settings <span class="keyword">for</span></span><br><span class="line">                                  module connections <span class="keyword">in</span> Elastic Cloud.</span><br><span class="line">                                  Your Elastic Cloud User interface or the Cloud support</span><br><span class="line">                                  team should provide this.</span><br><span class="line">                                  Add an optional label prefix <span class="string">'&lt;label&gt;:'</span> to <span class="built_in">help</span> you</span><br><span class="line">                                  identify multiple cloud.ids.</span><br><span class="line">                                  e.g. <span class="string">'staging:dXMtZWFzdC0xLmF3cy5mb3VuZC5pbyRub3RhcmVhbCRpZGVudGlmaWVy'</span></span><br><span class="line">    --cloud.auth CLOUD_AUTH       Sets the elasticsearch and kibana username and password</span><br><span class="line">                                  <span class="keyword">for</span> module connections <span class="keyword">in</span> Elastic Cloud</span><br><span class="line">                                  e.g. <span class="string">'username:&lt;password&gt;'</span></span><br><span class="line">    --pipeline.id ID              Sets the ID of the pipeline.</span><br><span class="line">                                   (default: <span class="string">"main"</span>)</span><br><span class="line">    -w, --pipeline.workers COUNT  Sets the number of pipeline workers to run.</span><br><span class="line">                                   (default: 4)</span><br><span class="line">    --java-execution              Use Java execution engine.</span><br><span class="line">                                   (default: <span class="literal">true</span>)</span><br><span class="line">    --plugin-classloaders         (Beta) Load Java plugins <span class="keyword">in</span> independent classloaders to isolate their dependencies.</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    -b, --pipeline.batch.size SIZE Size of batches the pipeline is to work <span class="keyword">in</span>.</span><br><span class="line">                                   (default: 125)</span><br><span class="line">    -u, --pipeline.batch.delay DELAY_IN_MS When creating pipeline batches, how long to <span class="built_in">wait</span> <span class="keyword">while</span> polling</span><br><span class="line">                                  <span class="keyword">for</span> the next event.</span><br><span class="line">                                   (default: 50)</span><br><span class="line">    --pipeline.unsafe_shutdown    Force logstash to <span class="built_in">exit</span> during shutdown even</span><br><span class="line">                                  <span class="keyword">if</span> there are still inflight events <span class="keyword">in</span> memory.</span><br><span class="line">                                  By default, logstash will refuse to quit until all</span><br><span class="line">                                  received events have been pushed to the outputs.</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    --path.data PATH              This should point to a writable directory. Logstash</span><br><span class="line">                                  will use this directory whenever it needs to store</span><br><span class="line">                                  data. Plugins will also have access to this path.</span><br><span class="line">                                   (default: <span class="string">"/data/knner/logstash/data"</span>)</span><br><span class="line">    -p, --path.plugins PATH       A path of <span class="built_in">where</span> to find plugins. This flag</span><br><span class="line">                                  can be given multiple <span class="built_in">times</span> to include</span><br><span class="line">                                  multiple paths. Plugins are expected to be</span><br><span class="line">                                  <span class="keyword">in</span> a specific directory hierarchy:</span><br><span class="line">                                  <span class="string">'PATH/logstash/TYPE/NAME.rb'</span> <span class="built_in">where</span> TYPE is</span><br><span class="line">                                  <span class="string">'inputs'</span> <span class="string">'filters'</span>, <span class="string">'outputs'</span> or <span class="string">'codecs'</span></span><br><span class="line">                                  and NAME is the name of the plugin.</span><br><span class="line">                                   (default: [])</span><br><span class="line">    -l, --path.logs PATH          Write logstash internal logs to the given</span><br><span class="line">                                  file. Without this flag, logstash will emit</span><br><span class="line">                                  logs to standard output.</span><br><span class="line">                                   (default: <span class="string">"/data/knner/logstash/logs"</span>)</span><br><span class="line">    --log.level LEVEL             Set the <span class="built_in">log</span> level <span class="keyword">for</span> logstash. Possible values are:</span><br><span class="line">                                    - fatal</span><br><span class="line">                                    - error</span><br><span class="line">                                    - warn</span><br><span class="line">                                    - info</span><br><span class="line">                                    - debug</span><br><span class="line">                                    - trace</span><br><span class="line">                                   (default: <span class="string">"info"</span>)</span><br><span class="line">    --config.debug                Print the compiled config ruby code out as a debug <span class="built_in">log</span> (you must also have --log.level=debug enabled).</span><br><span class="line">                                  WARNING: This will include any <span class="string">'password'</span> options passed to plugin configs as plaintext, and may result</span><br><span class="line">                                  <span class="keyword">in</span> plaintext passwords appearing <span class="keyword">in</span> your logs!</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    -i, --interactive SHELL       Drop to shell instead of running as normal.</span><br><span class="line">                                  Valid shells are <span class="string">"irb"</span> and <span class="string">"pry"</span></span><br><span class="line">    -V, --version                 Emit the version of logstash and its friends,</span><br><span class="line">                                  <span class="keyword">then</span> <span class="built_in">exit</span>.</span><br><span class="line">    -t, --config.test_and_exit    Check configuration <span class="keyword">for</span> valid syntax and <span class="keyword">then</span> <span class="built_in">exit</span>.</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    -r, --config.reload.automatic Monitor configuration changes and reload</span><br><span class="line">                                  whenever it is changed.</span><br><span class="line">                                  NOTE: use SIGHUP to manually reload the config</span><br><span class="line">                                   (default: <span class="literal">false</span>)</span><br><span class="line">    --config.reload.interval RELOAD_INTERVAL How frequently to poll the configuration location</span><br><span class="line">                                  <span class="keyword">for</span> changes, <span class="keyword">in</span> seconds.</span><br><span class="line">                                   (default: 3000000000)</span><br><span class="line">    --http.host HTTP_HOST         Web API binding host (default: <span class="string">"127.0.0.1"</span>)</span><br><span class="line">    --http.port HTTP_PORT         Web API http port (default: 9600..9700)</span><br><span class="line">    --log.format FORMAT           Specify <span class="keyword">if</span> Logstash should write its own logs <span class="keyword">in</span> JSON form (one</span><br><span class="line">                                  event per line) or <span class="keyword">in</span> plain text (using Ruby<span class="string">'s Object#inspect)</span></span><br><span class="line"><span class="string">                                   (default: "plain")</span></span><br><span class="line"><span class="string">    --path.settings SETTINGS_DIR  Directory containing logstash.yml file. This can also be</span></span><br><span class="line"><span class="string">                                  set through the LS_SETTINGS_DIR environment variable.</span></span><br><span class="line"><span class="string">                                   (default: "/data/knner/logstash/config")</span></span><br><span class="line"><span class="string">    --verbose                     Set the log level to info.</span></span><br><span class="line"><span class="string">                                  DEPRECATED: use --log.level=info instead.</span></span><br><span class="line"><span class="string">    --debug                       Set the log level to debug.</span></span><br><span class="line"><span class="string">                                  DEPRECATED: use --log.level=debug instead.</span></span><br><span class="line"><span class="string">    --quiet                       Set the log level to info.</span></span><br><span class="line"><span class="string">                                  DEPRECATED: use --log.level=info instead.</span></span><br><span class="line"><span class="string">    -h, --help                    print help</span></span><br></pre></td></tr></table></figure>

<p>启动Logstash：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> logstash</span><br><span class="line">$ ./bin/logstash -f config/filebeat-kafka.conf &amp;</span><br></pre></td></tr></table></figure>

<p>因为我们将日志输出到了ES的filebeat-kafka的index中，我们去Kibana中增加:<code>filebeat-kafka-*</code> index。</p>
<p>然后查看kibana，日志都已经收集到了，之前的busybox的message也解析正常。</p>
<h3 id="在Kubernetes环境中运行Logstash"><a href="#在Kubernetes环境中运行Logstash" class="headerlink" title="在Kubernetes环境中运行Logstash"></a>在Kubernetes环境中运行Logstash</h3><p>如果你想在Kubernetes中跑Logstash，请参考：</p>
<blockquote>
<p>可以使用非官方的Chart：</p>
<p><a href="https://hub.kubeapps.com/charts/bitnami/logstash/0.2.3" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/bitnami/logstash/0.2.3</a> 对应logstash7.4.2</p>
<p><a href="https://hub.kubeapps.com/charts/bitnami/logstash/0.2.4" target="_blank" rel="noopener">https://hub.kubeapps.com/charts/bitnami/logstash/0.2.4</a> 对应logstash7.5.0</p>
<p>官方的Chart：</p>
<p><a href="https://github.com/elastic/helm-charts" target="_blank" rel="noopener">https://github.com/elastic/helm-charts</a> 不过只有最新版本的7.5</p>
</blockquote>
<p>这里使用elastic 官方的logstash 7.5.0 helm chart更改image版本为7.4.2而成的。</p>
<p>添加Helm repo：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line">$ helm repo add elastic https://helm.elastic.co</span><br><span class="line">$ helm repo list</span><br><span class="line">NAME    	URL                                     </span><br><span class="line">stable  	http://mirror.azure.cn/kubernetes/charts</span><br><span class="line">elastic 	https://helm.elastic.co                 </span><br><span class="line">bitnami 	https://charts.bitnami.com/bitnami      </span><br><span class="line">jetstack	https://charts.jetstack.io              </span><br><span class="line">$ helm repo update </span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">"stable"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"elastic"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"jetstack"</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">"bitnami"</span> chart repository</span><br><span class="line">Update Complete. ⎈ Happy Helming!⎈</span><br></pre></td></tr></table></figure>

<p>下载elastic/logstash:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm search repo logstash</span><br><span class="line">NAME                 	CHART VERSION	APP VERSION	DESCRIPTION                                       </span><br><span class="line">bitnami/logstash     	0.2.4        	7.5.0      	Logstash is an open <span class="built_in">source</span>, server-side data pr...</span><br><span class="line">elastic/logstash     	7.5.0        	7.5.0      	Official Elastic helm chart <span class="keyword">for</span> Logstash          </span><br><span class="line">stable/dmarc2logstash	1.2.0        	1.0.3      	Provides a POP3-polled DMARC XML report injecto...</span><br><span class="line">stable/logstash      	2.3.0        	7.1.1      	Logstash is an open <span class="built_in">source</span>, server-side data pr...</span><br><span class="line"></span><br><span class="line">$ helm pull elastic/logstash</span><br></pre></td></tr></table></figure>

<p>编辑values.yaml：</p>
<figure class="highlight yaml"><figcaption><span>values.yaml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="attr">logstashPipeline:</span></span><br><span class="line">  <span class="attr">uptime.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">input</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">kafka</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">bootstrap_servers</span> <span class="string">=&gt;</span> <span class="string">"172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094"</span></span><br><span class="line">        <span class="string">client_id</span> <span class="string">=&gt;</span> <span class="string">"$&#123;LOGSTASH_ID&#125;"</span></span><br><span class="line">        <span class="string">topics</span> <span class="string">=&gt;</span> <span class="string">["filebeat"]</span></span><br><span class="line">        <span class="string">group_id</span> <span class="string">=&gt;</span> <span class="string">"logstash"</span></span><br><span class="line">        <span class="string">decorate_events</span> <span class="string">=&gt;</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">codec</span> <span class="string">=&gt;</span> <span class="string">"json"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">output</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">hosts</span> <span class="string">=&gt;</span> <span class="string">["172.17.0.87:9200","172.17.0.87:9201","172.17.0.87:9202"]</span> <span class="comment"># 不知如何使用环境变量的方式</span></span><br><span class="line">        <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">"filebeat-kafka-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>"</span></span><br><span class="line">        <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">"$&#123;XPACK_MONITORING_ELASTICSEARCH_USERNAME&#125;"</span></span><br><span class="line">        <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">"$&#123;XPACK_MONITORING_ELASTICSEARCH_PASSWORD&#125;"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">extraEnvs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_LEVEL</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">info</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ENABLED</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_HOSTS</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">'"172.17.0.87:9200","172.17.0.87:9201","172.17.0.87:9202"'</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_USERNAME</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_PASSWORD</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">admin123</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGSTASH_ID</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">fieldRef:</span></span><br><span class="line">        <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"></span><br><span class="line"><span class="attr">image:</span> <span class="string">"docker.elastic.co/logstash/logstash"</span></span><br><span class="line"><span class="attr">imageTag:</span> <span class="string">"7.4.2"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumeClaimTemplate:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-client</span></span><br><span class="line">  <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteMany"</span> <span class="string">]</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<p>从哪里知道，docker image支持哪些环境变量呢？</p>
<p>Docker 启动脚本：</p>
<p><a href="https://github.com/elastic/logstash/tree/7.4/docker/data/logstash/bin" target="_blank" rel="noopener">https://github.com/elastic/logstash/tree/7.4/docker/data/logstash/bin</a></p>
<p>主要有两个：</p>
<ol>
<li><p>环境变量转换到配置文件</p>
<p>env2yaml /usr/share/logstash/config/logstash.yml</p>
</li>
<li><p>启动logstash</p>
</li>
</ol>
<p>关于logstash docker环境变量的配置：</p>
<p><a href="https://github.com/elastic/logstash/blob/7.4/docker/data/logstash/env2yaml/env2yaml.go" target="_blank" rel="noopener">https://github.com/elastic/logstash/blob/7.4/docker/data/logstash/env2yaml/env2yaml.go</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">XPACK_MONITORING_ENABLED</span><br><span class="line">XPACK_MONITORING_ELASTICSEARCH_HOSTS</span><br><span class="line">XPACK_MONITORING_ELASTICSEARCH_USERNAME</span><br><span class="line">XPACK_MONITORING_ELASTICSEARCH_PASSWORD</span><br><span class="line"></span><br><span class="line">分别对应配置：</span><br><span class="line">&quot;xpack.monitoring.enabled&quot;,</span><br><span class="line">&quot;xpack.monitoring.elasticsearch.hosts&quot;,</span><br><span class="line">&quot;xpack.monitoring.elasticsearch.username&quot;,</span><br><span class="line">&quot;xpack.monitoring.elasticsearch.password&quot;,</span><br><span class="line"></span><br><span class="line">规则：全部大写，点和下划线互换。</span><br></pre></td></tr></table></figure>



<p>Helm dry-run 查看：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">logstash</span> <span class="string">./</span> <span class="string">--dry-run</span> <span class="string">--debug</span></span><br><span class="line"><span class="attr">install.go:148:</span> <span class="string">[debug]</span> <span class="attr">Original chart version:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">install.go:165:</span> <span class="string">[debug]</span> <span class="attr">CHART PATH:</span> <span class="string">/home/knner/kubernetes/felk/logstash/logstash-7.5.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NAME:</span> <span class="string">logstash</span></span><br><span class="line"><span class="attr">LAST DEPLOYED:</span> <span class="string">Thu</span> <span class="string">Dec</span> <span class="number">12</span> <span class="number">15</span><span class="string">:29:12</span> <span class="number">2019</span></span><br><span class="line"><span class="attr">NAMESPACE:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">STATUS:</span> <span class="string">pending-install</span></span><br><span class="line"><span class="attr">REVISION:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">TEST SUITE:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">USER-SUPPLIED VALUES:</span></span><br><span class="line"><span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">COMPUTED VALUES:</span></span><br><span class="line"><span class="attr">antiAffinity:</span> <span class="string">hard</span></span><br><span class="line"><span class="attr">antiAffinityTopologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line"><span class="attr">extraContainers:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">extraEnvs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_LEVEL</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">warn</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ENABLED</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_HOSTS</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">'"172.17.0.87:9200","172.17.0.87:9201","172.17.0.87:9202"'</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_USERNAME</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_PASSWORD</span></span><br><span class="line">  <span class="attr">value:</span> <span class="string">admin123</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGSTASH_ID</span></span><br><span class="line">  <span class="attr">valueFrom:</span></span><br><span class="line">    <span class="attr">fieldRef:</span></span><br><span class="line">      <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line"><span class="attr">extraInitContainers:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">extraVolumeMounts:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">extraVolumes:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">fullnameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">httpPort:</span> <span class="number">9600</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash</span></span><br><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">imagePullSecrets:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">imageTag:</span> <span class="number">7.4</span><span class="number">.2</span></span><br><span class="line"><span class="attr">labels:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">lifecycle:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">300</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">logstashConfig:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">logstashJavaOpts:</span> <span class="string">-Xmx1g</span> <span class="string">-Xms1g</span></span><br><span class="line"><span class="attr">logstashPipeline:</span></span><br><span class="line">  <span class="attr">uptime.conf:</span> <span class="string">"input &#123;\n  kafka &#123;\n    bootstrap_servers =&gt; \"172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094\"\n</span></span><br><span class="line"><span class="string">    \   client_id =&gt; \"$&#123;LOGSTASH_ID&#125;\"\n    topics =&gt; [\"filebeat\"]\n    group_id</span></span><br><span class="line"><span class="string">    =&gt; \"logstash\"\n    decorate_events =&gt; true\n    codec =&gt; \"json\"\n  &#125;\n&#125;\n\noutput</span></span><br><span class="line"><span class="string">    &#123;\n  elasticsearch &#123;\n    hosts =&gt; [\"172.17.0.87:9200\",\"172.17.0.87:9201\",\"172.17.0.87:9202\"]\n</span></span><br><span class="line"><span class="string">    \   index =&gt; \"filebeat-kafka-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>\"\n    user =&gt; \"$&#123;XPACK_MONITORING_ELASTICSEARCH_USERNAME&#125;\"\n</span></span><br><span class="line"><span class="string">    \   password =&gt; \"$&#123;XPACK_MONITORING_ELASTICSEARCH_PASSWORD&#125;\"\n  &#125;  \n&#125;\n"</span></span><br><span class="line"><span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">nameOverride:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">nodeAffinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">persistence:</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line"><span class="attr">podSecurityContext:</span></span><br><span class="line">  <span class="attr">fsGroup:</span> <span class="number">1000</span></span><br><span class="line">  <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">podSecurityPolicy:</span></span><br><span class="line">  <span class="attr">create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">fsGroup:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">runAsUser:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">    <span class="attr">seLinux:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">    <span class="attr">supplementalGroups:</span></span><br><span class="line">      <span class="attr">rule:</span> <span class="string">RunAsAny</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">secret</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">configMap</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">persistentVolumeClaim</span></span><br><span class="line"><span class="attr">priorityClassName:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line">  <span class="attr">create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line"><span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">1536Mi</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">1536Mi</span></span><br><span class="line"><span class="attr">schedulerName:</span> <span class="string">""</span></span><br><span class="line"><span class="attr">secretMounts:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">capabilities:</span></span><br><span class="line">    <span class="attr">drop:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">  <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">annotations:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">terminationGracePeriod:</span> <span class="number">120</span></span><br><span class="line"><span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">updateStrategy:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">volumeClaimTemplate:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs-client</span></span><br><span class="line"></span><br><span class="line"><span class="attr">HOOKS:</span></span><br><span class="line"><span class="attr">MANIFEST:</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: logstash/templates/poddisruptionbudget.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">policy/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PodDisruptionBudget</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">"logstash-logstash-pdb"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxUnavailable:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: logstash/templates/configmap-pipeline.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logstash-logstash-pipeline</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">uptime.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">input</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">kafka</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">bootstrap_servers</span> <span class="string">=&gt;</span> <span class="string">"172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094"</span></span><br><span class="line">        <span class="string">client_id</span> <span class="string">=&gt;</span> <span class="string">"$&#123;LOGSTASH_ID&#125;"</span></span><br><span class="line">        <span class="string">topics</span> <span class="string">=&gt;</span> <span class="string">["filebeat"]</span></span><br><span class="line">        <span class="string">group_id</span> <span class="string">=&gt;</span> <span class="string">"logstash"</span></span><br><span class="line">        <span class="string">decorate_events</span> <span class="string">=&gt;</span> <span class="literal">true</span></span><br><span class="line">        <span class="string">codec</span> <span class="string">=&gt;</span> <span class="string">"json"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">output</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">hosts</span> <span class="string">=&gt;</span> <span class="string">["172.17.0.87:9200","172.17.0.87:9201","172.17.0.87:9202"]</span></span><br><span class="line">        <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">"filebeat-kafka-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>"</span></span><br><span class="line">        <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">"$&#123;XPACK_MONITORING_ELASTICSEARCH_USERNAME&#125;"</span></span><br><span class="line">        <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">"$&#123;XPACK_MONITORING_ELASTICSEARCH_PASSWORD&#125;"</span></span><br><span class="line">      <span class="string">&#125;</span>  </span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: logstash/templates/service.yaml</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: logstash/templates/statefulset.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logstash-logstash</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">    <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">    <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">logstash-logstash</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">      <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">podManagementPolicy:</span> <span class="string">Parallel</span></span><br><span class="line">  <span class="attr">updateStrategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">RollingUpdate</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">logstash-logstash</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">nfs-client</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">        <span class="attr">chart:</span> <span class="string">"logstash"</span></span><br><span class="line">        <span class="attr">heritage:</span> <span class="string">"Helm"</span></span><br><span class="line">        <span class="attr">release:</span> <span class="string">"logstash"</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="attr">pipelinechecksum:</span> <span class="string">ad971ab08f50f0c2dfa05246e11c97764cad8b47e4c904206176cb4006655da</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">securityContext:</span></span><br><span class="line">        <span class="attr">fsGroup:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">              <span class="attr">matchExpressions:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">            <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">120</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logstashpipeline</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">logstash-logstash-pipeline</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"logstash"</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">capabilities:</span></span><br><span class="line">            <span class="attr">drop:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">ALL</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">"docker.elastic.co/logstash/logstash:7.4.2"</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">"IfNotPresent"</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">300</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">9600</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1536Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1536Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LS_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"-Xmx1g -Xms1g"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOG_LEVEL</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">warn</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_HOSTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">'"172.17.0.87:9200","172.17.0.87:9201","172.17.0.87:9202"'</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_USERNAME</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">admin</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">XPACK_MONITORING_ELASTICSEARCH_PASSWORD</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">admin123</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">LOGSTASH_ID</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"logstash-logstash"</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/usr/share/logstash/data</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">logstashpipeline</span></span><br><span class="line">            <span class="attr">mountPath:</span> <span class="string">/usr/share/logstash/pipeline/uptime.conf</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">uptime.conf</span></span><br></pre></td></tr></table></figure>

<p>然后安装即可：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ helm install logstash ./</span><br></pre></td></tr></table></figure>



<h2 id="示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中"><a href="#示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中" class="headerlink" title="示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中"></a>示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中</h2><h3 id="前提依赖，安装nginx-ingress-controller"><a href="#前提依赖，安装nginx-ingress-controller" class="headerlink" title="前提依赖，安装nginx-ingress-controller"></a>前提依赖，安装nginx-ingress-controller</h3><ul>
<li>安装nginx-ingress-controller，请参考：<a href="/2019/11/14/Pre-trial-helm3.html" title="抢先试用Helm3，并安装nginx-ingress-controller’ %}&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;配置nginx-ingress-controller-日志格式为JSON&quot;&gt;&lt;a href=&quot;#配置nginx-ingress-controller-日志格式为JSON&quot; class=&quot;headerlink&quot; title=&quot;配置nginx-ingress-controller 日志格式为JSON&quot;&gt;&lt;&#x2F;a&gt;配置nginx-ingress-controller 日志格式为JSON&lt;&#x2F;h3&gt;&lt;p&gt;我们首先配置nginx-ingress-controller的日志格式为Json格式的，这样方便解析。&lt;&#x2F;p&gt;
&lt;p&gt;确定nginx-ingress-controller的configmap名称：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl -n kube-system get po nginx-ingress-controller-flzpt -o yaml --&lt;span class=&quot;built_in&quot;&gt;export&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt;

&lt;p&gt;找到如下的配置：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;attr&quot;&gt;args:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;&#x2F;nginx-ingress-controller&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--default-backend-service=kube-system&#x2F;nginx-ingress-default-backend&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--election-id=ingress-controller-leader&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--ingress-class=nginx&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--configmap=kube-system&#x2F;nginx-ingress-controller&lt;&#x2F;span&gt; &lt;span class=&quot;comment&quot;&gt;# 配置的configmap名为：nginx-ingress-controller在kube-system 名称空间下，如果没有的话可以手动添加。&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt;

&lt;p&gt;编辑或者新建configmap：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;$&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;kubectl&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;-n&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;kube-system&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;get&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;cm&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;nginx-ingress-controller&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;-o&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;yaml&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--export&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;v1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;data:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;log-format-upstream:&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#123; @timestamp: $time_iso8601,client: $remote_addr,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; remoteUser: $remote_user, request: $request, requestMethod: $request_method,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; url: $uri, status: $status, size: $body_bytes_sent, domain: $host,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; serverAddr: $server_addr, responseTime: $request_time, httpReferrer:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; $http_referer, http_x_forwarded_for: $http_x_forwarded_for, upstreamHost:$upstream_addr,upstreamStatus:$upstream_status,upstreamResponseTime:$upstream_response_time,httpUserAgent:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; $http_user_agent &amp;#125;&#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;kind:&lt;&#x2F;span&gt; &lt;span class=string&gt;ConfigMap&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;name:&lt;&#x2F;span&gt; &lt;span class=string&gt;nginx-ingress-controller&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;配置nginx-ingress-controller pod的annotations，来单独的自定义日志格式：&lt;&#x2F;p&gt; &lt;p&gt;因为我们是通过Helm3安装的，所以更改values.yaml配置：&lt;&#x2F;p&gt; &lt;figure class=highlight yaml&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;&lt;span class=attr&gt;podAnnotations:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;enabled:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.fields:&lt;&#x2F;span&gt; &lt;span class=string&gt;message&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.add_error_key:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.overwrite_keys:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.target:&lt;&#x2F;span&gt; &lt;span class=string&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;然后升级：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ helm -n kube-system upgrade nginx-ingress-controller .&#x2F;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;h3 id=filebeat配置，采用自动发现，输出到kafka&gt;&lt;a href=#filebeat配置，采用自动发现，输出到kafka class=headerlink title=filebeat配置，采用自动发现，输出到kafka&gt;&lt;&#x2F;a&gt;filebeat配置，采用自动发现，输出到kafka&lt;&#x2F;h3&gt;&lt;p&gt;配置还是跟上面的一样：&lt;&#x2F;p&gt; &lt;figure class=highlight yaml&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;&lt;span class=meta&gt;---&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;apiVersion:&lt;&#x2F;span&gt; &lt;span class=string&gt;v1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;kind:&lt;&#x2F;span&gt; &lt;span class=string&gt;ConfigMap&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;name:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat-config&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;namespace:&lt;&#x2F;span&gt; &lt;span class=string&gt;kube-system&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;labels:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;k8s-app:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;data:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;filebeat.yml:&lt;&#x2F;span&gt; &lt;span class=string&gt;|-&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;filebeat.autodiscover:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;providers:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;type:&lt;&#x2F;span&gt; &lt;span class=string&gt;kubernetes&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;host:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;NODE_NAME&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hints.enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hints.default_config:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;type:&lt;&#x2F;span&gt; &lt;span class=string&gt;container&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;paths:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=string&gt;&#x2F;var&#x2F;log&#x2F;containers&#x2F;*$&amp;#123;data.kubernetes.container.id&amp;#125;.log&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;processors:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;add_cloud_metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;add_host_metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;cloud.id:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTIC_CLOUD_ID&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;cloud.auth:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTIC_CLOUD_AUTH&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;elasticsearch:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;false&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hosts:&lt;&#x2F;span&gt; &lt;span class=string&gt;[$&amp;#123;ELASTICSEARCH_HOST:elasticsearch&amp;#125;:$&amp;#123;ELASTICSEARCH_PORT:9200&amp;#125;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;username:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTICSEARCH_USERNAME&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;password:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTICSEARCH_PASSWORD&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;indices:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;index:&lt;&#x2F;span&gt; &lt;span class=string&gt;busybox-&lt;span class=template-variable&quot;&gt;%&amp;#123;+yyyy.MM.dd&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&quot;&gt; &lt;span class=attr&gt;when.regexp:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;kubernetes.labels.app:&lt;&#x2F;span&gt; &lt;span class=string&gt;busybox.*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;kafka:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hosts:&lt;&#x2F;span&gt; &lt;span class=string&gt;[172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;topic:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;max_message_bytes:&lt;&#x2F;span&gt; &lt;span class=number&gt;5242880&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;partition.round_robin:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;reachable_only:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;keep-alive:&lt;&#x2F;span&gt; &lt;span class=number&gt;120&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;required_acks:&lt;&#x2F;span&gt; &lt;span class=number&gt;1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;h3 id=logstash配置&gt;&lt;a href=#logstash配置 class=headerlink title=logstash配置&gt;&lt;&#x2F;a&gt;logstash配置&lt;&#x2F;h3&gt;&lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;input &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; bootstrap_servers =&gt; &quot;kafka01:9092,kafka02:9093,kafka03:9094&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; client_id =&gt; &quot;logstash01&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topics =&gt; [&quot;filebeat&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; group_id =&gt; &quot;logstash&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; decorate_events =&gt; true&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; codec =&gt; &quot;json&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;filter &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [kubernetes][labels][app] == &quot;nginx-ingress&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; geoip &amp;#123; # 增加geoip filter，获取地理位置&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; source =&gt; &quot;client&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; target =&gt; &quot;geoip&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; database =&gt; &quot;&#x2F;data&#x2F;knner&#x2F;logstash&#x2F;config&#x2F;GeoLite2-City_20191210&#x2F;GeoLite2-City.mmdb&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; useragent &amp;#123; # 增加useragent filter 获取用户设备信息&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; source =&gt; &quot;httpUserAgent&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; target =&gt; &quot;ua&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; mutate &amp;#123; # 类型转换&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; convert =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;responseTime&quot; =&gt; &quot;float&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;upstreamResponseTime&quot; =&gt; &quot;float&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;upstreamStatus&quot; =&gt; &quot;integer&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; clone &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 克隆处理好的nginx access日志，clones 必填参数，增加type字段=nginx_clone&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; clones =&gt; [&quot;nginx_clone&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 为什么要用@metadata方式呢，因为在输出的时候，@metadata信息会被去掉，从而不会增删原有clone的event。&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [type] == &quot;nginx_clone&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; mutate &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; add_field =&gt; &amp;#123; &quot;[@metadata][clone]&quot; =&gt; &quot;nginx_clone&quot; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;output &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # clone的一份存入kafka nginx topic中，方便其他工具订阅，用于实时分析。&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [@metadata][clone] == &quot;nginx_clone&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; bootstrap_servers =&gt; &quot;172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; acks =&gt; &quot;1&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic_id =&gt; &quot;nginx&quot; &lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; codec =&gt; &quot;json&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; client_id =&gt; &quot;logstash-provider&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 原始的那份，还是输出到es中&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; else if [kubernetes][labels][app] == &quot;nginx-ingress&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;nginx-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125; &lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; else &amp;#123; # 默认还是输出到filebeat 这个index中&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;filebeat-kafka-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;上面的filters配置，参考官网：&lt;&#x2F;p&gt; &lt;blockquote&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-geoip.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-geoip.html&lt;&#x2F;a&gt; geoip&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-useragent.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-useragent.html&lt;&#x2F;a&gt; useragent&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-mutate.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-mutate.html&lt;&#x2F;a&gt; mutate&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-clone.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-clone.html&lt;&#x2F;a&gt; clone&lt;&#x2F;p&gt; &lt;&#x2F;blockquote&gt; &lt;p&gt;创建nginx topic：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --create --topic nginx --partitions 5 --replication-factor 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;Created topic &lt;span class=string&gt;nginx&lt;&#x2F;span&gt;.&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --list&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;__consumer_offsets&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;filebeat&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;my-replicated-topic&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;nginx&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=built_in&gt;test&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --describe --topic nginx&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;Topic:nginx PartitionCount:5 ReplicationFactor:1 Configs:&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 0 Leader: 0 Replicas: 0 Isr: 0&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 1 Leader: 1 Replicas: 1 Isr: 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 2 Leader: 2 Replicas: 2 Isr: 2&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 3 Leader: 0 Replicas: 0 Isr: 0&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 4 Leader: 1 Replicas: 1 Isr: 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;开启consumer消费者nginx，看看是否有日志过来：&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic nginx --group hahaha&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;注意1：&lt;&#x2F;p&gt; &lt;p&gt;useragent，需要指定target，如果不指定默认是agent，跟现有的会冲突。&lt;&#x2F;p&gt; &lt;p&gt;target =&gt; “ua”&lt;&#x2F;p&gt; &lt;p&gt;注意2：&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;filebeat-refresh-fields.png alt=&gt;&lt;&#x2F;p&gt; &lt;p&gt;刷新字段列表，如上图，然后再次测试，再不行，可能需要删掉索引，或者等到明天生成新的索引。&lt;&#x2F;p&gt; &lt;p&gt;t代表string，#代表number&lt;&#x2F;p&gt; &lt;p&gt;注意3：&lt;&#x2F;p&gt; &lt;p&gt;不要用[@metadata][type]，会出现如下情况：所以在output的时候会失败。&lt;&#x2F;p&gt; &lt;figure class=highlight&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;@metadata =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; version =&gt; 7.4.1,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; offset =&gt; 1705864,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; timestamp =&gt; 1576243966000,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; partition =&gt; 4,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; key =&gt; nil,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; consumer_group =&gt; logstash,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic =&gt; filebeat&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic =&gt; filebeat,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; beat =&gt; filebeat,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; type =&gt; [ # 多个类型了&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; [&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=number&gt;0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ] _doc,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; [&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=number&gt;1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ] &lt;span class=string&gt;nginx_clone&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;在kibana中查看&lt;code&gt;filebeat-kafka-*&lt;&#x2F;code&gt;，搜索：&lt;code&gt;kubernetes.labels.app:&quot;nginx-ingress&quot;&lt;&#x2F;code&gt; 字段如下：&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;nginx-fields.png alt=&gt;&lt;&#x2F;p&gt; &lt;p&gt;开启consumer消费者nginx，看看是否有日志过来：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic nginx --group hahaha&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;我们发现和nginx access的处理后的日志是一样的，存在了nginx 这个topic中，方便其他流处理工具实时计算。当然，其他的业务系统的日志也可以采取类似的操作。&lt;&#x2F;p&gt; &lt;h2 id=动态输入到ES-index中&gt;&lt;a href=#动态输入到ES-index中 class=headerlink title=动态输入到ES index中&gt;&lt;&#x2F;a&gt;动态输入到ES index中&lt;&#x2F;h2&gt;&lt;p&gt;如果我想每个服务都输出到单独的ES index中，但我有不想通过if else进行判断，如何操作呢？&lt;&#x2F;p&gt; &lt;p&gt;logstash配置：&lt;&#x2F;p&gt; &lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;output &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;%&amp;#123;[kubernetes][labels][env]&amp;#125;_%&amp;#123;[kubernetes][labels][app]&amp;#125;-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;如上，会分别获取kubernetes.labels.env和kubernetes.labels.app字段的名称，然后动态的拼接。例如kubernetes.labels.env=pre，kubernetes.labels.app=nginx-ingress，那么最后的index就是：pre_nginx-ingress-2019.12.17类似这样的。&lt;&#x2F;p&gt; &lt;p&gt;当然，你需要在你的pod上有对应的label才可以。&lt;&#x2F;p&gt; &lt;p&gt;如果你是用filebeat直接输出到elasticsearch中，也想使用这种动态的index配置呢？&lt;&#x2F;p&gt; &lt;p&gt;filebeat配置：&lt;&#x2F;p&gt; &lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;output.elasticsearch:&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts: [&amp;apos;$&amp;#123;ELASTICSEARCH_HOST:elasticsearch&amp;#125;:$&amp;#123;ELASTICSEARCH_PORT:9200&amp;#125;&amp;apos;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index: &quot;%&amp;#123;kubernetes.labels.env&amp;#125;_%&amp;#123;kubernetes.labels.app&amp;#125;-%&amp;#123;+yyyy.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; username: $&amp;#123;ELASTICSEARCH_USERNAME&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password: $&amp;#123;ELASTICSEARCH_PASSWORD&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;hr&gt; &lt;blockquote&gt; &lt;p&gt;本文到这里就结束了，欢迎期待后面的文章。您可以关注下方的公众号二维码，在第一时间查看新文章。&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;knner&#x2F;wx.jpg alt=公众号&gt;&lt;&#x2F;p&gt; &lt;&#x2F;blockquote&gt;">抢先试用Helm3，并安装nginx-ingress-controller’ %}&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;配置nginx-ingress-controller-日志格式为JSON&quot;&gt;&lt;a href=&quot;#配置nginx-ingress-controller-日志格式为JSON&quot; class=&quot;headerlink&quot; title=&quot;配置nginx-ingress-controller 日志格式为JSON&quot;&gt;&lt;&#x2F;a&gt;配置nginx-ingress-controller 日志格式为JSON&lt;&#x2F;h3&gt;&lt;p&gt;我们首先配置nginx-ingress-controller的日志格式为Json格式的，这样方便解析。&lt;&#x2F;p&gt;
&lt;p&gt;确定nginx-ingress-controller的configmap名称：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ kubectl -n kube-system get po nginx-ingress-controller-flzpt -o yaml --&lt;span class=&quot;built_in&quot;&gt;export&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt;

&lt;p&gt;找到如下的配置：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;containers:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;attr&quot;&gt;args:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;&#x2F;nginx-ingress-controller&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--default-backend-service=kube-system&#x2F;nginx-ingress-default-backend&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--election-id=ingress-controller-leader&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--ingress-class=nginx&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;bullet&quot;&gt;-&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--configmap=kube-system&#x2F;nginx-ingress-controller&lt;&#x2F;span&gt; &lt;span class=&quot;comment&quot;&gt;# 配置的configmap名为：nginx-ingress-controller在kube-system 名称空间下，如果没有的话可以手动添加。&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt;

&lt;p&gt;编辑或者新建configmap：&lt;&#x2F;p&gt;
&lt;figure class=&quot;highlight yaml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;$&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;kubectl&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;-n&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;kube-system&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;get&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;cm&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;nginx-ingress-controller&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;-o&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;yaml&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;--export&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;apiVersion:&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;v1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;attr&quot;&gt;data:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;attr&quot;&gt;log-format-upstream:&lt;&#x2F;span&gt; &lt;span class=&quot;string&quot;&gt;&amp;#123; @timestamp: $time_iso8601,client: $remote_addr,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; remoteUser: $remote_user, request: $request, requestMethod: $request_method,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; url: $uri, status: $status, size: $body_bytes_sent, domain: $host,&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; serverAddr: $server_addr, responseTime: $request_time, httpReferrer:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; $http_referer, http_x_forwarded_for: $http_x_forwarded_for, upstreamHost:$upstream_addr,upstreamStatus:$upstream_status,upstreamResponseTime:$upstream_response_time,httpUserAgent:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=string&gt; $http_user_agent &amp;#125;&#39;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;kind:&lt;&#x2F;span&gt; &lt;span class=string&gt;ConfigMap&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;name:&lt;&#x2F;span&gt; &lt;span class=string&gt;nginx-ingress-controller&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;配置nginx-ingress-controller pod的annotations，来单独的自定义日志格式：&lt;&#x2F;p&gt; &lt;p&gt;因为我们是通过Helm3安装的，所以更改values.yaml配置：&lt;&#x2F;p&gt; &lt;figure class=highlight yaml&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;&lt;span class=attr&gt;podAnnotations:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;enabled:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.fields:&lt;&#x2F;span&gt; &lt;span class=string&gt;message&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.add_error_key:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.overwrite_keys:&lt;&#x2F;span&gt; &lt;span class=string&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;co.elastic.logs&#x2F;processors.1.decode_json_fields.target:&lt;&#x2F;span&gt; &lt;span class=string&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;然后升级：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ helm -n kube-system upgrade nginx-ingress-controller .&#x2F;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;h3 id=filebeat配置，采用自动发现，输出到kafka&gt;&lt;a href=#filebeat配置，采用自动发现，输出到kafka class=headerlink title=filebeat配置，采用自动发现，输出到kafka&gt;&lt;&#x2F;a&gt;filebeat配置，采用自动发现，输出到kafka&lt;&#x2F;h3&gt;&lt;p&gt;配置还是跟上面的一样：&lt;&#x2F;p&gt; &lt;figure class=highlight yaml&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;&lt;span class=meta&gt;---&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;apiVersion:&lt;&#x2F;span&gt; &lt;span class=string&gt;v1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;kind:&lt;&#x2F;span&gt; &lt;span class=string&gt;ConfigMap&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;name:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat-config&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;namespace:&lt;&#x2F;span&gt; &lt;span class=string&gt;kube-system&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;labels:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;k8s-app:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=attr&gt;data:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;filebeat.yml:&lt;&#x2F;span&gt; &lt;span class=string&gt;|-&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;filebeat.autodiscover:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;providers:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;type:&lt;&#x2F;span&gt; &lt;span class=string&gt;kubernetes&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;host:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;NODE_NAME&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hints.enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hints.default_config:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;type:&lt;&#x2F;span&gt; &lt;span class=string&gt;container&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;paths:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=string&gt;&#x2F;var&#x2F;log&#x2F;containers&#x2F;*$&amp;#123;data.kubernetes.container.id&amp;#125;.log&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;processors:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;add_cloud_metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;add_host_metadata:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;cloud.id:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTIC_CLOUD_ID&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;cloud.auth:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTIC_CLOUD_AUTH&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;output:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;elasticsearch:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;false&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hosts:&lt;&#x2F;span&gt; &lt;span class=string&gt;[$&amp;#123;ELASTICSEARCH_HOST:elasticsearch&amp;#125;:$&amp;#123;ELASTICSEARCH_PORT:9200&amp;#125;]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;username:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTICSEARCH_USERNAME&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;password:&lt;&#x2F;span&gt; &lt;span class=string&gt;$&amp;#123;ELASTICSEARCH_PASSWORD&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;indices:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=bullet&gt;-&lt;&#x2F;span&gt; &lt;span class=attr&gt;index:&lt;&#x2F;span&gt; &lt;span class=string&gt;busybox-&lt;span class=template-variable&quot;&gt;%&amp;#123;+yyyy.MM.dd&amp;#125;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&quot;&gt; &lt;span class=attr&gt;when.regexp:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;kubernetes.labels.app:&lt;&#x2F;span&gt; &lt;span class=string&gt;busybox.*&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;kafka:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;enabled:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;hosts:&lt;&#x2F;span&gt; &lt;span class=string&gt;[172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094]&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;topic:&lt;&#x2F;span&gt; &lt;span class=string&gt;filebeat&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;max_message_bytes:&lt;&#x2F;span&gt; &lt;span class=number&gt;5242880&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;partition.round_robin:&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;reachable_only:&lt;&#x2F;span&gt; &lt;span class=literal&gt;true&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;keep-alive:&lt;&#x2F;span&gt; &lt;span class=number&gt;120&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=attr&gt;required_acks:&lt;&#x2F;span&gt; &lt;span class=number&gt;1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;h3 id=logstash配置&gt;&lt;a href=#logstash配置 class=headerlink title=logstash配置&gt;&lt;&#x2F;a&gt;logstash配置&lt;&#x2F;h3&gt;&lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;input &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; bootstrap_servers =&gt; &quot;kafka01:9092,kafka02:9093,kafka03:9094&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; client_id =&gt; &quot;logstash01&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topics =&gt; [&quot;filebeat&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; group_id =&gt; &quot;logstash&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; decorate_events =&gt; true&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; codec =&gt; &quot;json&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;filter &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [kubernetes][labels][app] == &quot;nginx-ingress&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; geoip &amp;#123; # 增加geoip filter，获取地理位置&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; source =&gt; &quot;client&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; target =&gt; &quot;geoip&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; database =&gt; &quot;&#x2F;data&#x2F;knner&#x2F;logstash&#x2F;config&#x2F;GeoLite2-City_20191210&#x2F;GeoLite2-City.mmdb&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; useragent &amp;#123; # 增加useragent filter 获取用户设备信息&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; source =&gt; &quot;httpUserAgent&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; target =&gt; &quot;ua&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; mutate &amp;#123; # 类型转换&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; convert =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;responseTime&quot; =&gt; &quot;float&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;upstreamResponseTime&quot; =&gt; &quot;float&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &quot;upstreamStatus&quot; =&gt; &quot;integer&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; clone &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 克隆处理好的nginx access日志，clones 必填参数，增加type字段=nginx_clone&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; clones =&gt; [&quot;nginx_clone&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 为什么要用@metadata方式呢，因为在输出的时候，@metadata信息会被去掉，从而不会增删原有clone的event。&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [type] == &quot;nginx_clone&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; mutate &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; add_field =&gt; &amp;#123; &quot;[@metadata][clone]&quot; =&gt; &quot;nginx_clone&quot; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;output &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # clone的一份存入kafka nginx topic中，方便其他工具订阅，用于实时分析。&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; if [@metadata][clone] == &quot;nginx_clone&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; bootstrap_servers =&gt; &quot;172.17.0.87:9092,172.17.0.87:9093,172.17.0.87:9094&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; acks =&gt; &quot;1&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic_id =&gt; &quot;nginx&quot; &lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; codec =&gt; &quot;json&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; client_id =&gt; &quot;logstash-provider&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; # 原始的那份，还是输出到es中&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; else if [kubernetes][labels][app] == &quot;nginx-ingress&quot; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;nginx-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125; &lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; else &amp;#123; # 默认还是输出到filebeat 这个index中&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;filebeat-kafka-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;上面的filters配置，参考官网：&lt;&#x2F;p&gt; &lt;blockquote&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-geoip.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-geoip.html&lt;&#x2F;a&gt; geoip&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-useragent.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-useragent.html&lt;&#x2F;a&gt; useragent&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-mutate.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-mutate.html&lt;&#x2F;a&gt; mutate&lt;&#x2F;p&gt; &lt;p&gt;&lt;a href=https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-clone.html&gt;https:&#x2F;&#x2F;www.elastic.co&#x2F;guide&#x2F;en&#x2F;logstash&#x2F;current&#x2F;plugins-filters-clone.html&lt;&#x2F;a&gt; clone&lt;&#x2F;p&gt; &lt;&#x2F;blockquote&gt; &lt;p&gt;创建nginx topic：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --create --topic nginx --partitions 5 --replication-factor 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;Created topic &lt;span class=string&gt;nginx&lt;&#x2F;span&gt;.&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --list&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;__consumer_offsets&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;filebeat&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;my-replicated-topic&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;nginx&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;span class=built_in&gt;test&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-topics.sh --zookeeper zk01:2181 --describe --topic nginx&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;Topic:nginx PartitionCount:5 ReplicationFactor:1 Configs:&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 0 Leader: 0 Replicas: 0 Isr: 0&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 1 Leader: 1 Replicas: 1 Isr: 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 2 Leader: 2 Replicas: 2 Isr: 2&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 3 Leader: 0 Replicas: 0 Isr: 0&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4Topic: nginx Partition: 4 Leader: 1 Replicas: 1 Isr: 1&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;4&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;开启consumer消费者nginx，看看是否有日志过来：&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic nginx --group hahaha&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;注意1：&lt;&#x2F;p&gt; &lt;p&gt;useragent，需要指定target，如果不指定默认是agent，跟现有的会冲突。&lt;&#x2F;p&gt; &lt;p&gt;target =&gt; “ua”&lt;&#x2F;p&gt; &lt;p&gt;注意2：&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;filebeat-refresh-fields.png alt=&gt;&lt;&#x2F;p&gt; &lt;p&gt;刷新字段列表，如上图，然后再次测试，再不行，可能需要删掉索引，或者等到明天生成新的索引。&lt;&#x2F;p&gt; &lt;p&gt;t代表string，#代表number&lt;&#x2F;p&gt; &lt;p&gt;注意3：&lt;&#x2F;p&gt; &lt;p&gt;不要用[@metadata][type]，会出现如下情况：所以在output的时候会失败。&lt;&#x2F;p&gt; &lt;figure class=highlight&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;@metadata =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; version =&gt; 7.4.1,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; kafka =&gt; &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; offset =&gt; 1705864,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; timestamp =&gt; 1576243966000,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; partition =&gt; 4,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; key =&gt; nil,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; consumer_group =&gt; logstash,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic =&gt; filebeat&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; topic =&gt; filebeat,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; beat =&gt; filebeat,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; type =&gt; [ # 多个类型了&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; [&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=number&gt;0&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ] _doc,&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; [&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &lt;span class=number&gt;1&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ] &lt;span class=string&gt;nginx_clone&lt;&#x2F;span&gt;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; ]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;在kibana中查看&lt;code&gt;filebeat-kafka-*&lt;&#x2F;code&gt;，搜索：&lt;code&gt;kubernetes.labels.app:&quot;nginx-ingress&quot;&lt;&#x2F;code&gt; 字段如下：&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes&#x2F;nginx-fields.png alt=&gt;&lt;&#x2F;p&gt; &lt;p&gt;开启consumer消费者nginx，看看是否有日志过来：&lt;&#x2F;p&gt; &lt;figure class=highlight bash&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;$ .&#x2F;kafka01&#x2F;bin&#x2F;kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic nginx --group hahaha&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;我们发现和nginx access的处理后的日志是一样的，存在了nginx 这个topic中，方便其他流处理工具实时计算。当然，其他的业务系统的日志也可以采取类似的操作。&lt;&#x2F;p&gt; &lt;h2 id=动态输入到ES-index中&gt;&lt;a href=#动态输入到ES-index中 class=headerlink title=动态输入到ES index中&gt;&lt;&#x2F;a&gt;动态输入到ES index中&lt;&#x2F;h2&gt;&lt;p&gt;如果我想每个服务都输出到单独的ES index中，但我有不想通过if else进行判断，如何操作呢？&lt;&#x2F;p&gt; &lt;p&gt;logstash配置：&lt;&#x2F;p&gt; &lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;output &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; elasticsearch &amp;#123;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts =&gt; [&quot;http:&#x2F;&#x2F;es01:9200&quot;,&quot;http:&#x2F;&#x2F;es02:9201&quot;,&quot;http:&#x2F;&#x2F;es03:9202&quot;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index =&gt; &quot;%&amp;#123;[kubernetes][labels][env]&amp;#125;_%&amp;#123;[kubernetes][labels][app]&amp;#125;-%&amp;#123;+YYYY.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; user =&gt; &quot;admin&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password =&gt; &quot;admin123&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; &amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt;&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;p&gt;如上，会分别获取kubernetes.labels.env和kubernetes.labels.app字段的名称，然后动态的拼接。例如kubernetes.labels.env=pre，kubernetes.labels.app=nginx-ingress，那么最后的index就是：pre_nginx-ingress-2019.12.17类似这样的。&lt;&#x2F;p&gt; &lt;p&gt;当然，你需要在你的pod上有对应的label才可以。&lt;&#x2F;p&gt; &lt;p&gt;如果你是用filebeat直接输出到elasticsearch中，也想使用这种动态的index配置呢？&lt;&#x2F;p&gt; &lt;p&gt;filebeat配置：&lt;&#x2F;p&gt; &lt;figure class=highlight plain&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=code&gt;&lt;pre&gt;&lt;span class=line&gt;output.elasticsearch:&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; hosts: [&amp;apos;$&amp;#123;ELASTICSEARCH_HOST:elasticsearch&amp;#125;:$&amp;#123;ELASTICSEARCH_PORT:9200&amp;#125;&amp;apos;]&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; index: &quot;%&amp;#123;kubernetes.labels.env&amp;#125;_%&amp;#123;kubernetes.labels.app&amp;#125;-%&amp;#123;+yyyy.MM.dd&amp;#125;&quot;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; username: $&amp;#123;ELASTICSEARCH_USERNAME&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;span class=line&gt; password: $&amp;#123;ELASTICSEARCH_PASSWORD&amp;#125;&lt;&#x2F;span&gt;&lt;br&gt;&lt;&#x2F;pre&gt;&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;table&gt;&lt;&#x2F;figure&gt; &lt;hr&gt; &lt;blockquote&gt; &lt;p&gt;本文到这里就结束了，欢迎期待后面的文章。您可以关注下方的公众号二维码，在第一时间查看新文章。&lt;&#x2F;p&gt; &lt;p&gt;&lt;img src=https:&#x2F;&#x2F;imgs.knner.wang&#x2F;images&#x2F;knner&#x2F;wx.jpg alt=公众号&gt;&lt;&#x2F;p&gt; &lt;&#x2F;blockquote&gt;</a></li></ul>
    </div>

    
    
    
      
        <div class="reward-container">
  <div>如有疏忽错误欢迎在留言区评论指正，如果对您有所帮助欢迎点击下方进行打赏。</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/knner/wechatpay.jpg" alt="Knner.Wang 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/knner/alipay.jpg" alt="Knner.Wang 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Knner.Wang
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://knner.wang/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html" title="使用filebeat + kafka + logstash收集处理kubernetes日志，配置收集处理nginx-ingress json日志">https://knner.wang/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/null" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/filebeat/" rel="tag"># filebeat</a>
              <a href="/tags/logstash/" rel="tag"># logstash</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/12/05/install-and-config-zookeeper-and-kafka-cluster.html" rel="next" title="安装配置Zookeeper和Kafka集群">
                  <i class="fa fa-chevron-left"></i> 安装配置Zookeeper和Kafka集群
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2019/12/27/ServiceMesh-Istio-Series--microservice-kubernetes-istio-relation.html" rel="prev" title="[服务网格Istio系列]--微服务 Kubernetes Istio关系">
                  [服务网格Istio系列]--微服务 Kubernetes Istio关系 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments" id="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Filebeat"><span class="nav-number">1.</span> <span class="nav-text">Filebeat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方案一：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中"><span class="nav-number">1.1.</span> <span class="nav-text">方案一： Filebeat收集K8S pod日志，直接发送到Elasticsearch中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案二：-Filebeat收集K8S-pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能"><span class="nav-number">1.2.</span> <span class="nav-text">方案二： Filebeat收集K8S pod日志，直接发送到Elasticsearch中，通过filebeat的自动发现功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案三：-通过Filebeat自动发现功能收集K8S-pod日志，直接发送到Elasticsearch的不同index中"><span class="nav-number">1.3.</span> <span class="nav-text">方案三： 通过Filebeat自动发现功能收集K8S pod日志，直接发送到Elasticsearch的不同index中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方案四：-Filebeat收集K8S-pod日志，通过自动发现功能，发送到Kafka集群中"><span class="nav-number">1.4.</span> <span class="nav-text">方案四： Filebeat收集K8S pod日志，通过自动发现功能，发送到Kafka集群中</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Logstash"><span class="nav-number">2.</span> <span class="nav-text">Logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.1.</span> <span class="nav-text">安装</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#目录结构："><span class="nav-number">2.1.1.</span> <span class="nav-text">目录结构：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">2.2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#值类型"><span class="nav-number">2.2.1.</span> <span class="nav-text">值类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在Logstash使用Events和fields中的数据"><span class="nav-number">2.2.2.</span> <span class="nav-text">在Logstash使用Events和fields中的数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#引用field字段"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">引用field字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#printf-format"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">printf format</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#条件语句"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">条件语句</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#metadata-字段"><span class="nav-number">2.2.2.4.</span> <span class="nav-text">@metadata 字段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在Kubernetes环境中运行Logstash"><span class="nav-number">2.4.</span> <span class="nav-text">在Kubernetes环境中运行Logstash</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中"><span class="nav-number">3.</span> <span class="nav-text">示例：收集nginx-ingress-controller容器json日志，并将处理后的日志clone一份存储到kafka中</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#前提依赖，安装nginx-ingress-controller"><span class="nav-number">3.1.</span> <span class="nav-text">前提依赖，安装nginx-ingress-controller</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="Knner.Wang"
    src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Knner.Wang</p>
  <div class="site-description" itemprop="description">Knner.Wang's Blog,for sharing IT technology and also my study notes.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">25</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wanghkkk" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://hub.docker.com/u/wanghkkk" title="DockerHub &amp;rarr; https:&#x2F;&#x2F;hub.docker.com&#x2F;u&#x2F;wanghkkk" rel="noopener" target="_blank"><i class="fa fa-fw fa-docker"></i>DockerHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wanghk@live.cn" title="E-Mail &amp;rarr; mailto:wanghk@live.cn" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备19058691号-1 </a>
      <img src="/images/knner/ga-icon.png" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=11010802030660" rel="noopener" target="_blank">11010802030660 </a>
  </div>

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Knner.Wang 版权所有</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
    和<a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank" rel="noopener"><img width="60" style="display: inline;" src="/images/logos/upyun_logo5.png"></a>提供CDN加速/云存储服务
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.5.0
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>



  











<script>
if (document.querySelectorAll('div.pdf').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/pdfobject@2/pdfobject.min.js', () => {
    document.querySelectorAll('div.pdf').forEach(element => {
      PDFObject.embed(element.getAttribute('target'), element, {
        pdfOpenParams: {
          navpanes: 0,
          toolbar: 0,
          statusbar: 0,
          pagemode: 'thumbs',
          view: 'FitH'
        },
        PDFJS_URL: '/lib/pdf/web/viewer.html',
        height: element.getAttribute('height') || '500px'
      });
    });
  }, window.PDFObject);
}
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme: 'forest',
      logLevel: 3,
      flowchart: { curve: 'linear' },
      gantt: { axisFormat: '%m/%d/%Y' },
      sequence: { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>



  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://knner.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  function loadComments() {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: {page: {
            url: "https://knner.wang/2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html",
            identifier: "2019/12/15/adding-filebeat-and-logstash-to-collect-and-processing-logs-in-kubernetes.html",
            title: "使用filebeat + kafka + logstash收集处理kubernetes日志，配置收集处理nginx-ingress json日志"
          }
        }
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://knner.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  }
    (function() {
      var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        window.addEventListener('load', loadComments, false);
      } else {
        var disqus_scroll = () => {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = document.getElementById('comments').offsetTop - window.innerHeight;
          var scrollTop = window.scrollY;

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            window.removeEventListener('scroll', disqus_scroll);
            loadComments();
          }
        };
        window.addEventListener('scroll', disqus_scroll);
      }
    })();
  
</script>

</body>
</html>
